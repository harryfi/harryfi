@using MasterOnline.ViewModels

@{
    ViewBag.Title = "Laba/Rugi";
    Layout = "~/Views/Shared/_LayoutReport.cshtml";
    var context = new MoDbContext();
    var dataSession = Session["SessionInfo"] as AccountUserViewModel;

    var userId = "";
    if (dataSession?.User != null)
    {
        var accId = context.User.Single(u => u.Username == dataSession.User.Username).AccountId;
        userId = context.Account.Single(a => a.AccountId == accId).DatabasePathErasoft;
        context.Dispose();
    }
    else
    {
        userId = dataSession?.Account?.DatabasePathErasoft;
    }
}

@section styles
{
    <link href="~/Content/build/css/bootstrap-datepicker.min.css" rel="stylesheet" />
}

    <h2>Laporan Laba/Rugi</h2>

    <div class="row">
        <div class="col-md-2">
            @Html.Label("", "Kode Laporan")
            <div class="input-group text">
                @Html.TextBox("KdLap", "", new { @class = "form-control", @MaxLength = "10" })
                <span class="input-group-btn">
                    <button id="prompt-kdlap" class="btn btn-default" type="button" style="height: 34px;">
                        <span class="glyphicon glyphicon-option-horizontal"></span>
                    </button>
                </span>
            </div>
        </div>
        <div class="col-md-2">
            @Html.Label("", "Keterangan")
            <div class="input-group text">
                @Html.TextBox("Ket", "", new { @class = "form-control", @MaxLength = "20", disabled = "disabled" })
            </div>
        </div>
        <div class="col-md-8">
        </div>
    </div>
<div class="row">
    <div class="col-md-1">
        @Html.Label("", "Tahun")
        <div class="input-group number">
            @Html.TextBox("Tahun", null, new { @class = "form-control", @MaxLength = "4" })
        </div>
    </div>
    <div class="col-md-11">
    </div>
</div>
<div class="row">
    <div class="col-md-2">
        @Html.Label("", "Untuk Bulan")
        <div class="input-group number">
            @Html.TextBox("Bulan", null, new { @class = "form-control", @ReadOnly = true })
        </div>
    </div>
    <div class="col-md-10">
    </div>
</div>
@*<div class="row">
    <div class="col-md-2">
        @Html.Label("", "Cetak Kosong")
        <div class="input-group text">
            <select class="form-control" id="Print" name="Print" required="required">
                <option></option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
            </select>
        </div>
    </div>
    <div class="col-md-10">
    </div>
</div>*@
<br />
<div class="row">
    <div class="col-md-12">
        <button type="button" class="btn btn-primary" id="preview-report">Preview Report</button>
    </div>
</div>
<br />
<br />
<div class="row text-center">
    <object id="pdf_viewer" data="#" type="application/pdf" width="1079" height="600"></object>
</div>

@section scripts
{
    <script src="~/Content/build/js/bootstrap-datepicker.min.js" type="text/javascript"></script>

    <script>
        var promptKdLap = "";
        $(document).ready(function () {
            var d = new Date();

            $('#Tahun').val(d.getFullYear());

            //change by nurul 6/11/2018
            //$('#Bulan').datepicker({
            //    format: 'MM',
            //    language: 'id',
            //    minViewMode: 1
            //}).datepicker('setDate', d);
            $('#Bulan').datepicker({
                format: 'MM',
                language: 'id',
                //change by nurul 10/12/2018 (menghilangkan tahun)
                //minViewMode: 1
                minViewMode: 'months',
                maxViewMode: 'months',
                startView: 'months'
                //end change
            }).datepicker('setDate', d).change(function () {
                $('#Bulan').val($(this).val());
                $(this).datepicker('hide');
            });
            //end change 

            $('#prompt-kdlap').click(function () {
                promptKdLap = "1";
                var $link = '@Url.Action("PromptKodeLR", "Report")';
                window.open($link, "popupWindow", "width=600, height=400, scrollbars=yes");
            });

            $('#preview-report').click(function() {
                previewing();
            });

            //add by nurul 6/12/2018
            $('#KdLap').val("01");
            if ($('#KdLap').val() == "01" || $('#KdLap').val() == "02") {
                $('#Ket').val("Laba / Rugi");
            } else {
                $('#Ket').val("");
            }
            $('#KdLap').change(function () {
                if ($('#KdLap').val() == "01" || $('#KdLap').val() == "02") {
                    $('#Ket').val("Laba / Rugi");
                } else {
                    $('#Ket').val("");
                }
            });
            $('#KdLap').blur(function () {
                if ($('#KdLap').val() == "01" || $('#KdLap').val() == "02") {
                    $('#Ket').val("Laba / Rugi");
                } else {
                    $('#Ket').val("");
                }
            });
            //end add
        });

        function FormatMonth() {
            var d;

                d = new Date($('#Bulan').val() + ' ' + 2018 );
                return d.getMonth() + 1;



        }
        function previewing() {
            //if (selisihValid()) {
                $.ajax({
                    type: "POST",
                    url: '@Url.Action("Preview10", "Report")',
                    data: JSON.stringify({
                        UserId: '@(userId)',
                        KdLap: $('#KdLap').val(),
                        Tahun: $('#Tahun').val(),
                        Bulan: FormatMonth()
                        //Print: $('#Print').val()
                    }),
                    contentType: 'application/json; charset=UTF-8',
                    cache: false,
                    success: function (data) {
                        //console.log(data);
                        $("<iframe id='LoadReportMO'>")// create a new iframe element
                            .hide()//invisible
                            .load(function () {
                                setTimeout(function () { $("#LoadReportMO").remove(); }, 30000);
                            })
                            .attr("src", data)//load the page
                            .appendTo("body");

                    },
                    error: function (xhr) {
                        console.log(xhr);
                    }
                });
            //}
        }
        function afterPromptKodeLR(kode) {
            if (promptKdLap == "1") {
                $('#KdLap').val(kode);
                $('#Ket').val("Laba / Rugi");
            }
            promptKdLap = "";
        }
    </script>
}