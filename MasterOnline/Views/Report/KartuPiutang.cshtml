@using MasterOnline.ViewModels

@{
    ViewBag.Title = "Kartu Piutang";
    Layout = "~/Views/Shared/_LayoutReport.cshtml";
    var context = new MoDbContext("");
    var dataSession = Session["SessionInfo"] as AccountUserViewModel;

    var userId = "";
    if (dataSession?.User != null)
    {
        var accId = context.User.Single(u => u.Email == dataSession.User.Email).AccountId;
        userId = context.Account.Single(a => a.AccountId == accId).DatabasePathErasoft;
        context.Dispose();
    }
    else
    {
        userId = dataSession?.Account?.DatabasePathErasoft;
    }
}

@section styles
{
    <link href="~/Content/build/css/bootstrap-datepicker.min.css" rel="stylesheet" />
    <style>
        #loading_spinner {
            display: none;
            width: 100%;
            height: 100%;
            position: fixed;
            z-index: 100;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background-color: rgba(0,0,0,.5);
        }

        #loading_spinner_image {
            width: 20px;
            height: 20px;
            margin-top: -90px;
            margin-left: -90px;
            position: absolute;
            top: 50%;
            left: 50%;
            border-width: 30px;
            border-radius: 50%;
        }
    </style>
}

<h2>Kartu Piutang</h2>

<div class="row">
    <div class="col-md-2">
        @Html.Label("", "Dari Customer")
        <div class="input-group text">
            @Html.TextBox("FromCust", "", new { @class = "form-control", @MaxLength = "10" })
            <span class="input-group-btn">
                <button id="prompt-daricustomer" class="btn btn-default" type="button" style="height: 34px;">
                    <span class="glyphicon glyphicon-option-horizontal"></span>
                </button>
            </span>
        </div>
    </div>
    <div class="col-md-2">
        @Html.Label("", "Sampai Customer")
        <div class="input-group text">
            @Html.TextBox("ToCust", "ZZZ", new { @class = "form-control", @MaxLength = "10" })
            <span class="input-group-btn">
                <button id="prompt-sdcustomer" class="btn btn-default" type="button" style="height: 34px;">
                    <span class="glyphicon glyphicon-option-horizontal"></span>
                </button>
            </span>
        </div>
    </div>
    <div class="col-md-8">

    </div>
</div>
<div class="row">
    <div class="col-md-1">
        @Html.Label("", "Tahun")
        <div class="input-group number">
            @Html.TextBox("Tahun", null, new { @class = "form-control", @MaxLength = "4" })
        </div>
    </div>
    <div class="col-md-11">
    </div>
</div>
<div class="row">
    <div class="col-md-2">
        @Html.Label("", "Dari Tanggal")
        <div class="input-group number">
            @Html.TextBox("DrBulan", null, new { @class = "form-control", @ReadOnly = true })
        </div>
    </div>
    <div class="col-md-2">
        @Html.Label("", "S/d Tanggal")
        <div class="input-group date">
            @Html.TextBox("SdBulan", null, new { @class = "form-control", @ReadOnly = true })
        </div>
    </div>
    <div class="col-md-8">
        <div class="hidden">
            @Html.TextBox("DateHidden", null, new { @class = "form-control", @ReadOnly = true })
        </div>
    </div>
</div>
<br />
<div class="row">
    <div class="col-md-12">
        <button type="button" class="btn btn-primary" id="preview-report">Preview Report</button>
    </div>
</div>
<br />
<br />
@*<div class="row text-center">
        <object id="pdf_viewer" data="#" type="application/pdf" width="1079" height="600"></object>
    </div>*@

@section scripts
{
    <script src="~/Content/build/js/bootstrap-datepicker.min.js" type="text/javascript"></script>

    <script>
        var promptCust = "";
        $(document).ready(function () {
            var d = new Date();

            //change by nurul 6/11/2018
            //$('#DateHidden').datepicker({
            //    format: 'yyyy/mm/dd',
            //    language: 'id'
            //}).datepicker('setDate', '0');

            //$('#DrBulan').datepicker({
            //    format: '01 MM',
            //    language: 'id',
            //    minViewMode: 1
            //}).datepicker('setDate', d);

            //$('#SdBulan').datepicker({
            //    format: 'dd MM',
            //    language: 'id'
            //}).datepicker('setDate', '0');
            $('#DateHidden').datepicker({
                format: 'yyyy/mm/dd',
                language: 'id'
            }).datepicker('setDate', '0').change(function () {
                $('#DateHidden').val($(this).val());
                $(this).datepicker('hide');
            });

            $('#DrBulan').datepicker({
                format: '01 MM',
                language: 'id',
                //change by nurul 10/12/2018 (menghilangkan tahun)
                //minViewMode: 1
                minViewMode: 'months',
                maxViewMode: 'months',
                startView: 'months'
                //end change
            }).datepicker('setDate', d).change(function () {
                $('#DrBulan').val($(this).val());
                $(this).datepicker('hide');
            });

            //$('#SdBulan').datepicker({
            //    format: 'dd MM',
            //    language: 'id'
            //}).datepicker('setDate', '0').change(function () {
            //    $('#SdBulan').val($(this).val());
            //    $(this).datepicker('hide');
            //});
            $('#SdBulan').datepicker({
                format: 'dd MM',
            }).datepicker('setDate', '0').off('show').on('show', function () {
                // remove the year from the date title before the datepicker show
                var dateText = $(".datepicker-days .datepicker-switch").text().split(" ");
                var dateTitle = dateText[0];
                $(".datepicker-days .datepicker-switch").text(dateTitle);
                $(".datepicker-months .datepicker-switch").css({ "visibility": "hidden" });
                });
            $('#SdBulan').change(function () {
                $('#SdBulan').val($(this).val());
                $(this).datepicker('hide');
            });
            //end change

            $('#Tahun').val(d.getFullYear());

            $('#prompt-daricustomer').click(function () {
                promptCust = "1";
                var $link = '@Url.Action("PromptCustomer", "Report")';
                window.open($link, "popupWindow", "width=600, height=400, scrollbars=yes");
            });
            $('#prompt-sdcustomer').click(function () {
                promptCust = "2";
                var $link = '@Url.Action("PromptCustomer", "Report")';
                window.open($link, "popupWindow", "width=600, height=400, scrollbars=yes");
            });

            $('#preview-report').click(function () {
                $('#loading_spinner').show();
                previewing();
            });
        });

        function formatDateToYYYYmmDD(a) {
            var d;
            if (a == 1) {
                d = new Date($('#DrBulan').val() + ' ' + $('#Tahun').val());
                return d.getMonth() + 1;
            }
            else if (a == 2) {
                d = new Date($('#SdBulan').val() + ' ' + $('#Tahun').val());
                $('#DateHidden').datepicker({
                    format: 'yyyy/mm/dd',
                    language: 'id'
                }).datepicker('setDate', d);
            }

            return $('#DateHidden').val();
        }
        var tanggalcutoff = "";
        function previewing() {
            //if (selisihValid()) {
                $.ajax({
                    type: "POST",
                    url: '@Url.Action("Preview3", "Report")',
                    data: JSON.stringify({
                        UserId: '@(userId)',
                        FromCust: $('#FromCust').val(),
                        ToCust: $('#ToCust').val(),
                        FromMonth: formatDateToYYYYmmDD(1),
                        CutOffDate: formatDateToYYYYmmDD(2)
                    }),
                    contentType: 'application/json; charset=UTF-8',
                    cache: false,
                    success: function (data) {
                        //alert(data);
                        $("<iframe id='LoadReportMO'>")// create a new iframe element
                            .hide()//invisible
                            .load(function () {
                                $('#loading_spinner').hide();
                                setTimeout(function () { $("#LoadReportMO").remove(); }, 30000);
                            })
                            .attr("src", data)//load the page
                            .appendTo("body");
                    },
                    error: function (xhr) {
                        console.log(xhr);
                        $('#loading_spinner').hide();
                    }
                });
            //}
        }

        function afterPromptCustomer(cust) {
            if (promptCust == "1") {
                $('#FromCust').val(cust);
            }
            else if (promptCust == "2") {
                $('#ToCust').val(cust);
            }
            promptCust = "";
        }

    </script>
}
