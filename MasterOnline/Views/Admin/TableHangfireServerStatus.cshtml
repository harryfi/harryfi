@using System.Globalization
@using PagedList.Mvc
@using MasterOnline.ViewModels

@model PagedList.IPagedList<HANGFIRE_SERVER_STATUS>
@{
    string currentFilter = ViewBag.CurrentFilter;
    string currentSort = ViewBag.CurrentSort;
}

<script type="text/javascript">

    function StopHangfireServer(sender) {
        var jobid = $(sender).attr('data-dbpathera');
        var email = $(sender).attr('data-email');
        if (confirm("Apakah Anda yakin untuk menonaktifkan hangfire akun " + email.toString() +"? \n\nLanjutkan ?")) {
            var link = '@Url.Action("AdminStopHangfireServer", "Admin", new { nourut = "replaceNoUrut" })';
            link = link.replace("replaceNoUrut", jobid);

            $.ajax({
                type: "POST",
                url: link,
                contentType: 'application/json',
                cache: false,
                beforeSend: function () {
                    $('#loading_barang_tab').show();
                },
                success: function (response) {
                    alert(response.status.toString());
                    refreshTableLog();
                },
                error: function (response) {
                    alert(response.status.toString());
                    retryid.attr("disabled", false);
                }
            });
        }
    }

    function StartHangfireServer(sender) {
        var timerMinute = prompt("Recurring Job Interval ?", "30");
        if (timerMinute != null && timerMinute != "") {
            var sourcepath = $(sender).attr('data-dbsourceera');
            var jobid = $(sender).attr('data-dbpathera');

            var $link = '@Url.Action("AdminStartHangfireServer", "Admin")';

            $postdata = {
                dbsource : sourcepath,
                nourut : jobid,
                timer : timerMinute
            };
            
            $.ajax({
                type: "POST",
                url: $link,
                contentType: "application/json; charset=UTF-8",
                cache: false,
                data: JSON.stringify($postdata),
                beforeSend: function () {
                    $('#loading_barang_tab').show();
                },
                success: function (response) {
                    alert(response.status.toString());
                    refreshTableLog();
                },
                error: function (response) {
                    alert(response.status.toString());
                }
            });
        }
    }

</script>
<div id="loading_barang_tab" style="display: none;width: 100%;height: 100%;position: absolute;z-index: 100;top: 0;right: 0;bottom: 0;left: 0;background-color: rgba(0,0,0,0);">
    <div id="loading_barang_tab_image">
        <img src="~/Content/Images/spinner.gif" />
    </div>
</div>
<input id="txt_last_page" type="hidden" class="form-control" value="@ViewData["LastPage"]">
<table id="table-hangfire-server-status" class="table table-striped table-bordered table-hover">
    <thead>
        <tr role="row">
            <th class="sorting text-center" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" style="width: 90px;">Username</th>
            <th class="sorting text-center" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" style="width: 120px;">Shop Name</th>
            <th class="sorting text-center" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" style="width: 90px;">Email</th>
            <th class="sorting text-center" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" style="width: 120px;">Last Login Date</th>
            <th class="sorting text-center" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" style="width: 185px;">Subscription End Date</th>
            <th class="sorting text-center" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" style="width: 90px;">Stok</th>
            <th class="sorting text-center" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" style="width: 90px;">Pesanan</th>
            <th class="sorting text-center" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" style="width: 90px;">Product</th>
            <th class="sorting text-center" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" style="width: 120px;">Heartbeat</th>
            <th class="sorting text-center" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" style="width: 120px;">IP Server DB</th>
            <th class="sorting text-center" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" style="width: 45px;">Action</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var aktivitas in Model)
        {
        <tr>
            <td style="text-align:center">@aktivitas.Username</td>
            <td style="text-align:center">@aktivitas.NamaTokoOnline</td>
            <td style="text-align:center">@aktivitas.Email</td>
            <td style="text-align:center">@aktivitas.LAST_LOGIN_DATE</td>
            <td style="text-align:center">@aktivitas.TGL_SUBSCRIPTION</td>
            <td style="text-align:center">@aktivitas.StokJobEnqueued</td>
            <td style="text-align:center">@aktivitas.PesananJobEnqueued</td>
            <td style="text-align:center">@aktivitas.CreateProductJobEnqueued</td>
            <td style="text-align:center">@aktivitas.LAST_HEARTBEAT</td>
            <td style="text-align:center">@aktivitas.DatabaseSourceErasoft</td>
            <td style="text-align:center">
                @if (aktivitas.HangfireServerCount > 0)
                {
                    <button class="btn btn-danger" data-email="@aktivitas.Email" data-dbsourceera="@aktivitas.DatabaseSourceErasoft" data-dbpathera="@aktivitas.DatabasePathErasoft" type="button" style="border:1px;padding:2px 8px 2px 8px;margin:0px" title="Stop Recurring Jobs"
                            onclick="StopHangfireServer(this)">
                        <span>Shutdown</span>
                    </button>
                }
                else
                {
                    <button class="btn btn-primary" data-email="@aktivitas.Email" data-dbsourceera="@aktivitas.DatabaseSourceErasoft" data-dbpathera="@aktivitas.DatabasePathErasoft" type="button" style="border:1px;padding:2px 8px 2px 8px;margin:0px" title="Start Recurring Jobs"
                            onclick="StartHangfireServer(this)">
                        <span>Activate</span>
                    </button>
                }
            </td>
        </tr>
        }
    </tbody>
</table>
@* add by calvin 22 april 2019, paging *@
@if (Model.PageCount > 1)
{
    <div id="tabelbarang1partialpager" class="pager">
        @Html.PagedListPager(Model, page => Url.Action("RefreshHangfireServerStatus", new
   {
       page,
       search = ViewData["searchParam"]
   }),
        new PagedListRenderOptions
        {
            LinkToFirstPageFormat = "<<",
            LinkToPreviousPageFormat = "prev",
            LinkToNextPageFormat = "next",
            LinkToLastPageFormat = ">>",
            DisplayEllipsesWhenNotShowingAllPageNumbers = false
        })
        Page @(Model.PageCount < Model.PageNumber ? 0 : Model.PageNumber) of @Model.PageCount
    </div>
}
<script type="text/javascript">
    $(function () {
        $('#tabelbarang1partialpager').on('click', 'a', function () {
            if (this.href != "") {
                $.ajax({
                    url: this.href,
                    type: 'GET',
                    cache: false,
                    beforeSend: function () {
                        $('#loading_barang_tab').show();
                    },
                    success: function (response) {
                        $('#table-market-log-partial-div').html(response);
                        $('#loading_barang_tab').hide();
                    }
                });
                return false;
            }
        });
    });
</script>
@* end add by calvin 22 april 2019, paging *@


