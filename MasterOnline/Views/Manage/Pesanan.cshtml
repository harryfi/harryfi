@using System.Globalization
@using MasterOnline.ViewModels
@model PesananViewModel
@{
    ViewBag.Title = "Pesanan";
    Layout = "~/Views/Shared/_LayoutManage.cshtml";

    ErasoftContext erasoftContext = null;
    var context = new MoDbContext();

    var dataSession = Session["SessionInfo"] as AccountUserViewModel;

    var username = "";
    if (dataSession?.User != null)
    {
        var accId = context.User.Single(u => u.Username == dataSession.User.Username).AccountId;
        username = context.Account.Single(a => a.AccountId == accId).Username;
        context.Dispose();
    }
    else
    {
        username = dataSession?.Account?.Username;
    }
}
@section styles
{
    <link href="~/Content/build/css/bootstrap-datepicker.min.css" rel="stylesheet" />
    <link href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" rel="stylesheet" />
    <link href="~/Content/build/css/selectivity-jquery.min.css" rel="stylesheet" />
    <link href="~/Content/selectize.css" rel="stylesheet" />
    <style>
        .input-group {
            margin-bottom: 0;
        }

        .btn-success[disabled]:hover {
            background: #6ad6bf;
            border-color: #6ad6bf;
        }

        table#table_tambah_pesanan thead tr {
            background-color: #c7f1f5;
        }

        .qty-input {
            width: 50px;
        }

        .disc-input {
            width: 50px;
        }

        .ndisc-input {
            width: 100px;
        }

        #BRG {
            width: 150px !important;
        }

        #scrollable_div {
            overflow-x: hidden;
            overflow-y: scroll;
            height: 400px;
        }

        #konfHapusPesanan .modal-body,
        #konfBatalPesanan .modal-body,
        #konfUbahStatus .modal-body {
            padding: 0 50px 20px 50px;
        }

        /*add by nurul 8/10/2018*/
        #konfUbahStatusDibayar .modal-body {
            padding: 0 50px 20px 50px;
        }
        #konfUbahStatusSiapkirim .modal-body {
            padding: 0 50px 20px 50px;
        }
        #konfUbahStatusSudahkirim .modal-body {
            padding: 0 50px 20px 50px;
        }
        #konfUndoStatusSiapkirim .modal-body {
            padding: 0 50px 20px 50px;
        }

        #konfUndoStatusSudahkirim .modal-body {
            padding: 0 50px 20px 50px;
        }
        #konfUndoStatusSelesai .modal-body {
            padding: 0 50px 20px 50px;
        }

        #konfUndoStatusBatal .modal-body {
            padding: 0 50px 20px 50px;
        }
        /*end add*/ 

        .info_pesanan {
            padding: 20px;
            border: solid 2px #ddd;
        }

            .info_pesanan p {
                font-size: 16px;
            }

            .info_pesanan .block_subtitle {
                display: inline-block;
                width: 120px;
                font-weight: bold;
            }
    </style>
    <style>
        #modal-pricing,
        #modal-pricing-expired {
            margin: auto;
            width: 60em;
        }

            #modal-pricing .modal-content,
            #modal-pricing-expired .modal-content {
                -webkit-box-shadow: none;
                box-shadow: none;
                border: none;
                background-color: transparent;
            }

        .snip1404 {
            font-family: 'Source Sans Pro', Arial, sans-serif;
            color: #ffffff;
            text-align: left;
            font-size: 16px;
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            margin-top: 13%;
            display: table;
        }

            .snip1404 img {
                position: absolute;
                left: 0;
                top: 0;
                height: 100%;
                z-index: -1;
            }

            .snip1404 .plan {
                margin: 0;
                width: 33.333333%;
                position: relative;
                float: left;
                overflow: hidden;
                border: 3px solid #442232;
                box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
                background-color: #c13232;
            }

                .snip1404 .plan:hover i,
                .snip1404 .plan.hover i {
                    -webkit-transform: scale(1.2);
                    transform: scale(1.2);
                }

                .snip1404 .plan:first-of-type {
                    border-radius: 8px 0 0 8px;
                }

                .snip1404 .plan:last-of-type {
                    border-radius: 0 8px 8px 0;
                }

            .snip1404 * {
                -webkit-box-sizing: border-box;
                box-sizing: border-box;
                -webkit-transition: all 0.25s ease-out;
                transition: all 0.25s ease-out;
            }

            .snip1404 header {
                background-color: #c13232;
                color: #ffffff;
            }

            .snip1404 .plan-title {
                background-color: rgba(0, 0, 0, 0.5);
                position: relative;
                margin: 0;
                padding: 20px 20px 0;
                text-transform: uppercase;
                letter-spacing: 4px;
            }

                .snip1404 .plan-title:after {
                    position: absolute;
                    content: '';
                    top: 100%;
                    left: 0;
                    width: 0;
                    height: 0;
                    border-style: solid;
                    border-width: 40px 300px 0 0;
                    border-color: rgba(0, 0, 0, 0.5) transparent transparent;
                }

            .snip1404 .plan-cost {
                padding: 40px 20px 10px;
                text-align: right;
            }

            .snip1404 .plan-price {
                font-weight: 600;
                font-size: 1.5em;
            }

            .snip1404 .plan-type {
                opacity: 0.8;
                font-size: 0.7em;
                text-transform: uppercase;
            }

            .snip1404 .plan-features {
                padding: 0 0 20px;
                margin: 0;
                list-style: outside none none;
            }

                .snip1404 .plan-features li {
                    padding: 8px 5%;
                }

                .snip1404 .plan-features i {
                    margin-right: 8px;
                    color: rgba(0, 0, 0, 0.5);
                }

            .snip1404 .plan-select {
                border-top: 1px solid rgba(0, 0, 0, 0.2);
                padding: 20px;
                text-align: center;
            }

                .snip1404 .plan-select a {
                    background-color: #442232;
                    color: #ffffff;
                    text-decoration: none;
                    padding: 12px 20px;
                    font-size: 0.75em;
                    font-weight: 600;
                    border-radius: 20px;
                    text-transform: uppercase;
                    letter-spacing: 4px;
                    display: inline-block;
                }

                    .snip1404 .plan-select a:hover {
                        background-color: #552a3f;
                    }

            .snip1404 .featured {
                margin-top: -10px;
                border-color: #331926;
                box-shadow: 0 0 25px rgba(0, 0, 0, 0.4);
                z-index: 1;
                border-radius: 8px;
            }

                .snip1404 .featured .plan-select {
                    padding: 30px 20px;
                }

        @@media only screen and (max-width: 767px) {
            .snip1404 .plan {
                width: 50%;
            }

            .snip1404 .plan-title,
            .snip1404 .plan-select a {
                -webkit-transform: translateY(0);
                transform: translateY(0);
            }

            .snip1404 .plan-select,
            .snip1404 .featured .plan-select {
                padding: 20px;
            }

            .snip1404 .featured {
                margin-top: 0;
            }
        }

        @@media only screen and (max-width: 440px) {
            .snip1404 .plan {
                width: 100%;
            }
        }

        body {
            background-color: #212121;
        }
    </style>
}
<!-- top tiles -->
@*<div class="row top_tiles">
        <div class="animated flipInY col-lg-3 col-md-3 col-sm-6 col-xs-12">
            <div class="tile-stats primary-left-border">
                <div class="count">Rp 0,00</div>
                <h3>Pesanan Bulan Berjalan</h3>
            </div>
        </div>
        <div class="animated flipInY col-lg-3 col-md-3 col-sm-6 col-xs-12">
            <div class="tile-stats warning-left-border">
                <div class="count">Rp 0,00</div>
                <h3>Internal</h3>
            </div>
        </div>
        <div class="animated flipInY col-lg-3 col-md-3 col-sm-6 col-xs-12">
            <div class="tile-stats warning-left-border">
                <div class="count">Rp 0,00</div>
                <h3>Online</h3>
            </div>
        </div>
        <div class="animated flipInY col-lg-3 col-md-3 col-sm-6 col-xs-12">
            <div class="tile-stats danger-left-border">
                <div class="count">Rp 0,00</div>
                <h3>Batal</h3>
            </div>
        </div>
    </div>*@
<!-- /top tiles -->
<div class="row">
    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <div class="" role="tabpanel" data-example-id="togglable-tabs">
            <ul id="myTab" class="nav nav-tabs bar_tabs" role="tablist">
                <li role="presentation" class="active">
                    <a href="#tab_content1" id="pesanan-tab" role="tab" data-toggle="tab" aria-expanded="true">Pesanan</a>
                </li>
                <li role="presentation" class="">
                    <a href="#tab_content2" role="tab" id="nunggu-tab" data-toggle="tab" aria-expanded="false">Sudah Dibayar</a>
                </li>
                <li role="presentation" class="">
                    <a href="#tab_content4" role="tab" id="sedangproses-tab" data-toggle="tab" aria-expanded="false">Siap Dikirim</a>
                </li>
                <li role="presentation" class="">
                    <a href="#tab_content6" role="tab" id="sudahkirim-tab" data-toggle="tab" aria-expanded="false">Sudah Dikirim</a>
                </li>
                <li role="presentation" class="">
                    <a href="#tab_content7" role="tab" id="selesai-tab" data-toggle="tab" aria-expanded="false">Selesai</a>
                </li>
                <li role="presentation" class="">
                    <a href="#tab_content8" role="tab" id="cancel-tab" data-toggle="tab" aria-expanded="false">Batal</a>
                </li>
            </ul>
            <div id="myTabContent" class="tab-content">
                <div role="tabpanel" class="tab-pane fade active in" id="tab_content1" aria-labelledby="pesanan-tab">
                    <div class="row pesanan_table_section">
                        <div class="col-lg-4 col-sm-6">
                            <div class="input-group">
                                <input id="search_pesanan" type="text" class="form-control" placeholder="Pencarian">
                                <span class="input-group-btn">
                                    <button type="button" class="btn btn-primary">
                                        <i class="fa fa-search"></i>
                                    </button>
                                </span>
                            </div>
                        </div>
                        <div class="col-lg-8 col-sm-6">
                            <div class="pull-right" id="tambah_baru_tombol_section">
                                <button type="button" class=" btn btn-default" data-style="expand-right">
                                    <span>Refresh</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row pesanan_table_section" style="margin-top: 5px;">
                        <div id="loading_pesanan_tab" class="text-center">
                            <img src="~/Content/Images/spinner.gif" width="100" />
                        </div>
                        <div class="col-sm-12" id="table-pesanan-partial">
                            @Html.Partial("TablePesananPartial")
                        </div>
                    </div>
                    <div class="row pesanan_editor_section" style="display: none;">
                        <div class="col-lg-12">
                            <div class="page-editor">
                                <h2 class="editor-title">Pesanan</h2>
                                <span class="title-accent"></span>
                                <button id="close-editor-1" type="button" class="pull-right page-close">
                                    <span class="close-btn thick"></span>
                                </button>
                                @if (ViewData.ModelState.Any(x => x.Value.Errors.Any()))
                                {
                                    foreach (var modelError in ViewData.ModelState.SelectMany(x => x.Value.Errors))
                                    {
                                        <div class="alert alert-danger">
                                            <span class="message-error">@modelError.ErrorMessage</span>
                                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                    }
                                }
                                @using (Html.BeginForm("SavePesanan", "Manage", FormMethod.Post, new { enctype = "multipart/form-data", id = "form-pesanan" }))
                                {
                                    <div id="form-partial">
                                        @Html.Partial("BarangPesananPartial")
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
                <div role="tabpanel" class="tab-pane fade" id="tab_content2" aria-labelledby="nunggu-tab">
                    <div class="row pesanan_sudah_dibayar_section">
                        <div class="col-lg-4 col-sm-6">
                            <div class="input-group">
                                <input id="search_nunggu" type="text" class="form-control" placeholder="Pencarian">
                                <span class="input-group-btn">
                                    <button type="button" class="btn btn-primary">
                                        <i class="fa fa-search"></i>
                                    </button>
                                </span>
                            </div>
                        </div>
                        <div class="col-lg-8 col-sm-6">
                            <div class="pull-right">
                                <button type="button" class=" btn btn-default" data-style="expand-right">
                                    <span>Refresh</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row pesanan_sudah_dibayar_section" style="margin-top: 5px;">
                        <div id="loading_sudah_dibayar_tab" class="text-center">
                            <img src="~/Content/Images/spinner.gif" width="100" />
                        </div>
                        <div class="col-sm-12" id="table-pesanan-sudah-dibayar-partial">
                            @Html.Partial("TablePesananSudahDibayarPartial")
                        </div>
                    </div>
                    <div class="row pesanan_editor_sudah_dibayar_section" style="display: none;">
                        <div class="col-lg-12">
                            <div class="page-editor">
                                <h2 class="editor-title">Pesanan</h2>
                                <span class="title-accent"></span>
                                <button id="close-editor-3" type="button" class="pull-right page-close">
                                    <span class="close-btn thick"></span>
                                </button>
                                @if (ViewData.ModelState.Any(x => x.Value.Errors.Any()))
                                {
                                    foreach (var modelError in ViewData.ModelState.SelectMany(x => x.Value.Errors))
                                    {
                                        <div class="alert alert-danger">
                                            <span class="message-error">@modelError.ErrorMessage</span>
                                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                    }
                                }
                                <div id="form-partial-sudah-dibayar">
                                    @Html.Partial("BarangPesananSudahDibayarPartial")
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div role="tabpanel" class="tab-pane fade" id="tab_content4" aria-labelledby="sedangproses-tab">
                    <div class="row">
                        <div class="col-lg-4 col-sm-6">
                            <div class="input-group">
                                <input id="search_sedangproses" type="text" class="form-control" placeholder="Pencarian">
                                <span class="input-group-btn">
                                    <button type="button" class="btn btn-primary">
                                        <i class="fa fa-search"></i>
                                    </button>
                                </span>
                            </div>
                        </div>
                        <div class="col-lg-8 col-sm-6">
                            <div class="pull-right">
                                <button type="button" class=" btn btn-default" data-style="expand-right">
                                    <span>Refresh</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row" style="margin-top: 5px;">
                        <div id="loading_siap_kirim_tab" class="text-center">
                            <img src="~/Content/Images/spinner.gif" width="100" />
                        </div>
                        <div class="col-sm-12" id="table-pesanan-siap-kirim-partial">
                            @Html.Partial("TablePesananSiapKirimPartial")
                        </div>
                    </div>
                </div>
                <div role="tabpanel" class="tab-pane fade" id="tab_content6" aria-labelledby="sudahkirim-tab">
                    <div class="row">
                        <div class="col-lg-4 col-sm-6">
                            <div class="input-group">
                                <input id="search_sudahkirim" type="text" class="form-control" placeholder="Pencarian">
                                <span class="input-group-btn">
                                    <button type="button" class="btn btn-primary">
                                        <i class="fa fa-search"></i>
                                    </button>
                                </span>
                            </div>
                        </div>
                        <div class="col-lg-8 col-sm-6">
                            <div class="pull-right">
                                <button type="button" class=" btn btn-default" data-style="expand-right">
                                    <span>Refresh</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row" style="margin-top: 5px;">
                        <div id="loading_sudah_kirim_tab" class="text-center">
                            <img src="~/Content/Images/spinner.gif" width="100" />
                        </div>
                        <div class="col-sm-12" id="table-pesanan-sudah-kirim-partial">
                            @Html.Partial("TablePesananSudahKirimPartial")
                        </div>
                    </div>
                </div>
                <div role="tabpanel" class="tab-pane fade" id="tab_content7" aria-labelledby="selesai-tab">
                    <div class="row pesanan_selesai_section">
                        <div class="col-lg-4 col-sm-6">
                            <div class="input-group">
                                <input id="search_selesai" type="text" class="form-control" placeholder="Pencarian">
                                <span class="input-group-btn">
                                    <button type="button" class="btn btn-primary">
                                        <i class="fa fa-search"></i>
                                    </button>
                                </span>
                            </div>
                        </div>
                        <div class="col-lg-8 col-sm-6">
                            <div class="pull-right">
                                <button type="button" class=" btn btn-default" data-style="expand-right">
                                    <span>Refresh</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row pesanan_selesai_section" style="margin-top: 5px;">
                        <div id="loading_selesai_tab" class="text-center">
                            <img src="~/Content/Images/spinner.gif" width="100" />
                        </div>
                        <div class="col-sm-12" id="table-pesanan-selesai-partial">
                            @Html.Partial("TablePesananSelesaiPartial")
                        </div>
                    </div>
                    <div class="row pesanan_editor_selesai_section" style="display: none;">
                        <div class="col-lg-12">
                            <div class="page-editor">
                                <h2 class="editor-title">Pesanan</h2>
                                <span class="title-accent"></span>
                                <button id="close-editor-2" type="button" class="pull-right page-close">
                                    <span class="close-btn thick"></span>
                                </button>
                                @if (ViewData.ModelState.Any(x => x.Value.Errors.Any()))
                                {
                                    foreach (var modelError in ViewData.ModelState.SelectMany(x => x.Value.Errors))
                                    {
                                        <div class="alert alert-danger">
                                            <span class="message-error">@modelError.ErrorMessage</span>
                                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                    }
                                }
                                <div id="form-partial-selesai">
                                    @Html.Partial("BarangPesananSelesaiPartial")
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div role="tabpanel" class="tab-pane fade" id="tab_content8" aria-labelledby="cancel-tab">
                    <div class="row">
                        <div class="col-lg-4 col-sm-6">
                            <div class="input-group">
                                <input id="search_cancel" type="text" class="form-control" placeholder="Pencarian">
                                <span class="input-group-btn">
                                    <button type="button" class="btn btn-primary">
                                        <i class="fa fa-search"></i>
                                    </button>
                                </span>
                            </div>
                        </div>
                        <div class="col-lg-8 col-sm-6">
                            <div class="pull-right">
                                <button type="button" class=" btn btn-default" data-style="expand-right">
                                    <span>Refresh</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row" style="margin-top: 5px;">
                        <div id="loading_cancel_tab" class="text-center">
                            <img src="~/Content/Images/spinner.gif" width="100" />
                        </div>
                        <div class="col-sm-12" id="table-pesanan-cancel-partial">
                            @Html.Partial("TablePesananCancelPartial")
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="konfHapusPesanan" tabindex="-1" role="dialog" aria-labelledby="konfirmasiHapusLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="konfirmasiHapusLabel">Konfirmasi</h4>
            </div>
            <div class="modal-body">
                <div class="row text-center">
                    <h4>Apakah Anda yakin ingin menghapus pesanan ini?</h4>
                </div>
                <div class="row info_pesanan">
                    <p>
                        <span class="block_subtitle">No. Pesanan</span>: <span class="no_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Tgl. Pesanan</span>: <span class="tgl_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Marketplace</span>: <span class="market_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Pembeli</span>: <span class="buyer_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Total</span>: Rp <span class="total_pesanan">0,00</span>
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Tidak</button>
                <button type="button" class="btn btn-success" onclick="deletePesanan();">Ya</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="konfBatalPesanan" tabindex="-1" role="dialog" aria-labelledby="konfirmasiBatalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="konfirmasiBatalLabel">Konfirmasi</h4>
            </div>
            <div class="modal-body">
                <div class="row text-center">
                    <h4>Apakah Anda yakin ingin membatalkan pesanan ini?</h4>
                </div>
                <div class="row info_pesanan">
                    <p>
                        <span class="block_subtitle">No. Pesanan</span>: <span class="no_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Tgl. Pesanan</span>: <span class="tgl_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Marketplace</span>: <span class="market_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Pembeli</span>: <span class="buyer_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Total</span>: Rp <span class="total_pesanan">0,00</span>
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Tidak</button>
                <button type="button" class="btn btn-success" onclick="ubahStatusPesanan();">Ya</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="konfHapusBarang" tabindex="-1" role="dialog" aria-labelledby="konfirmasiHapusLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="konfirmasiHapusLabel">Konfirmasi</h4>
            </div>
            <div class="modal-body">
                <div class="row text-center">
                    <h4>Apakah Anda yakin ingin menghapus barang ini?</h4>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Tidak</button>
                <button type="button" class="btn btn-success" onclick="deleteBarang();">Ya</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="konfUbahStatus" tabindex="-1" role="dialog" aria-labelledby="konfirmasiUbahStatusLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="konfirmasiUbahStatusLabel">Konfirmasi</h4>
            </div>
            <div class="modal-body">
                <div class="row text-center">
                    <h4>@*Apakah Anda yakin ingin mengubah status pesanan ini?*@</h4>
                    <h4>Apakah Anda yakin ingin mengubah status dari Pesanan menjadi Sudah Dibayar?</h4>
                </div>
                <div class="row info_pesanan">
                    <p>
                        <span class="block_subtitle">No. Pesanan</span>: <span class="no_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Tgl. Pesanan</span>: <span class="tgl_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Marketplace</span>: <span class="market_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Pembeli</span>: <span class="buyer_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Total</span>: Rp <span class="total_pesanan">0,00</span>
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Tidak</button>
                <button type="button" class="btn btn-success" onclick="ubahStatusPesanan();">Ya</button>
            </div>
        </div>
    </div>
</div>
@*add by nurul 8/10/2018-------------------*@
<div class="modal fade" id="konfUbahStatusDibayar" tabindex="-1" role="dialog" aria-labelledby="konfirmasiUbahStatusLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="konfirmasiUbahStatusLabel">Konfirmasi</h4>
            </div>
            <div class="modal-body">
                <div class="row text-center">
                    <h4>Apakah Anda yakin ingin mengubah status dari Sudah Dibayar menjadi Siap Dikirim?</h4>
                </div>
                <div class="row info_pesanan">
                    <p>
                        <span class="block_subtitle">No. Pesanan</span>: <span class="no_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Tgl. Pesanan</span>: <span class="tgl_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Marketplace</span>: <span class="market_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Pembeli</span>: <span class="buyer_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Total</span>: Rp <span class="total_pesanan">0,00</span>
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Tidak</button>
                <button type="button" class="btn btn-success" onclick="ubahStatusPesanan();">Ya</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="konfUbahStatusSiapkirim" tabindex="-1" role="dialog" aria-labelledby="konfirmasiUbahStatusLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="konfirmasiUbahStatusLabel">Konfirmasi</h4>
            </div>
            <div class="modal-body">
                <div class="row text-center">
                    <h4>Apakah Anda yakin ingin mengubah status dari Siap Dikirim menjadi Sudah Dikirim?</h4>
                </div>
                <div class="row info_pesanan">
                    <p>
                        <span class="block_subtitle">No. Pesanan</span>: <span class="no_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Tgl. Pesanan</span>: <span class="tgl_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Marketplace</span>: <span class="market_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Pembeli</span>: <span class="buyer_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Total</span>: Rp <span class="total_pesanan">0,00</span>
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Tidak</button>
                <button type="button" class="btn btn-success" onclick="ubahStatusPesanan();">Ya</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="konfUndoStatusSiapkirim" tabindex="-1" role="dialog" aria-labelledby="konfirmasiUbahStatusLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="konfirmasiUbahStatusLabel">Konfirmasi</h4>
            </div>
            <div class="modal-body">
                <div class="row text-center">
                    <h4>Apakah Anda yakin ingin mengubah status dari Siap Dikirim menjadi Sudah Dibayar?</h4>
                </div>
                <div class="row info_pesanan">
                    <p>
                        <span class="block_subtitle">No. Pesanan</span>: <span class="no_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Tgl. Pesanan</span>: <span class="tgl_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Marketplace</span>: <span class="market_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Pembeli</span>: <span class="buyer_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Total</span>: Rp <span class="total_pesanan">0,00</span>
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Tidak</button>
                <button type="button" class="btn btn-success" onclick="ubahStatusPesanan();">Ya</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="konfUbahStatusSudahkirim" tabindex="-1" role="dialog" aria-labelledby="konfirmasiUbahStatusLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="konfirmasiUbahStatusLabel">Konfirmasi</h4>
            </div>
            <div class="modal-body">
                <div class="row text-center">
                    <h4>Apakah Anda yakin ingin mengubah status dari Sudah Dikirim menjadi Selesai?</h4>
                </div>
                <div class="row info_pesanan">
                    <p>
                        <span class="block_subtitle">No. Pesanan</span>: <span class="no_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Tgl. Pesanan</span>: <span class="tgl_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Marketplace</span>: <span class="market_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Pembeli</span>: <span class="buyer_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Total</span>: Rp <span class="total_pesanan">0,00</span>
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Tidak</button>
                <button type="button" class="btn btn-success" onclick="ubahStatusPesanan();">Ya</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="konfUndoStatusSudahkirim" tabindex="-1" role="dialog" aria-labelledby="konfirmasiUbahStatusLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="konfirmasiUbahStatusLabel">Konfirmasi</h4>
            </div>
            <div class="modal-body">
                <div class="row text-center">
                    <h4>Apakah Anda yakin ingin mengubah status dari Sudah Dikirim menjadi Siap Dikirim?</h4>
                </div>
                <div class="row info_pesanan">
                    <p>
                        <span class="block_subtitle">No. Pesanan</span>: <span class="no_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Tgl. Pesanan</span>: <span class="tgl_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Marketplace</span>: <span class="market_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Pembeli</span>: <span class="buyer_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Total</span>: Rp <span class="total_pesanan">0,00</span>
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Tidak</button>
                <button type="button" class="btn btn-success" onclick="ubahStatusPesanan();">Ya</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="konfUndoStatusSelesai" tabindex="-1" role="dialog" aria-labelledby="konfirmasiUbahStatusLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="konfirmasiUbahStatusLabel">Konfirmasi</h4>
            </div>
            <div class="modal-body">
                <div class="row text-center">
                    <h4>Apakah Anda yakin ingin mengubah status dari Selesai menjadi Sudah Dikirim?</h4>
                </div>
                <div class="row info_pesanan">
                    <p>
                        <span class="block_subtitle">No. Pesanan</span>: <span class="no_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Tgl. Pesanan</span>: <span class="tgl_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Marketplace</span>: <span class="market_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Pembeli</span>: <span class="buyer_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Total</span>: Rp <span class="total_pesanan">0,00</span>
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Tidak</button>
                <button type="button" class="btn btn-success" onclick="ubahStatusPesanan();">Ya</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="konfUndoStatusBatal" tabindex="-1" role="dialog" aria-labelledby="konfirmasiUbahStatusLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="konfirmasiUbahStatusLabel">Konfirmasi</h4>
            </div>
            <div class="modal-body">
                <div class="row text-center">
                    <h4>Apakah Anda yakin ingin membatalkan pembatalan pesanan?</h4>
                </div>
                <div class="row info_pesanan">
                    <p>
                        <span class="block_subtitle">No. Pesanan</span>: <span class="no_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Tgl. Pesanan</span>: <span class="tgl_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Marketplace</span>: <span class="market_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Pembeli</span>: <span class="buyer_pesanan">-</span>
                    </p>
                    <p>
                        <span class="block_subtitle">Total</span>: Rp <span class="total_pesanan">0,00</span>
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Tidak</button>
                <button type="button" class="btn btn-success" onclick="ubahStatusPesanan();">Ya</button>
            </div>
        </div>
    </div>
</div>
@*end add by nurul -------------------*@

<div class="modal fade" id="modalIsiResi" tabindex="-1" role="dialog" aria-labelledby="isiResiLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="isiResiLabel">Isi Resi</h4>
            </div>
            <div class="modal-body">
                @* add by Tri, pilih shipment provider *@
                <div class="row">
                    <div class="form-group">
                        @Html.HiddenFor(m => m.Pesanan.SHIPMENT)
                        <div class="col-md-4 col-sm-4 col-xs-12" id="divLblShip"></div>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                            <table>
                                <tbody>
                                    <tr>
                                        <td id="divTextShip"></td>
                                        <td id="divBtnShip"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                @*end add by Tri, pilih shipment provider *@
                <div class="row">
                    <div class="form-group" style="margin-top: 5px;">
                        @Html.LabelFor(m => m.Pesanan.TRACKING_SHIPMENT, "No. Resi", new { @class = "col-md-4 col-sm-4 col-xs-12 control-label" })
                        <div class="col-md-6 col-sm-6 col-xs-12">
                            @Html.TextBoxFor(m => m.Pesanan.TRACKING_SHIPMENT, new { @class = "form-control" })
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="saveResi();" type="button" class="btn btn-success">Simpan Resi</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modalGudangDanQty" tabindex="-1" role="dialog" aria-labelledby="gudangQtyLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="gudangQtyLabel">Konfirmasi Gudang dan Kuantitas</h4>
            </div>
            <div class="modal-body" id="modal-gudang-qty-body">
                @Html.Partial("GudangQtyPartial")
            </div>
            <div class="modal-footer">
                <button onclick="saveGudangQty();" type="button" class="btn btn-success">Simpan</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modalPricing" tabindex="-1" role="dialog" aria-labelledby="pricingLabel">
    <div class="modal-dialog" id="modal-pricing" role="document">
        <div class="modal-content">
            @Html.Partial("PricingPartialView")
        </div>
    </div>
</div>
<div class="modal fade" id="modalPricingExpired" tabindex="-1" role="dialog" aria-labelledby="pricingLabel">
    <div class="modal-dialog" id="modal-pricing-expired" role="document">
        <div class="modal-content">
            @Html.Partial("PricingExpiredPartialView")
        </div>
    </div>
</div>

<div class="modal fade" id="modalTutupEditor" tabindex="-1" role="dialog" aria-labelledby="labelModalTutupEditor">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="labelModalTutupEditor">Konfirmasi</h4>
            </div>
            <div class="modal-body">
                <div class="row text-center">
                    <h4>Ada perubahan data yang belum Anda simpan. <br />Yakin ingin menutup form ini?</h4>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Tidak</button>
                <button type="button" class="btn btn-success" onclick="closeEditor()">Ya</button>
            </div>
        </div>
    </div>
</div>

@section scripts
{
    <script src="//cdn.datatables.net/plug-ins/1.10.11/sorting/date-eu.js" type="text/javascript"></script>
    <script src="~/Content/build/js/bootstrap-datepicker.min.js" type="text/javascript"></script>
    <script src="~/Content/build/js/selectivity-jquery.min.js" type="text/javascript"></script>
    <script src="~/Content/vendors/moment/min/moment.min.js" type="text/javascript"></script>
    <script src="~/Content/selectize.js" type="text/javascript"></script>
    <script src='@Url.Content("~/Scripts/jquery.validate.js")' type='text/javascript'></script>
    <script src='@Url.Content("~/Scripts/jquery.validate.unobtrusive.js")' type='text/javascript'></script>
    @*add by Tri snap js*@
    <script type="text/javascript" src="https://app.sandbox.midtrans.com/snap/snap.js" data-client-key="SB-Mid-client-kNpQZUsTHkQzk9BZ"></script>
    <script type="text/javascript">
        var $bakalNetto = 0;
        var $jumlahPesananMax = 0;
        var $jumlahPesananBulanIni = 0;
        var $nettoSebelumnya = 0;
        var $idPesanan = "";
        var $recPesanan = 0;
        var $statusPesanan = '0';
        var $totalAwal = 0;
        var $recResi = 0;
        var $listGudang = [];
        var $readyToShip = false;
        var $nobukPesanan = '';
        var $beforeState = {
            brutto: 0,
            netto: 0,
            ndisc: 0,
            ppn: 0,
            nppn: 0,
            ongkir: 0
        };

        var tableSiapProses = $('#datatable_siapproses').DataTable({
            columnDefs: [
                {
                    orderable: false,
                    className: 'select-checkbox',
                    targets: 0
                }
            ],
            select: {
                style: 'os',
                selector: 'td:first-child'
            }
        });

        var table = $('#datatable').DataTable({
            "order": [[0, 1, "desc"]], //or asc
            "columnDefs": [{ "targets": 1, "type": "date-eu" }],
        });
        var tableNunggu = $('#datatable_nunggu').DataTable({
            "order": [[0, 1, "desc"]], //or asc
            "columnDefs": [{ "targets": 1, "type": "date-eu" }],
        });
        var tableSedangProses = $('#datatable_sedangproses').DataTable({
            "order": [[0, 1, "desc"]], //or asc
            "columnDefs": [{ "targets": 1, "type": "date-eu" }],
        });
        var tableSiapKirim = $('#datatable_siapkirim').DataTable({
            "order": [[0, 1, "desc"]], //or asc
            "columnDefs": [{ "targets": 1, "type": "date-eu" }],
        });
        var tableSudahKirim = $('#datatable_sudahkirim').DataTable({
            "order": [[0, 2, "desc"]], //or asc
            "columnDefs": [{ "targets": 2, "type": "date-eu" }],
        });
        var tableSelesai = $('#datatable_selesai').DataTable({
            "order": [[0, 2, "desc"]], //or asc
            "columnDefs": [{ "targets": 2, "type": "date-eu" }],
        });
        var tableCancel = $('#datatable_cancel').DataTable({
            "order": [[0, 1, "desc"]], //or asc
            "columnDefs": [{ "targets": 1, "type": "date-eu" }],
        });

        $('#search_siapproses').keyup(function() {
            tableSiapProses.search($(this).val()).draw();
        });

        $('#search_pesanan').keyup(function() {
            table.search($(this).val()).draw();
        });

        $('#search_selesai').keyup(function() {
            tableSelesai.search($(this).val()).draw();
        });

        $('#search_cancel').keyup(function() {
            tableCancel.search($(this).val()).draw();
        });

        $('#search_nunggu').keyup(function() {
            tableNunggu.search($(this).val()).draw();
        });

        $('#search_sedangproses').keyup(function() {
            tableSedangProses.search($(this).val()).draw();
        });

        $('#search_siapkirim').keyup(function() {
            tableSiapKirim.search($(this).val()).draw();
        });

        $('#search_sudahkirim').keyup(function() {
            tableSudahKirim.search($(this).val()).draw();
        });

        $(document).ready(function() {
            refreshTablePesanan();

            $('#pesanan-tab').click(function() {
                refreshTablePesanan();
            });

            $('#nunggu-tab').click(function() {
                refreshTableSudahDibayar();
            });

            $('#sedangproses-tab').click(function() {
                refreshTableSiapKirim();
            });

            $('#sudahkirim-tab').click(function() {
                refreshTableSudahKirim();
            });

            $('#selesai-tab').click(function() {
                refreshTableSelesai();
            });

            $('#cancel-tab').click(function() {
                refreshTableCancel();
            });

            $(".hover").mouseleave(
                function() {
                    $(this).removeClass("hover");
                }
            );

            Initialize();
        });

        //add by Tri, call midtrans api get token
        function clickSub(sendKode) {
            var link = '@Url.Action("PaymentMidtrans", "Midtrans", new {code = "replaceCode"})';
            link = link.replace("replaceCode", "0" + sendKode);
            $.ajax({
                type: "GET",
                url: link,
                success: function(response) {
                    if (response != null) {
                        snap.pay(response, { skipOrderSummary: true });
                    }

                },
                error: function(xhr, status, error) {
                    console.log(error);
                }
            });
        }
        //end add by Tri, call midtrans api get token

        function closeEditor() {
            $('#modalTutupEditor').modal('hide');
            $('.pesanan_table_section').show();
            $('.pesanan_editor_section').hide();
            refreshForm1();
            refreshTablePesanan();
            $bakalNetto = 0;
            $totalAwal = 0;
            $nettoSebelumnya = 0;
        }

        function Initialize() {
            //$('input[name="select_all"]').on('click',
            //    function () {
            //        var attr = $(this).attr('checked');

            //        if (typeof attr !== typeof undefined && attr !== false) {
            //            $('input[name="data-1"]').removeAttr('checked');
            //            $('input[name="data-2"]').removeAttr('checked');
            //        } else {
            //            $('input[name="data-1"]').attr('checked', 'checked');
            //            $('input[name="data-2"]').attr('checked', 'checked');
            //        }
            //    });
            $('#tambah_pesanan').on('click',
                function() {
                    $('.pesanan_table_section').hide();
                    $('.pesanan_editor_section').show();
                });

            $('#close-editor-1').on('click',
                function() {
                    if ($('#btn-simpan-perubahan-row').is(':visible')) {
                        $('#modalTutupEditor').modal('show');
                    } else {
                        $('.pesanan_table_section').show();
                        $('.pesanan_editor_section').hide();
                        refreshForm1();
                        refreshTablePesanan();
                        $bakalNetto = 0;
                        $totalAwal = 0;
                        $nettoSebelumnya = 0;
                    }
                });

            $('#close-editor-2').on('click',
                function() {
                    $('.pesanan_selesai_section').show();
                    $('.pesanan_editor_selesai_section').hide();
                });

            $('#close-editor-3').on('click',
                function() {
                    $('.pesanan_sudah_dibayar_section').show();
                    $('.pesanan_editor_sudah_dibayar_section').hide();
                });

            if ($('.message-error').text() !== '') {
                $('#tambah_pesanan').click();
            }

            $('#table_tambah_pesanan > tbody > tr > td.editable-kode').prop('contentEditable', true);

            getTanggal();
            getMarketplace();
            getExpedisi();
            getBuyer();
            getGudang();
            getDataBarang();

            if ($('#Pesanan_TGL').val() != '') {
                $('#TGL').val($('#Pesanan_TGL').val());
            } else {
                $('#Pesanan_TGL').val($('#TGL').val());
            }

            $('#Pesanan_TERM').change(function() {
                if ($('#TGL').val() == '') {
                    $('#Pesanan_TGL_JTH_TEMPO').val('Pilih Tanggal dahulu');
                    return;
                }

                if ($(this).val() != '') {
                    var $tgl = moment($('#TGL').val(), "DD/MM/YYYY");
                    var tglTop = $tgl.add($(this).val(), 'days');
                    $('#Pesanan_TGL_JTH_TEMPO').val(tglTop.format('DD/MM/YYYY'));
                } else {
                    $('#Pesanan_TGL_JTH_TEMPO').val('Masukkan TOP dahulu');
                }
            });

            refreshInputan();
            refreshNetto();

            $('#tambah-pembeli').click(function() {
                window.open('@Url.Action("BuyerPopup", "Manage")',
                    "popupWindow",
                    "width=600, height=400, scrollbars=yes");
            });

            $('#lihat-pembeli').click(function() {
                var $link = '@Url.Action("EditPembeliPopup", "Manage", new {kodePembeli = "replaceId"})';
                $link = $link.replace("replaceId", $('#Pesanan_PEMESAN').val());
                window.open($link, "popupWindow", "width=600, height=400, scrollbars=yes, resizable=no");
            });

            //change by nurul 8/10/2018   $('#konfHapusPesanan, #konfBatalPesanan, #konfUbahStatus').on('shown.bs.modal',
            $(
                    '#konfHapusPesanan, #konfBatalPesanan, #konfUbahStatus, #konfUbahStatusDibayar, #konfUbahStatusSiapkirim, #konfUbahStatusSudahkirim, #konfUndoStatusSiapkirim, #konfUndoStatusSudahkirim, #konfUndoStatusSelesai, #konfUndoStatusBatal')
                .on('shown.bs.modal',
                    function() {
                        var link = '@Url.Action("GetPesananInfo", "Manage", new {nobuk = "replaceNoBuk"})';
                        link = link.replace("replaceNoBuk", $nobukPesanan);

                        $.ajax({
                            type: "GET",
                            url: link,
                            success: function(response) {
                                $('.no_pesanan').text(response.NoPesanan);
                                $('.tgl_pesanan').text(response.TglPesanan);
                                $('.market_pesanan').text(response.Marketplace);
                                $('.buyer_pesanan').text(response.Pembeli);
                                $('.total_pesanan').text(response.Total);
                            },
                            error: function(xhr, status, error) {
                                console.log(error);
                            }
                        });
                    });

            //change by nurul 8/10/2018   $('#konfHapusPesanan, #konfBatalPesanan, #konfUbahStatus').on('hidden.bs.modal',
            $(
                    '#konfHapusPesanan, #konfBatalPesanan, #konfUbahStatus, #konfUbahStatusDibayar, #konfUbahStatusSiapkirim, #konfUbahStatusSudahkirim, #konfUndoStatusSiapkirim, #konfUndoStatusSudahkirim, #konfUndoStatusSelesai, #konfUndoStatusBatal')
                .on('hidden.bs.modal',
                    function() {
                        $('.no_pesanan').text('-');
                        $('.tgl_pesanan').text('-');
                        $('.market_pesanan').text('-');
                        $('.buyer_pesanan').text('-');
                        $('.total_pesanan').text('0,00');
                    });

            $('.modal').on('hidden.bs.modal',
                function() {
                    $(this).removeData('bs.modal');
                });
        }

        function cekJumlahPesananBulanIni() {
            var link = '@Url.Action("CekJumlahPesananBulanIni", "Manage", new {uname = "replaceUname"})';
            link = link.replace("replaceUname", '@(username)');

            $.ajax({
                type: "GET",
                url: link,
                success: function(res) {
                    $jumlahPesananMax = res.JumlahPesananMax;
                    $jumlahPesananBulanIni = res.JumlahPesananBulanIni;

                    if ($jumlahPesananBulanIni >= $jumlahPesananMax) {
                        $('#tambah_baru_tombol_section').append(
                            '<button class="btn btn-primary btn_tambah_data" data-toggle="modal" ' +
                            'data-target="#modalPricing" id="tambah_pesanan">Tambah Baru</button>');
                    } else if (res.SudahSampaiBatasTanggal) {
                        $('#tambah_baru_tombol_section').append(
                            '<button class="btn btn-primary btn_tambah_data" data-toggle="modal" ' +
                            'data-target="#modalPricingExpired" id="tambah_pesanan">Tambah Baru</button>');
                    } else {
                        $('#tambah_baru_tombol_section')
                            .append(
                                '<button class="btn btn-primary btn_tambah_data" id="tambah_pesanan">Tambah Baru</button>');
                        $('#tambah_pesanan').on('click',
                            function() {
                                $('.pesanan_table_section').hide();
                                $('.pesanan_editor_section').show();
                            });
                    }
                },
                error: function(xhr, status, error) {
                    console.log(error);
                }
            });
        }

        function getTanggal() {
            $('#TGL').datepicker({
                format: 'dd/mm/yyyy',
                language: 'id'
            }).datepicker('setDate', '0').change(function() {
                if ($(this).val() == '') {
                    $('#Pesanan_TGL_JTH_TEMPO').val('Pilih Tanggal dahulu');
                    return;
                }

                var $tgl = moment($(this).val(), "DD/MM/YYYY");
                $('#Pesanan_TGL').val($(this).val());

                if ($('#Pesanan_TERM').val() == '') {
                    $('#Pesanan_TGL_JTH_TEMPO').val('Masukkan TOP dahulu');
                } else {
                    var $tglTop = $tgl.add($('#Pesanan_TERM').val(), 'days');
                    $('#Pesanan_TGL_JTH_TEMPO').val($tglTop.format('DD/MM/YYYY'));
                }
            });
        }

        var $flagPerubahan = 0;

        function refreshInputan() {
            if ($('#Pesanan_TGL').val() != '') {
                $('#TGL').val($('#Pesanan_TGL').val());
            }

            $('#Pesanan_NILAI_DISC').focus(function() {
                $(this).val(convertToAngka($(this).val()));
            });

            $('#Pesanan_NILAI_DISC').blur(function() {
                var $tot = convertToAngka($('#Pesanan_BRUTO').val());
                if ($(this).val() > $tot) {
                    alert('Diskon tidak boleh melebihi total brutto sebesar ' + convertToRupiah($tot) + '!');
                    $(this).val($tot);
                } else {
                    if ($(this).val() < 0 || $(this).val() === '') $(this).val(convertToRupiah(0));
                }
                if ($(this).val() === '') $(this).val(0);
                $(this).val(convertToAngka($(this).val()));
                $(this).val(convertToRupiah($(this).val()));
                refreshNetto();
            });

            $('#Pesanan_NILAI_DISC').change(function() {
                if ($(this).val() <= convertToAngka($('#Pesanan_BRUTO').val())) {
                    $(this).val(convertToAngka($(this).val()));
                    $(this).val(convertToRupiah($(this).val()));
                    refreshNetto();
                }
            });

            $('#Pesanan_PPN').focus(function() {
                $(this).val(convertToAngka($(this).val()));
            });

            $('#Pesanan_PPN').blur(function() {
                if ($(this).val() === '') $(this).val(0);
                refreshNetto();
            });

            $('#Pesanan_PPN').change(function() {
                if ($(this).val() > 100) $(this).val(100);
                if ($(this).val() < 0 || $(this).val() === '') $(this).val(0);
                refreshNetto();
            });

            $('#Pesanan_ONGKOS_KIRIM').focus(function() {
                $(this).val(convertToAngka($(this).val()));
            });

            $('#Pesanan_ONGKOS_KIRIM').blur(function() {
                if ($(this).val() === '') $(this).val(0);
                $(this).val(convertToRupiah($(this).val()));
                refreshNetto();
            });

            $('#Pesanan_ONGKOS_KIRIM').change(function() {
                if ($(this).val() < 0 || $(this).val() === '') $(this).val(convertToRupiah(0));
                refreshNetto();
            });

            $("input.num-only").on('keydown',
                function(e) {
                    // Allow: backspace, delete, tab, escape, enter and .
                    if ($.inArray(e.keyCode, [46, 8, 9, 27, 13, 110, 190]) !== -1 ||
                        // Allow: Ctrl+A, Command+A
                        (e.keyCode === 65 && (e.ctrlKey === true || e.metaKey === true)) ||
                        // Allow: home, end, left, right, down, up
                        (e.keyCode >= 35 && e.keyCode <= 40)) {
                        // let it happen, don't do anything
                        return;
                    }
                    // Ensure that it is a number and stop the keypress
                    if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                        e.preventDefault();
                    }
                });

            $('#Pesanan_BRUTO').attr('readonly', 'readonly').css('background-color', '#eee')
                .css('cursor', 'not-allowed');
            $('#Pesanan_NILAI_PPN').attr('readonly', 'readonly').css('background-color', '#eee')
                .css('cursor', 'not-allowed');
            $('#Pesanan_NETTO').attr('readonly', 'readonly').css('background-color', '#eee')
                .css('cursor', 'not-allowed');
            $('#Pesanan_TGL_JTH_TEMPO').attr('readonly', 'readonly').css('background-color', '#eee')
                .css('cursor', 'not-allowed');

            $('#Pesanan_NILAI_DISC').change(function() {
                $('#btn-simpan-perubahan-row').show();
            });

            $('#Pesanan_ONGKOS_KIRIM').change(function() {
                $('#btn-simpan-perubahan-row').show();
            });

            $('#Pesanan_PPN').change(function() {
                $('#btn-simpan-perubahan-row').show();
            });

            $('#Pesanan_TGL').change(function() {
                $('#btn-simpan-perubahan-row').show();
            });

            $('#btn-simpan-perubahan').click(function() {
                var $this = $(this);
                $.ajax({
                    type: "POST",
                    url: '@Url.Action("UpdatePesanan", "Manage")',
                    data: JSON.stringify({
                        OrderId: $('#Pesanan_NO_BUKTI').val(),
                        NilaiDisc: convertToAngka($('#Pesanan_NILAI_DISC').val()),
                        OngkosKirim: convertToAngka($('#Pesanan_ONGKOS_KIRIM').val()),
                        Ppn: $('#Pesanan_PPN').val(),
                        NilaiPpn: convertToAngka($('#Pesanan_NILAI_PPN').val()),
                        Tgl: $('#Pesanan_TGL').val(),
                        Cust: $('#Pesanan_CUST').val(),
                        Term: $('#Pesanan_TERM').val(),
                        Exp: $('#Pesanan_EXPEDISI').val(),
                        Buyer: $('#Pesanan_PEMESAN').val(),
                        Tempo: $('#Pesanan_TGL_JTH_TEMPO').val()
                    }),
                    contentType: 'application/json; charset=UTF-8',
                    cache: false,
                    beforeSend: function() {
                        $('#loading_spinner').show();
                    },
                    success: function() {
                        alert('Data pesanan berhasil di-update');
                        $('#close-editor-1').click();
                        $('#loading_spinner').hide();
                    },
                    error: function(xhr) {
                        console.log(xhr);
                        $('#loading_spinner').hide();
                    }
                });
            });

            $('#Pesanan_TERM').blur(function() {
                $('#btn-simpan-perubahan-row').show();
            });

            $('#Pesanan_TGL_JTH_TEMPO').blur(function() {
                $('#btn-simpan-perubahan-row').show();
            });
        }

        function refreshNettoBarang($trId) {
            var $trElement = 'tr[data-pesanan-id="' + $trId + '"]';
            var $hargaBarang = convertToAngka($($trElement + ' .harga-barang').text());

            var $ndisc1 = convertToAngka($($trElement + ' .ndisc1-barang').text());
            var $ndisc2 = convertToAngka($($trElement + ' .ndisc2-barang').text());
            var $totDisc = $ndisc1 + $ndisc2;
            var $total = ($($trElement + ' .qty-barang').text() * $hargaBarang) - $totDisc;

            $($trElement + ' .netto-barang').html(convertToRupiah($total) +
                '<input data-val="true" data-val-number="The field HARGA must be a number." data-val-required="The HARGA field is required." id="PesananDetail_HARGA" name="PesananDetail.HARGA" type="hidden" value="">');
            $('#Pesanan_BRUTO').val(convertToRupiah($total + $totalAwal + $nettoSebelumnya));

            refreshNetto();

            /*
            var $nettoIndex = $nettoBarang.findIndex((obj => obj.id === $trId));

            if ($nettoIndex === -1) {
                $nettoBarang.push({
                    id: $trId,
                    netto: $total
                });
            } else {
                $nettoBarang[$nettoIndex].netto = $total;
            }
            */
        }

        function refreshNetto() {
            $bakalNetto = convertToAngka($('#Pesanan_BRUTO').val());

            var $nPpn = Math.ceil($bakalNetto * $('#Pesanan_PPN').val() / 100);
            $('#Pesanan_NILAI_PPN').val(convertToRupiah($nPpn));

            $bakalNetto -= convertToAngka($('#Pesanan_NILAI_DISC').val());
            $bakalNetto += $nPpn;
            $bakalNetto += convertToAngka($('#Pesanan_ONGKOS_KIRIM').val());

            $('#Pesanan_NETTO').val(convertToRupiah($bakalNetto));
        }

        function offTab() {
            $(document).keydown(function(objEvent) {
                if (objEvent.keyCode == 9) {
                    objEvent.preventDefault();
                }
            });
        }

        function onTab() {
            $(document).keydown(function(objEvent) {
                if (objEvent.keyCode == 9) {
                }
            });
        }

        function modeEditTd() {
            $('.qty-barang').addClass('editable');
            $('.disc1-barang').addClass('editable');
            $('.ndisc1-barang').addClass('editable');
            $('.disc2-barang').addClass('editable');
            $('.ndisc2-barang').addClass('editable');
            $('#table_tambah_pesanan > tbody > tr > td.editable').prop('contentEditable', true);
            $('#table_tambah_pesanan > tbody > tr > td.editable').on('click',
                function() {
                    var $this = $(this);
                    var $class = $this.attr('class');
                    var $inputClass = '';
                    var $trId = $this.parent().attr('data-pesanan-id');
                    var $trElement = 'tr[data-pesanan-id="' + $trId + '"]';
                    var $angka = convertToAngka($this.text());

                    if ($class == 'qty-barang editable') {
                        $inputClass = 'qty-input';
                    } else if ($class == 'disc1-barang editable' || $class == 'disc2-barang editable') {
                        $inputClass = 'disc-input';
                    } else if ($class == 'ndisc1-barang editable' || $class == 'ndisc2-barang editable') {
                        $inputClass = 'ndisc-input';
                    }

                    var $input = $('<input>',
                        {
                            'class': $inputClass,
                            //value: $this.val(),
                            value: $angka,
                            type: 'number',
                            blur: function() {
                                if (this.value === '') {
                                    if ($class === 'qty-barang editable') {
                                        $this.html(0 +
                                            '<input data-val="true" data-val-number="The field QTY must be a number." data-val-required="The QTY field is required." id="PesananDetail_QTY" name="PesananDetail.QTY" type="hidden" value="0">');

                                        hitungUlangdisc1();
                                        hitungUlangdisc2();
                                    } else if ($class === 'disc1-barang editable') {
                                        $this.html(0 +
                                            '<input data-val="true" data-val-number="The field DISCOUNT must be a number." data-val-required="The DISCOUNT field is required." id="PesananDetail_DISCOUNT" name="PesananDetail.DISCOUNT" type="hidden" value="0">');

                                        $($trElement + ' .ndisc1-barang')
                                            .text(convertToRupiah(0))
                                            .addClass('editable')
                                            .prop('contentEditable', true)
                                            .css('pointer-events', 'auto');

                                        hitungUlangdisc2();

                                    } else if ($class === 'disc2-barang editable') {
                                        $this.html(0 +
                                            '<input data-val="true" data-val-number="The field DISCOUNT_2 must be a number." data-val-required="The DISCOUNT_2 field is required." id="PesananDetail_DISCOUNT_2" name="PesananDetail.DISCOUNT_2" type="hidden" value="0">');

                                        $($trElement + ' .ndisc2-barang')
                                            .text(convertToRupiah(0))
                                            .addClass('editable')
                                            .prop('contentEditable', true)
                                            .css('pointer-events', 'auto');
                                    } else if ($class === 'ndisc1-barang editable') {
                                        $this.html("0,00" +
                                            '<input data-val="true" data-val-number="The field NILAI_DISC_1 must be a number." data-val-required="The NILAI_DISC_1 field is required." id="PesananDetail_NILAI_DISC_1" name="PesananDetail.NILAI_DISC_1" type="hidden" value="0">');

                                        $($trElement + ' .disc1-barang')
                                            .addClass('editable')
                                            .prop('contentEditable', true)
                                            .css('pointer-events', 'auto')
                                            .html("0" +
                                                '<input data-val="true" data-val-number="The field DISCOUNT must be a number." data-val-required="The DISCOUNT field is required." id="PesananDetail_DISCOUNT" name="PesananDetail.DISCOUNT" type="hidden" value="">');

                                        hitungUlangdisc2();

                                    } else if ($class === 'ndisc2-barang editable') {
                                        $this.html("0,00" +
                                            '<input data-val="true" data-val-number="The field NILAI_DISC_2 must be a number." data-val-required="The NILAI_DISC_2 field is required." id="PesananDetail_NILAI_DISC_2" name="PesananDetail.NILAI_DISC_2" type="hidden" value="0">');

                                        $($trElement + ' .disc2-barang')
                                            .addClass('editable')
                                            .prop('contentEditable', true)
                                            .css('pointer-events', 'auto')
                                            .html("0" +
                                                '<input data-val="true" data-val-number="The field DISCOUNT_2 must be a number." data-val-required="The DISCOUNT_2 field is required." id="PesananDetail_DISCOUNT_2" name="PesananDetail.DISCOUNT_2" type="hidden" value="">');
                                    }

                                    refreshNettoBarang($trId);
                                } else {
                                    var $hargaBarang = convertToAngka($($trElement + ' .harga-barang').text());

                                    if ($class === 'qty-barang editable') {
                                        $this.html(this.value +
                                            '<input data-val="true" data-val-number="The field QTY must be a number." data-val-required="The QTY field is required." id="PesananDetail_QTY" name="PesananDetail.QTY" type="hidden" value="' +
                                            this.value +
                                            '">');

                                        hitungUlangdisc1();
                                        hitungUlangdisc2();

                                    } else if ($class === 'disc1-barang editable') {
                                        $this.html(this.value +
                                            '<input data-val="true" data-val-number="The field DISCOUNT must be a number." data-val-required="The DISCOUNT field is required." id="PesananDetail_DISCOUNT" name="PesananDetail.DISCOUNT" type="hidden" value="' +
                                            this.value +
                                            '">');

                                        if (this.value == 0) {
                                            $($trElement + ' .ndisc1-barang')
                                                .addClass('editable')
                                                .prop('contentEditable', true)
                                                .css('pointer-events', 'auto')
                                                .html("0,00" +
                                                    '<input data-val="true" data-val-number="The field NILAI_DISC_1 must be a number." data-val-required="The NILAI_DISC_1 field is required." id="PesananDetail_NILAI_DISC_1" name="PesananDetail.NILAI_DISC_1" type="hidden" value="0">');
                                        } else {
                                            var $ndisc1 = convertToRupiah(this.value *
                                                $hargaBarang *
                                                parseInt($($trElement + ' .qty-barang').text()) /
                                                100);

                                            $($trElement + ' .ndisc1-barang')
                                                .removeClass('editable')
                                                .prop('contentEditable', false)
                                                .css('pointer-events', 'none')
                                                .html($ndisc1 +
                                                    '<input data-val="true" data-val-number="The field NILAI_DISC_1 must be a number." data-val-required="The NILAI_DISC_1 field is required." id="PesananDetail_NILAI_DISC_1" name="PesananDetail.NILAI_DISC_1" type="hidden" value="' +
                                                    convertToAngka($ndisc1) +
                                                    '">');
                                        }

                                        hitungUlangdisc2();

                                    } else if ($class === 'disc2-barang editable') {
                                        $this.html(this.value +
                                            '<input data-val="true" data-val-number="The field DISCOUNT_2 must be a number." data-val-required="The DISCOUNT_2 field is required." id="PesananDetail_DISCOUNT_2" name="PesananDetail.DISCOUNT_2" type="hidden" value="' +
                                            this.value +
                                            '">');

                                        if (this.value == 0) {
                                            $($trElement + ' .ndisc2-barang')
                                                .addClass('editable')
                                                .prop('contentEditable', true)
                                                .css('pointer-events', 'auto')
                                                .html("0,00" +
                                                    '<input data-val="true" data-val-number="The field NILAI_DISC_2 must be a number." data-val-required="The NILAI_DISC_2 field is required." id="PesananDetail_NILAI_DISC_2" name="PesananDetail.NILAI_DISC_2" type="hidden" value="0">');
                                        } else {
                                            var $ndisc1Exist = convertToAngka($($trElement + ' .ndisc1-barang').text());
                                            //change by nurul 1/10/2018
                                            //var $ndisc2 = convertToRupiah(this.value * ($hargaBarang * parseInt($($trElement + ' .qty-barang').text()) - $ndisc1Exist / 100));
                                            var $ndisc2 = convertToRupiah(this.value *
                                                (($hargaBarang * parseInt($($trElement + ' .qty-barang').text())) -
                                                    $ndisc1Exist) /
                                                100);
                                            //end change

                                            $($trElement + ' .ndisc2-barang')
                                                .removeClass('editable')
                                                .prop('contentEditable', false)
                                                .css('pointer-events', 'none')
                                                .html($ndisc2 +
                                                    '<input data-val="true" data-val-number="The field NILAI_DISC_2 must be a number." data-val-required="The NILAI_DISC_2 field is required." id="PesananDetail_NILAI_DISC_2" name="PesananDetail.NILAI_DISC_2" type="hidden" value="' +
                                                    convertToAngka($ndisc2) +
                                                    '">');
                                        }
                                    } else if ($class === 'ndisc1-barang editable') {
                                        $this.html(convertToRupiah(this.value) +
                                            '<input data-val="true" data-val-number="The field NILAI_DISC_1 must be a number." data-val-required="The NILAI_DISC_1 field is required." id="PesananDetail_NILAI_DISC_1" name="PesananDetail.NILAI_DISC_1" type="hidden" value="' +
                                            convertToAngka(this.value) +
                                            '">');

                                        if (this.value != 0) {
                                            $($trElement + ' .disc1-barang')
                                                .removeClass('editable')
                                                .prop('contentEditable', false)
                                                .css('pointer-events', 'none')
                                                .html("0" +
                                                    '<input data-val="true" data-val-number="The field DISCOUNT must be a number." data-val-required="The DISCOUNT field is required." id="PesananDetail_DISCOUNT" name="PesananDetail.DISCOUNT" type="hidden" value="0">');
                                        } else {
                                            $($trElement + ' .disc1-barang')
                                                .addClass('editable')
                                                .prop('contentEditable', true)
                                                .css('pointer-events', 'auto')
                                                .html("0" +
                                                    '<input data-val="true" data-val-number="The field DISCOUNT must be a number." data-val-required="The DISCOUNT field is required." id="PesananDetail_DISCOUNT" name="PesananDetail.DISCOUNT" type="hidden" value="0">');
                                        }

                                        hitungUlangdisc2();

                                    } else if ($class === 'ndisc2-barang editable') {
                                        $this.html(convertToRupiah(this.value) +
                                            '<input data-val="true" data-val-number="The field NILAI_DISC_2 must be a number." data-val-required="The NILAI_DISC_2 field is required." id="PesananDetail_NILAI_DISC_2" name="PesananDetail.NILAI_DISC_2" type="hidden" value="' +
                                            this.value +
                                            '">');

                                        if (this.value != 0) {
                                            $($trElement + ' .disc2-barang')
                                                .removeClass('editable')
                                                .prop('contentEditable', false)
                                                .css('pointer-events', 'none')
                                                .html("0" +
                                                    '<input data-val="true" data-val-number="The field DISCOUNT_2 must be a number." data-val-required="The DISCOUNT_2 field is required." id="PesananDetail_DISCOUNT_2" name="PesananDetail.DISCOUNT_2" type="hidden" value="0">');
                                        } else {
                                            $($trElement + ' .disc2-barang')
                                                .addClass('editable')
                                                .prop('contentEditable', true)
                                                .css('pointer-events', 'auto')
                                                .html("0" +
                                                    '<input data-val="true" data-val-number="The field DISCOUNT_2 must be a number." data-val-required="The DISCOUNT_2 field is required." id="PesananDetail_DISCOUNT_2" name="PesananDetail.DISCOUNT_2" type="hidden" value="0">');
                                        }
                                    }

                                    refreshNettoBarang($trId);
                                }
                            },
                            focus: function() {
                                if ($angka == 0) {
                                    this.value = '';
                                } else {
                                    this.value = $angka;
                                }
                            },
                            keypress: function(e) {
                                var keyCode = e.keyCode || e.which;
                                if (keyCode != 8 && keyCode != 0 && keyCode < 48 || keyCode > 57) e.preventDefault();

                                if ($(this).attr('class') == 'qty-input') {
                                    if (keyCode === 13) {
                                        $('#table_tambah_pesanan > tbody > tr > td.disc1-barang').click();
                                        e.preventDefault();
                                    }
                                } else if ($(this).attr('class') == 'disc-input' && $(this).parent().hasClass('disc1-barang')) {
                                    if (keyCode === 13) {
                                        $('#table_tambah_pesanan > tbody > tr > td.disc2-barang').click();
                                        e.preventDefault();
                                    }
                                } else {
                                    if (keyCode === 13) {
                                        $(this).blur();
                                    }
                                }
                            },
                            change: function() {
                                if ($(this).attr('class') == 'qty-input') {
                                    if ($(this).val() > 999) {
                                        $(this).val(999);
                                    }
                                }

                                if ($(this).attr('class') == 'disc-input') {
                                    if ($(this).val() > 99) {
                                        $(this).val(99);
                                    }
                                }
                            }
                        }).appendTo($this.empty()).focus();
                });
        }

        @{
            var markets = new Dictionary<string, string>();

            foreach (var marketplace in context.Marketplaces.ToList())
            {
                markets.Add(marketplace.IdMarket.ToString(), marketplace.NamaMarket);
            }
        }

        var $marketCollection = @Html.Raw(Json.Encode(markets));

        function getMarketplace() {
            $.ajax({
                type: "GET",
                url: '@Url.Action("GetPelangganAkun", "Manage")',
                contentType: 'application/json',
                cache: false,
                success: function(data) {
                    var customerList = [];

                    $.each(data,
                        function(i, item) {
                            var $namaMarket = $marketCollection[item.NAMA];

                            customerList[i] = {
                                id: item.CUST,
                                text: $namaMarket + " (" + item.PERSO + ")",
                                term: item.TOP,
                                akun: item.PERSO
                            };
                        });

                    var custSelect = $('#CUSTOMER').selectize({
                        valueField: 'id',
                        searchField: 'text',
                        options: customerList,
                        onChange: function(value) {
                            var $objSup = $.grep(customerList, function(data) { return data.id == value });

                            if (value == null) {
                                $("#Pesanan_CUST").val(null);
                                $("#Pesanan_NAMA_CUST").val(null);
                                $("#Pesanan_TERM").val(null).change();
                            } else {
                                $("#Pesanan_CUST").val(value).trigger('change');
                                $("#Pesanan_NAMA_CUST").val($objSup[0].akun);
                                if ($objSup[0] != null) {
                                    //change by nurul 3/10/2018
                                    //$("#Pesanan_TERM").val($objSup[0].term).change();
                                    if ($("#Pesanan_TERM").val == "0") {
                                        $("#Pesanan_TERM").val($objSup[0].term).change();
                                    }
                                    //end change
                                }

                                getTanggal();
                                getDataBarang();
                            }
                            $('#btn-simpan-perubahan-row').show();
                        }
                    });

                    custSelect[0].selectize.setValue($('#Pesanan_CUST').val());
                    if ($('#Pesanan_CUST').val() != "") {
                        $('#CUSTOMER')[0].selectize.disable();
                    }
                    $('#btn-simpan-perubahan-row').hide();
                },
                error: function(xhr) {
                    console.log(xhr);
                }
            });
        }

        function getExpedisi() {
            $.ajax({
                type: "GET",
                url: '@Url.Action("GetEkspedisi", "Manage")',
                contentType: 'application/json',
                cache: false,
                success: function(data) {
                    var listEkspedisi = [];

                    $.each(data,
                        function(i, item) {
                            listEkspedisi[i] = {
                                id: item.RecNum,
                                text: item.NamaEkspedisi
                            };
                        });

                    var expedisiSelect = $('#EXPEDISI').selectize({
                        valueField: 'id',
                        searchField: 'text',
                        options: listEkspedisi,
                        onChange: function(value) {
                            $('#Pesanan_EXPEDISI').val(value);
                            $('#Pesanan_NAMAPENGIRIM').val($("#EXPEDISI option:selected").text());
                            $('#btn-simpan-perubahan-row').show();
                        }
                    });

                    expedisiSelect[0].selectize.setValue($('#Pesanan_EXPEDISI').val());
                    $('#btn-simpan-perubahan-row').hide();
                },
                error: function(xhr) {
                    console.log(xhr);
                }
            });
        }

        function getBuyer() {
            $.ajax({
                type: "GET",
                url: '@Url.Action("GetPembeli", "Manage")',
                contentType: 'application/json',
                cache: false,
                success: function(data) {
                    var listPembeli = [];

                    $.each(data,
                        function(i, item) {
                            listPembeli[i] = {
                                id: item.BUYER_CODE,
                                text: item.NAMA,
                                address: item.AL
                            };
                        });

                    $('#MARKETPEMESAN').selectize()[0].selectize.destroy();

                    var marketSelect = $('#MARKETPEMESAN').selectize({
                        valueField: 'id',
                        searchField: 'text',
                        options: listPembeli,
                        onChange: function(value) {
                            $('#Pesanan_PEMESAN').val(value);
                            $('#Pesanan_NAMAPEMESAN').val($("#MARKETPEMESAN option:selected").text());
                            $.each(listPembeli,
                                function(i, item) {
                                    if (item.id == value) {
                                        $('#Pesanan_ALAMAT_KIRIM').val(item.address);
                                    }
                                });

                            if (value == null) {
                                $('#tambah-pembeli').show();
                                $('#lihat-pembeli').hide();
                            } else {
                                $('#tambah-pembeli').hide();
                                $('#lihat-pembeli').show();
                            }
                            $('#btn-simpan-perubahan-row').show();
                        }
                    });

                    marketSelect[0].selectize.setValue($('#Pesanan_PEMESAN').val());
                    $('#btn-simpan-perubahan-row').hide();
                },
                error: function(xhr) {
                    console.log(xhr);
                }
            });
        }

        function hitungUlangdisc1() {
            var $trElement = 'tr[data-pesanan-id="0"]';
            var $qty = parseInt($($trElement + ' .qty-barang').text());
            var $hargaBarang = convertToAngka($($trElement + ' .harga-barang').text());

            if ($($trElement + ' .disc1-barang').hasClass('editable')) {
                if (convertToAngka($($trElement + ' .disc1-barang').text()) != 0) {
                    // disc1 yang diisi
                    var $thisvalue = convertToAngka($($trElement + ' .disc1-barang').text());

                    var $ndisc1 = convertToRupiah($thisvalue * $hargaBarang * $qty / 100);
                    $($trElement + ' .ndisc1-barang').html($ndisc1 +
                        '<input data-val="true" data-val-number="The field NILAI_DISC_1 must be a number." data-val-required="The NILAI_DISC_1 field is required." id="PesananDetail_NILAI_DISC_1" name="PesananDetail.NILAI_DISC_1" type="hidden" value="' +
                        convertToAngka($ndisc1) +
                        '">');
                }
            }
        }

        function hitungUlangdisc2() {
            var $trElement = 'tr[data-pesanan-id="0"]';
            var $qty = parseInt($($trElement + ' .qty-barang').text());
            var $hargaBarang = convertToAngka($($trElement + ' .harga-barang').text());

            if ($($trElement + ' .disc2-barang').hasClass('editable')) {
                if (convertToAngka($($trElement + ' .disc2-barang').text()) != 0) {
                    // disc2 yang diisi
                    var $ndisc1Exist = convertToAngka($($trElement + ' .ndisc1-barang').text());
                    var $thisvalue = convertToAngka($($trElement + ' .disc2-barang').text());

                    var $ndisc2 = convertToRupiah($thisvalue * (($hargaBarang * $qty) - $ndisc1Exist) / 100);
                    $($trElement + ' .ndisc2-barang').html($ndisc2 +
                        '<input data-val="true" data-val-number="The field NILAI_DISC_2 must be a number." data-val-required="The NILAI_DISC_2 field is required." id="PesananDetail_NILAI_DISC_2" name="PesananDetail.NILAI_DISC_2" type="hidden" value="' +
                        convertToAngka($ndisc2) +
                        '">');
                }
            }

        }

        function getDataBarang() {
            if ($('#Pesanan_CUST').val() != '') {
                var link = '@Url.Action("GetDataBarangPesanan", "Manage", new {code = "replaceCode"})';
                link = link.replace("replaceCode", $('#Pesanan_CUST').val());

                $.ajax({
                    type: "GET",
                    url: link,
                    contentType: 'application/json',
                    cache: false,
                    success: function(data) {
                        var listKodeBarang = [];

                        $.each(data,
                            function(i, item) {
                                listKodeBarang[i] = {
                                    id: item.BRG,
                                    text: item.BRG + ' (' + item.NAMA + ')'
                                };
                            });

                        $('#BRG').selectivity({
                            allowClear: true,
                            items: listKodeBarang,
                            placeholder: 'Harap pilih'
                        }).change(function() {
                            var val = $(this).selectivity('value');
                            var $trId = $(this).closest('tr').attr('data-pesanan-id');
                            var $trElement = 'tr[data-pesanan-id="' + $trId + '"]';

                            if (val != null) {
                                $('#CUSTOMER')[0].selectize.disable();

                                $.each(data,
                                    function(i, item) {
                                        if (item.BRG === val) {
                                            if (item.NAMA2 == null)
                                                $($trElement + ' .nama-barang').text(item.NAMA + " ");
                                            else
                                                $($trElement + ' .nama-barang').text(item.NAMA + " " + item.NAMA2);

                                            $($trElement + ' .stn-barang').html(item.STN2 +
                                                '<input data-val="true" data-val-length="The field SATUAN must be a string with a maximum length of 10." data-val-length-max="10" id="PesananDetail_SATUAN" name="PesananDetail.SATUAN" type="hidden" value="">');
                                            $($trElement + ' .harga-barang').html(convertToRupiah(item.HJUAL) +
                                                '<input data-val="true" data-val-number="The field H_SATUAN must be a number." data-val-required="The H_SATUAN field is required." id="PesananDetail_H_SATUAN" name="PesananDetail.H_SATUAN" type="hidden" value="">');
                                            return;
                                        }
                                    });

                                $beforeState.brutto = $('#Pesanan_BRUTO').val();
                                $beforeState.netto = $('#Pesanan_NETTO').val();
                                $beforeState.ndisc = $('#Pesanan_NILAI_DISC').val();
                                $beforeState.ppn = $('#Pesanan_PPN').val();
                                $beforeState.nppn = $('#Pesanan_NILAI_PPN').val();
                                $beforeState.ongkir = $('#Pesanan_ONGKOS_KIRIM').val();
                                $($trElement + ' .btn-primary').removeAttr('disabled');
                                offTab();
                                modeEditTd();

                                // Otomatis masuk ke field Qty setelah pilih barang
                                $('#table_tambah_pesanan > tbody > tr > td.qty-barang').click();

                                hitungUlangdisc1();
                                hitungUlangdisc2();
                                refreshNettoBarang('0');
                            } else {
                                $('#CUSTOMER')[0].selectize.enable();

                                $($trElement + ' .nama-barang').text('-');
                                $($trElement + ' .stn-barang').html('-' +
                                    '<input data-val="true" data-val-length="The field SATUAN must be a string with a maximum length of 10." data-val-length-max="10" id="PesananDetail_SATUAN" name="PesananDetail.SATUAN" type="hidden" value="">');
                                $($trElement + ' .harga-barang').html('0,00' +
                                    '<input data-val="true" data-val-number="The field H_SATUAN must be a number." data-val-required="The H_SATUAN field is required." id="PesananDetail_H_SATUAN" name="PesananDetail.H_SATUAN" type="hidden" value="">');
                                $($trElement + ' .qty-barang').html('0' +
                                    '<input data-val="true" data-val-number="The field QTY must be a number." data-val-required="The QTY field is required." id="PesananDetail_QTY" name="PesananDetail.QTY" type="hidden" value="">');
                                $($trElement + ' .disc1-barang').html('0' +
                                    '<input data-val="true" data-val-number="The field DISCOUNT must be a number." data-val-required="The DISCOUNT field is required." id="PesananDetail_DISCOUNT" name="PesananDetail.DISCOUNT" type="hidden" value="">');
                                $($trElement + ' .disc2-barang').html('0' +
                                    '<input data-val="true" data-val-number="The field DISCOUNT_2 must be a number." data-val-required="The DISCOUNT_2 field is required." id="PesananDetail_DISCOUNT_2" name="PesananDetail.DISCOUNT_2" type="hidden" value="">');
                                $($trElement + ' .ndisc1-barang').html('0,00' +
                                    '<input data-val="true" data-val-number="The field NILAI_DISC_1 must be a number." data-val-required="The NILAI_DISC_1 field is required." id="PesananDetail_NILAI_DISC_1" name="PesananDetail.NILAI_DISC_1" type="hidden" value="">');
                                $($trElement + ' .ndisc2-barang').html('0,00' +
                                    '<input data-val="true" data-val-number="The field NILAI_DISC_2 must be a number." data-val-required="The NILAI_DISC_2 field is required." id="PesananDetail_NILAI_DISC_2" name="PesananDetail.NILAI_DISC_2" type="hidden" value="">');
                                $($trElement + ' .netto-barang').html('0,00' +
                                    '<input data-val="true" data-val-number="The field HARGA must be a number." data-val-required="The HARGA field is required." id="PesananDetail_HARGA" name="PesananDetail.HARGA" type="hidden" value="">');

                                $($trElement + ' .btn-primary').attr('disabled', 'disabled');

                                if ($('#Pesanan_RecNum').val() == null) {
                                    $('#Pesanan_NETTO').val(convertToRupiah(0));
                                    $('#Pesanan_BRUTO').val(convertToRupiah(0));
                                    $('#Pesanan_NILAI_DISC').val(convertToRupiah(0));
                                    $('#Pesanan_PPN').val(0);
                                    $('#Pesanan_NILAI_PPN').val(convertToRupiah(0));
                                    $('#Pesanan_ONGKOS_KIRIM').val(convertToRupiah(0));
                                } else {
                                    $('#Pesanan_BRUTO').val($beforeState.brutto);
                                    $('#Pesanan_NETTO').val($beforeState.netto);
                                    $('#Pesanan_NILAI_DISC').val($beforeState.ndisc);
                                    $('#Pesanan_PPN').val($beforeState.ppn);
                                    $('#Pesanan_NILAI_PPN').val($beforeState.nppn);
                                    $('#Pesanan_ONGKOS_KIRIM').val($beforeState.ongkir);
                                }

                                onTab();
                                modeEditOff();
                                refreshNettoBarang('0');
                            }
                        });

                        if ($('#BRG').selectivity('value') != null) {
                            $('#BRG').trigger('change');
                        }
                    },
                    error: function(xhr) {
                        console.log(xhr);
                    }
                });

            }
        }

        function modeEditOff() {
            $('#table_tambah_pesanan > tbody > tr > td.editable').prop('contentEditable', false);
            $('#table_tambah_pesanan > tbody > tr > td.editable').prop('onclick', null).off('click');
            $('.qty-barang').removeClass('editable');
            $('.disc1-barang').removeClass('editable');
            $('.disc2-barang').removeClass('editable');
            $('.ndisc1-barang').removeClass('editable');
            $('.ndisc2-barang').removeClass('editable');
        }

        function convertToRupiah(angka) {
            //change by calvin 26 september 2018
            //var rupiah = '';
            //var angkarev = angka.toString().split('').reverse().join('');
            //for (var i = 0; i < angkarev.length; i++) if (i % 3 === 0) rupiah += angkarev.substr(i, 3) + '.';
            //return rupiah.split('', rupiah.length - 1).reverse().join('') + ',00';
            return $.number(angka, 2, ',', '.');
            //end change by calvin 26 september 2018
        }

        function convertToAngka(rupiah) {

            //change by calvin 26 september 2018
            //return parseInt(rupiah.replace(/,.*|[^0-9]/g, ''), 10);
            return parseFloat(rupiah.replaceAll('.', '').replaceAll(',', '.'));
            //end change by calvin 26 september 2018
        }

        function editPesanan1(idPesanan) {
            var link = '@Url.Action("EditPesanan", "Manage", new {orderId = "replaceId"})';
            link = link.replace("replaceId", idPesanan);

            $.ajax({
                type: "GET",
                url: link,
                beforeSend: function() {
                    $('#loading_spinner').show();
                },
                success: function(response) {
                    $('#form-partial').html(response);
                    $totalAwal = convertToAngka($('#Pesanan_BRUTO').val());
                    refreshInputan();
                    getTanggal();
                    getBuyer();
                    getDataBarang();
                    getMarketplace();
                    getExpedisi();
                    $('#tambah_pesanan').click();
                    $nettoSebelumnya += $bakalNetto;
                    $('#loading_spinner').hide();
                    $('#btn-simpan-perubahan-row').hide();
                },
                error: function(xhr, status, error) {
                    console.log(error);
                }
            });
        }

        function pass(idPesanan, nobuk) {
            this.$idPesanan = idPesanan;
            this.$nobukPesanan = nobuk;
        }

        function deletePesanan() {
            var link = '@Url.Action("DeletePesanan", "Manage", new {orderId = "replaceId"})';
            link = link.replace("replaceId", this.$idPesanan);

            $.ajax({
                type: "GET",
                url: link,
                success: function() {
                    refreshTablePesanan();
                    $('#konfHapusPesanan').modal('hide');
                },
                error: function(xhr, status, error) {
                    console.log(error);
                }
            });
        }

        var $brg = '';

        function passBarangInDb($brg) {
            this.$brg = $brg;
        }

        function deleteBarang() {
            var link = '@Url.Action("DeleteBarangPesanan", "Manage", new {noUrut = "replaceBrgId"})';
            link = link.replace("replaceBrgId", this.$brg);

            $.ajax({
                type: "GET",
                url: link,
                contentType: 'application/json',
                cache: false,
                beforeSend: function() {
                    $('#loading_spinner').show();
                },
                success: function(response) {
                    refreshNettoBarang();
                    $nettoSebelumnya = 0;
                    $bakalNetto = 0;
                    $('#form-partial').html(response);

                    //add by nurul 5/10/2018
                    refreshInputan();
                    refreshNetto();
                    //end add

                    $totalAwal = convertToAngka($('#Pesanan_BRUTO').val());
                    getTanggal();
                    getMarketplace();
                    getExpedisi();
                    getBuyer();
                    getDataBarang();
                    $('#konfHapusBarang').modal('hide');
                    $('#loading_spinner').hide();
                },
                error: function(xhr) {
                    console.log(xhr);
                }
            });
        }

        function refreshTablePesanan() {
            var link = '@Url.Action("RefreshTablePesanan", "Manage")';

            $.ajax({
                type: "GET",
                url: link,
                beforeSend: function() {
                    $('#datatable').hide();
                    $('#loading_pesanan_tab').show();
                },
                success: function(response) {
                    $('#tambah_pesanan').remove();
                    $('#table-pesanan-partial').html(response);
                    var table = $('#datatable').DataTable({
                        "order": [[0, 1, "desc"]], //or asc
                        "columnDefs": [{ "targets": 1, "type": "date-eu" }],
                    });
                    $('#search_pesanan').keyup(function() {
                        table.search($(this).val()).draw();
                    });
                    $('#loading_pesanan_tab').hide();
                    cekJumlahPesananBulanIni();
                    $('#datatable').show();
                },
                error: function(xhr, status, error) {
                    console.log(error);
                }
            });
        }

        function refreshTableSudahDibayar() {
            var link = '@Url.Action("RefreshTablePesananSudahDibayar", "Manage")';

            $.ajax({
                type: "GET",
                url: link,
                beforeSend: function() {
                    $('#datatable_nunggu').hide();
                    $('#loading_sudah_dibayar_tab').show();
                },
                success: function(response) {
                    $('#table-pesanan-sudah-dibayar-partial').html(response);
                    var table = $('#datatable_nunggu').DataTable({
                        "order": [[0, 1, "desc"]], //or asc
                        "columnDefs": [{ "targets": 1, "type": "date-eu" }],
                    });
                    $('#search_nunggu').keyup(function() {
                        table.search($(this).val()).draw();
                    });
                    $('#loading_sudah_dibayar_tab').hide();
                    $('#datatable_nunggu').show();
                },
                error: function(xhr, status, error) {
                    console.log(error);
                }
            });
        }

        function refreshTableSiapKirim() {
            var link = '@Url.Action("RefreshTablePesananSiapKirim", "Manage")';

            $.ajax({
                type: "GET",
                url: link,
                beforeSend: function() {
                    $('#datatable_sedangproses').hide();
                    $('#loading_siap_kirim_tab').show();
                },
                success: function(response) {
                    $('#table-pesanan-siap-kirim-partial').html(response);
                    var table = $('#datatable_sedangproses').DataTable({
                        "order": [[0, 1, "desc"]], //or asc
                        "columnDefs": [{ "targets": 1, "type": "date-eu" }],
                    });
                    $('#search_sedangproses').keyup(function() {
                        table.search($(this).val()).draw();
                    });
                    $('#loading_siap_kirim_tab').hide();
                    $('#datatable_sedangproses').show();
                },
                error: function(xhr, status, error) {
                    console.log(error);
                }
            });
        }

        function refreshTableSudahKirim() {
            var link = '@Url.Action("RefreshTablePesananSudahKirim", "Manage")';

            $.ajax({
                type: "GET",
                url: link,
                beforeSend: function() {
                    $('#datatable_sudahkirim').hide();
                    $('#loading_sudah_kirim_tab').show();
                },
                success: function(response) {
                    $('#table-pesanan-sudah-kirim-partial').html(response);
                    var table = $('#datatable_sudahkirim').DataTable({
                        "order": [[0, 2, "desc"]], //or asc
                        "columnDefs": [{ "targets": 2, "type": "date-eu" }],
                    });
                    $('#search_sudahkirim').keyup(function() {
                        table.search($(this).val()).draw();
                    });
                    $('#loading_sudah_kirim_tab').hide();
                    $('#datatable_sudahkirim').show();
                },
                error: function(xhr, status, error) {
                    console.log(error);
                }
            });
        }

        function refreshTableSelesai() {
            var link = '@Url.Action("RefreshTablePesananSelesai", "Manage")';

            $.ajax({
                type: "GET",
                url: link,
                beforeSend: function() {
                    $('#datatable_selesai').hide();
                    $('#loading_selesai_tab').show();
                },
                success: function(response) {
                    $('#table-pesanan-selesai-partial').html(response);
                    var table = $('#datatable_selesai').DataTable({
                        "order": [[0, 2, "desc"]], //or asc
                        "columnDefs": [{ "targets": 2, "type": "date-eu" }],
                    });
                    $('#search_selesai').keyup(function() {
                        table.search($(this).val()).draw();
                    });
                    $('#loading_selesai_tab').hide();
                    $('#datatable_selesai').show();
                },
                error: function(xhr, status, error) {
                    console.log(error);
                }
            });
        }

        function refreshTableCancel() {
            var link = '@Url.Action("RefreshTablePesananCancel", "Manage")';

            $.ajax({
                type: "GET",
                url: link,
                beforeSend: function() {
                    $('#datatable_cancel').hide();
                    $('#loading_cancel_tab').show();
                },
                success: function(response) {
                    $('#table-pesanan-cancel-partial').html(response);
                    var table = $('#datatable_cancel').DataTable({
                        "order": [[0, 1, "desc"]], //or asc
                        "columnDefs": [{ "targets": 1, "type": "date-eu" }],
                    });
                    $('#search_cancel').keyup(function() {
                        table.search($(this).val()).draw();
                    });
                    $('#loading_cancel_tab').hide();
                    $('#datatable_cancel').show();
                },
                error: function(xhr, status, error) {
                    console.log(error);
                }
            });
        }

        function refreshForm1() {
            var link = '@Url.Action("RefreshPesananForm", "Manage")';

            $.ajax({
                type: "GET",
                url: link,
                success: function(response) {
                    $('#form-partial').html(response);
                    refreshInputan();
                    getTanggal();
                    getMarketplace();
                    getExpedisi();
                    getBuyer();
                    getDataBarang();
                },
                error: function(xhr, status, error) {
                    console.log(error);
                }
            });
        }

        function passRecResi(rec) {
            this.$recResi = rec;
            getResi(rec);
        }

        function getBarangForGudangQty(nobuk) {
            var link = '@Url.Action("RefreshGudangQtyPesanan", "Manage", new {noBuk = "replaceNoBuk"})';
            link = link.replace("replaceNoBuk", nobuk);

            $.ajax({
                type: "GET",
                url: link,
                contentType: 'application/json',
                cache: false,
                success: function(response) {
                    $('#modal-gudang-qty-body').html(response);

                    $('#modal-gudang-qty-body div[data-jenis="gudang"]').each(function() {
                        var $this = $(this);
                        var $recNum = $this.attr('data-recnum');

                        $('#Gudang-Dropdown-' + $recNum).selectivity({
                            allowClear: true,
                            items: $listGudang,
                            placeholder: 'Harap pilih'
                        }).selectivity('value', $('#Gudang-' + $recNum).val()).change(function() {
                            var $val = $(this).selectivity('value');
                            $('#Gudang-' + $recNum).val($val);
                        }).click(function() {
                            var $offsetTop = $this.offset().top;
                            $this.find('.selectivity-dropdown').css('top', $offsetTop + 10);
                        });

                        $('#modal-gudang-qty-body #Qty-' + $recNum).change(function() {
                            var $valMax = $('#modal-gudang-qty-body #Max-Qty-' + $recNum).val();
                            if ($(this).val() > $valMax) {
                                $(this).val($valMax);
                                alert('Qty kirim tidak boleh melebihi qty pesanan!');
                            }
                        });
                    });

                    $('input[data-jenis="gudang_siap_kirim"]').each(function() {
                        if ($(this).val() != ' ') {
                            $readyToShip = true;
                        } else {
                            $readyToShip = false;
                        }
                    });

                    console.log($readyToShip);
                },
                error: function(xhr) {
                    console.log(xhr);
                }
            });
        }

        function unacceptablePesanan() {
            alert('Buat faktur terlebih dahulu!');
        }

        function unundoablePesanan() {
            alert('Hapus faktur pesanan ini pada halaman penjualan terlebih dahulu sebelum melakukan UNDO STATUS!');
        }

        function saveGudangQty() {
            var $isSuccess = 0;
            var ret = 0;
            var jmlgd = 0;

            $('#modal-gudang-qty-body div[data-jenis="gudang"]').each(function() { jmlgd++; });

            $('#modal-gudang-qty-body div[data-jenis="gudang"]').each(function() {
                var $this = $(this);
                var $recNum = $this.attr('data-recnum');

                if ($('#Qty-' + $recNum).val().trim() == "0") {
                    if (!$('#Qty-' + $recNum).closest('div').find('.text-danger').length) {
                        if ($('#Qty-' + $recNum).closest('div').hasClass('input-group')) {
                            $('#Qty-' + $recNum).parent().parent()
                                .append('<span class="text-danger">Quantity tidak boleh 0!</span>');
                        } else {
                            $('#Qty-' + $recNum).closest('div')
                                .append('<span class="text-danger">Quantity tidak boleh 0!</span>');
                        }
                    }
                    return false;
                } else {
                    if ($('#Qty-' + $recNum).closest('div').find('.text-danger').length) {
                        $('#Qty-' + $recNum).closest('div').find('.text-danger').remove();
                    }
                }
                if ($('#Gudang-' + $recNum).val().trim() == "") {
                    if (!$('#Gudang-' + $recNum).closest('div').find('.text-danger').length) {
                        if ($('#Gudang-' + $recNum).closest('div').hasClass('input-group')) {
                            $('#Gudang-' + $recNum).parent().parent()
                                .append('<span class="text-danger">Gudang harus diisi!</span>');
                        } else {
                            $('#Gudang-' + $recNum).closest('div')
                                .append('<span class="text-danger">Gudang harus diisi!</span>');
                        }
                    }
                    return false;
                } else {
                    if ($('#Gudang-' + $recNum).closest('div').find('.text-danger').length) {
                        $('#Gudang-' + $recNum).closest('div').find('.text-danger').remove();
                    }
                }

                var link =
                    '@Html.Raw(Url.Action("SaveGudangQty", "Manage", new {recNum = "replaceRecNum", gd = "replaceGudang", qty = "replaceQty"}))';
                link = link.replace("replaceRecNum", $recNum);
                link = link.replace("replaceGudang", $('#Gudang-' + $recNum).val());
                link = link.replace("replaceQty", $('#Qty-' + $recNum).val());

                $.ajax({
                    type: "GET",
                    url: link,
                    contentType: 'application/json',
                    cache: false,
                    success: function(response) {
                        if (response.Errors == null) {
                            $isSuccess++;
                            //if ($isSuccess < 1) {
                            if ($isSuccess == jmlgd) {
                                refreshTableSiapKirim();
                                alert('Data berhasil disimpan!');
                                $('#modalGudangDanQty').modal('hide');
                            }
                        } else {
                            alert(response.Errors);
                            $('#loading_spinner').hide();
                        }
                    },
                    error: function(xhr) {
                        console.log(xhr);
                    }
                });
            });


        }

        function getGudang() {
            $.ajax({
                type: "GET",
                url: '@Url.Action("GetGudang", "Manage")',
                contentType: 'application/json',
                cache: false,
                success: function(data) {
                    $.each(data,
                        function(i, item) {
                            $listGudang[i] = {
                                id: item.Kode_Gudang,
                                text: item.Nama_Gudang
                            };
                        });
                },
                error: function(xhr) {
                    console.log(xhr);
                }
            });
        }

        //ADD BY TRI 10 AUG 2018, SHOW/HIDE DELIVERY PROVIDER FOR LAZADA + PROMPT
        function showShipment(NamaMarket, cust) {
            $('#lblShipment').remove();
            $('#txtShipment').remove();
            $('#txtShipmentBL').remove();
            $('#btnShipment').remove();

            if (NamaMarket.toUpperCase() == "LAZADA") {
                $('#divLblShip').append('<label id="lblShipment">Shipment Provider</label>');
                $('#divTextShip')
                    .append(
                        '<input id="txtShipment" disabled="disabled" required="required" class="form-control"></input>');
                $('#divBtnShip')
                    .append(
                        '<button id="btnShipment" class="btn btn-default" type="button" style="height: 34px;" onclick="PromptDeliveryProvLazada(\'' +
                        cust +
                        '\')"><span class="glyphicon glyphicon-option-horizontal"></span></button>');
            } else if (NamaMarket.toUpperCase() == "BUKALAPAK") {
                $('#divLblShip').append('<label id="lblShipment">Shipment Provider</label>');
                $('#divTextShip').append('<input id="txtShipmentBL" class="form-control"></input>');
            }

        }

        //var PromptDeliveryProvLazadaTextBox = "";
        function PromptDeliveryProvLazada(r) {
            //PromptDeliveryProvLazadaTextBox = i;
            showPromptDeliveryProvLazadaTextBoxWindow(r);
        }

        function showPromptDeliveryProvLazadaTextBoxWindow(val) {
            var $link = '@Url.Action("PromptDeliveryProviderLazada", "Manage", new {cust = "replaceCust"})';
            $link = $link.replace("replaceCust", val);
            window.open($link, "popupWindow", "width=600, height=400, scrollbars=yes");
        }

        function afterPromptDelTempLzd(val) {
            $('#txtShipment').val(val);
            $('#Pesanan_SHIPMENT').val(val);

            //$('#ListHargaJualPermarket_' + PromptDeliveryProvLazadaTextBox + '__DeliveryProvLazada').val(val);
        }

        function cekValidasi() {
            var ret = true;
            if (document.getElementById("txtShipment") != null) {
                if ($("#Pesanan_SHIPMENT").val() == undefined || $("#Pesanan_SHIPMENT").val() == '') {
                    alert("Shipment Provider harus diisi.");
                    ret = false;
                    $("#btnShipment").focus();
                }
            }
            return ret;
        }
        //END ADD BY TRI 10 AUG 2018, SHOW/HIDE DELIVERY PROVIDER FOR LAZADA + PROMPT

        function getResi(rec) {
            var link = '@Url.Action("GetResi", "Manage", new {recNum = "replaceRecNum"})';
            link = link.replace("replaceRecNum", rec);

            $.ajax({
                type: "GET",
                url: link,
                contentType: 'application/json',
                cache: false,
                success: function(response) {
                    $('#Pesanan_TRACKING_SHIPMENT').val(response[0]);
                    $('#txtShipment').val(response[1]);
                    $('#Pesanan_SHIPMENT').val(response[1]);

                },
                error: function(xhr) {
                    console.log(xhr);
                }
            });
        }

        function saveResi() {
            if (cekValidasi()) {
                //var link = '@Html.Raw(Url.Action("SaveResi", "Manage", new {recNum = "replaceRecNum", noResi = "replaceResi"}))';
                var link =
                    '@Html.Raw(Url.Action("SaveResi", "Manage", new {recNum = "replaceRecNum", noResi = "replaceResi", deliveryProv = "replaceDeliveryProv"}))';
                link = link.replace("replaceRecNum", this.$recResi);
                link = link.replace("replaceResi", $('#Pesanan_TRACKING_SHIPMENT').val());
                if (document.getElementById("txtShipment") != null) {
                    link = link.replace("replaceDeliveryProv",
                        $('#txtShipment').val() == undefined ? '' : $('#txtShipment').val());
                } else if (document.getElementById("txtShipmentBL") != null) {
                    link = link.replace("replaceDeliveryProv",
                        $('#txtShipmentBL').val() == undefined ? '' : $('#txtShipmentBL').val());

                }
                $.ajax({
                    type: "GET",
                    url: link,
                    contentType: 'application/json',
                    cache: false,
                    success: function() {
                        $('#modalIsiResi').modal('hide');
                        refreshTableSiapKirim();
                    },
                    error: function(xhr) {
                        console.log(xhr);
                    }
                });
            }
        }

        function passRecStatus(rec, status, nobuk) {
            this.$recPesanan = rec;
            this.$statusPesanan = status;
            this.$nobukPesanan = nobuk;

            getBarangForGudangQty($nobukPesanan);

            if (status == '04') {
                getResi(rec);
            }

        }

        function ubahStatusPesanan() {
            //if ($('#Pesanan_TRACKING_SHIPMENT').val() == '' && $statusPesanan == '03') {
            //    alert('Isi nomor resi terlebih dahulu!');
            //    return;
            //}

            if ($readyToShip == false && $statusPesanan == '03') {
                alert('Isi semua gudang / qty terlebih dahulu!');
                return;
            }

            if ($statusPesanan == '03-undo')
                $statusPesanan = '03';

            var link =
                '@Html.Raw(Url.Action("UbahStatusPesanan", "Manage", new {recNum = "replaceRecNum", tipeStatus = "replaceStatus"}))';
            link = link.replace("replaceRecNum", this.$recPesanan);
            link = link.replace("replaceStatus", this.$statusPesanan);

            $.ajax({
                type: "GET",
                url: link,
                contentType: 'application/json',
                cache: false,
                success: function(response) {
                    if (response.Errors == null) {
                        if ($statusPesanan == '01') {
                            refreshTableSiapKirim();
                            refreshTablePesanan();
                            refreshTableCancel();
                            refreshTableSudahDibayar();
                        } else if ($statusPesanan == '02' || $statusPesanan == '11') {
                            refreshTableSudahDibayar();
                            refreshTableSudahKirim();
                            $('#konfBatalPesanan').modal('hide');
                        } else if ($statusPesanan == '03' || $statusPesanan == '03-undo') {
                            refreshTableSiapKirim();
                            refreshTableSelesai();
                        } else if ($statusPesanan == '04') {
                            refreshTableSudahKirim();
                        }
                    } else {
                        //console.log(response.Errors);
                        alert(response.Errors[0]);
                    }
                    $('#konfUbahStatus').modal('hide');
                    //add by nurul 
                    $('#konfUbahStatusDibayar').modal('hide');
                    $('#konfUbahStatusSiapkirim').modal('hide');
                    $('#konfUbahStatusSudahkirim').modal('hide');
                    $('#konfUndoStatusSiapkirim').modal('hide');
                    $('#konfUndoStatusSudahkirim').modal('hide');
                    $('#konfUndoStatusSelesai').modal('hide');
                    $('#konfUndoStatusBatal').modal('hide');
                    //end add 

                },
                error: function(xhr) {
                    console.log(xhr);
                }
            });
        }

        function buatFaktur(rec) {
            var link =
                '@Html.Raw(Url.Action("GenerateFaktur", "Manage", new {recNumPesanan = "replaceRecNum", uname = "replaceUname"}))';
            link = link.replace("replaceRecNum", rec);
            link = link.replace("replaceUname", $('#Pesanan_USER_NAME').val());

            $.ajax({
                type: "GET",
                url: link,
                contentType: 'application/json',
                cache: false,
                beforeSend: function() {
                    $('#loading_spinner').show();
                },
                success: function(response) {
                    alert('Faktur berhasil dibuat');
                    refreshTableSudahKirim();
                    $('#loading_spinner').hide();
                    lihatFaktur(response); // No Faktur as Response
                },
                error: function(xhr) {
                    console.log(xhr);
                }
            });
        }

        function lihatFaktur(nobuk) {
            var link = '@Url.Action("LihatFaktur", "Manage", new {noBukPesanan = "replaceNoBuk"})';
            link = link.replace('replaceNoBuk', nobuk);

            var win = window.open(link, '_blank');
            if (win) {
                win.focus();
            } else {
                alert('Please allow popups for this website');
            }
        }

        function lihatPesanan(idPesanan) {
            var link = '@Url.Action("LihatPesanan", "Manage", new {orderId = "replaceId"})';
            link = link.replace("replaceId", idPesanan);

            $.ajax({
                type: "GET",
                url: link,
                beforeSend: function() {
                    $('#loading_spinner').show();
                },
                success: function(response) {
                    $('#form-partial-selesai').html(response);
                    $('#see_tgl_pesanan').removeAttr('style');
                    //$('#see_marketplace_pesanan').val($('#Pesanan_CUST').val()).show();
                    //$('#see_expedisi_pesanan').val($('#Pesanan_EXPEDISI').val()).show();
                    //$('#see_pembeli_pesanan').val($('#Pesanan_NAMAPEMESAN').val()).show();
                    $('#TGL').parent().hide();
                    $('.pesanan_selesai_section').hide();
                    $('.pesanan_editor_selesai_section').show();
                    $('#loading_spinner').hide();
                },
                error: function(xhr, status, error) {
                    console.log(error);
                }
            });

            @*var link = '@Url.Action("LihatFaktur", "Manage", new { noBukPesanan = "replaceNoBuk" })';
            link = link.replace('replaceNoBuk', nobuk);

            var win = window.open(link, '_blank');
            if (win) {
                win.focus();
            } else {
                alert('Please allow popups for this website');
            }*@
        }

        function lihatPesananSudahDibayar(idPesanan) {
            var link = '@Url.Action("LihatPesanan", "Manage", new {orderId = "replaceId"})';
            link = link.replace("replaceId", idPesanan);

            $.ajax({
                type: "GET",
                url: link,
                beforeSend: function() {
                    $('#loading_spinner').show();
                },
                success: function(response) {
                    $('#form-partial-sudah-dibayar').html(response);
                    $('#see_tgl_pesanan').removeAttr('style');
                    //$('#see_marketplace_pesanan').val($('#Pesanan_CUST').val()).show();
                    //$('#see_expedisi_pesanan').val($('#Pesanan_EXPEDISI').val()).show();
                    //$('#see_pembeli_pesanan').val($('#Pesanan_NAMAPEMESAN').val()).show();
                    $('#TGL').parent().hide();
                    $('.pesanan_sudah_dibayar_section').hide();
                    $('.pesanan_editor_sudah_dibayar_section').show();
                    $('#loading_spinner').hide();
                },
                error: function(xhr, status, error) {
                    console.log(error);
                }
            });

            @*var link = '@Url.Action("LihatFaktur", "Manage", new { noBukPesanan = "replaceNoBuk" })';
            link = link.replace('replaceNoBuk', nobuk);

            var win = window.open(link, '_blank');
            if (win) {
                win.focus();
            } else {
                alert('Please allow popups for this website');
            }*@
        }

        function validasiTambahan() {
            var $isValid = true;
            var $this = $('tr[data-pesanan-id="0"] .qty-barang');
            if ($this.text().trim() == "0") {
                if (!$this.closest('div').find('.text-danger').length) {
                    if ($this.closest('div').hasClass('input-group')) {
                        $this.parent().parent().append('<span class="text-danger">Quantity tidak boleh 0!</span>');
                    } else {
                        $this.closest('div').append('<span class="text-danger">Quantity tidak boleh 0!</span>');
                    }
                    $isValid = false;
                }
            } else {
                if ($this.closest('div').find('.text-danger').length) {
                    $this.closest('div').find('.text-danger').remove();
                }
            }
            //add by nurul 3/10/2018
            if ($('#Pesanan_TERM').val() != '' && $('#Pesanan_TGL_JTH_TEMPO').val() == 'Masukkan TOP dahulu') {
                var $tgl = moment($('#Pesanan_TGL').val(), "DD/MM/YYYY");
                var $tglTop = $tgl.add($('#Pesanan_TERM').val(), 'days');
                $('#Pesanan_TGL_JTH_TEMPO').val($tglTop.format('DD/MM/YYYY'));
            }
            //end add
            return $isValid;

        }

        function simpanbrg($id) {
            if (!validateForm()) return false;
            if (!validasiTambahan()) return false;

            if ($id == 'brg-0') {
                if ($('#Pesanan_TGL').val() != '' &&
                    $('#Pesanan_CUST').val() != '' &&
                    $('#Pesanan_TERM').val() != '' &&
                    $('#Pesanan_EXPEDISI').val() != '' &&
                    $('#Pesanan_NAMAPEMESAN').val() != ''
                ) {
                    var tgl = $('#Pesanan_TGL').val();
                    $('#PesananDetail_TGL_INPUT').val(tgl);
                    $('#PesananDetail_BRG').val($('#BRG').selectivity('val'));
                    $('#PesananDetail_SATUAN').val('2');
                    $('#PesananDetail_H_SATUAN').val(convertToAngka($('tr[data-pesanan-id="0"] .harga-barang').text()));
                    $('#PesananDetail_QTY').val($('tr[data-pesanan-id="0"] .qty-barang').text());
                    $('#PesananDetail_DISCOUNT').val(convertToAngka($('tr[data-pesanan-id="0"] .disc1-barang').text()));
                    $('#PesananDetail_DISCOUNT_2')
                        .val(convertToAngka($('tr[data-pesanan-id="0"] .disc2-barang').text()));
                    $('#PesananDetail_NILAI_DISC_1')
                        .val(convertToAngka($('tr[data-pesanan-id="0"] .ndisc1-barang').text()));
                    $('#PesananDetail_NILAI_DISC_2')
                        .val(convertToAngka($('tr[data-pesanan-id="0"] .ndisc2-barang').text()));
                    $('#PesananDetail_HARGA').val(convertToAngka($('tr[data-pesanan-id="0"] .netto-barang').text()));
                    $("#Pesanan_BRUTO").val(convertToAngka($("#Pesanan_BRUTO").val()));
                    $("#Pesanan_NILAI_DISC").val(convertToAngka($("#Pesanan_NILAI_DISC").val()));
                    $("#Pesanan_NILAI_PPN").val(convertToAngka($("#Pesanan_NILAI_PPN").val()));
                    $("#Pesanan_NETTO").val($bakalNetto);
                    $("#Pesanan_ONGKOS_KIRIM").val(convertToAngka($("#Pesanan_ONGKOS_KIRIM").val()));

                    $totalAwal = 0;

                    $.ajax({
                        type: "POST",
                        url: '@Url.Action("SavePesanan", "Manage")',
                        data: $('#form-pesanan').serialize(),
                        beforeSend: function() {
                            $('#loading_spinner').show();
                        },
                        success: function(response) {
                            console.log(response);
                            $('#form-partial').html(response);
                            $nettoSebelumnya = parseInt(convertToAngka($('#Pesanan_NETTO').val()));
                            refreshInputan();
                            getTanggal();
                            getMarketplace();
                            getExpedisi();
                            getBuyer();
                            getDataBarang();
                            $('#loading_spinner').hide();
                        },
                        error: function(xhr) {
                            console.log(xhr);
                            $('#loading_spinner').hide();
                        }
                    });
                } else {
                    alert('Silakan isi semua field terlebih dahulu!');
                }
            }
        }
    </script>
    <script>
        //Disable Enter Key Submit Form
        function stopRKey(evt) {
            var evt = (evt) ? evt : ((event) ? event : null);
            var node = (evt.target) ? evt.target : ((evt.srcElement) ? evt.srcElement : null);
            if ((evt.keyCode === 13) && (node.type === "text")) {
                return false;
            }
        }

        document.onkeypress = stopRKey;
    </script>
    }