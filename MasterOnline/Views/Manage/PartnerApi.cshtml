@using System.Globalization
@using MasterOnline.ViewModels
@model MasterOnline.ViewModels.PartnerApiViewModel
@{ ViewBag.Title = "Link Partner API";
    Layout = "~/Views/Shared/_LayoutManage.cshtml";

    var editMode = 0;

    if (ViewData["Editing"] != null)
    {
        editMode = (int)ViewData["Editing"];
    }

    var sessionAccount = HttpContext.Current.Session["SessionAccount"];
    var sessionUser = System.Web.HttpContext.Current.Session["SessionUser"];

    var context = new MoDbContext("");

    //var statusAddOnsAol = Model?.statusAddonsAol;
    var timeText = Model?.timeSchedule1;
    //var dataSession = Session["SessionInfo"] as AccountUserViewModel;

    //var username = "";
    //long accId;
    //if (dataSession?.User != null)
    //{
    //    accId = context.User.Single(u => u.Email == dataSession.User.Email).AccountId;
    //    username = context.Account.Single(a => a.AccountId == accId).Username;
    //}
    //else
    //{
    //    username = dataSession?.Account?.Username;
    //    accId = (dataSession?.Account?.AccountId ?? 0);
    //}
    //if (username.Length > 20)
    //{
    //    username = username.Substring(0, 17) + "...";
    //}
}

@section styles
{
    <link href="~/Content/build/css/bootstrap-datepicker.min.css" rel="stylesheet" />
    <link href="~/Content/build/css/selectivity-jquery.min.css" rel="stylesheet" />
    <link href="~/Content/selectize.css" rel="stylesheet" />
    <style>
        #akun-section {
            margin-top: 60px;
            background: white;
            padding: 20px;
        }

        .disabled-tab {
            cursor: not-allowed;
            background-color: #999 !important;
            color: #fff;
        }

            .disabled-tab:hover,
            .disabled-tab:active,
            .disabled-tab:visited {
                color: #fff;
            }
    </style>
}

<div class="row" id="partner-api-section">
    <div class="col-lg-12 col-md-12">
        <div class="row partner_api_table_section">
            <div class="col-lg-4 col-sm-6">
                <div class="input-group">
                    <input id="search_addons" type="text" class="form-control" placeholder="Pencarian">
                    <span class="input-group-btn">
                        <button type="button" class="btn btn-primary">
                            <i class="fa fa-search"></i>
                        </button>
                    </span>
                </div>
            </div>
            <div class="col-lg-8 col-sm-6">
                <div class="pull-right">
                    <button type="button" class=" btn btn-default" data-style="expand-right" onclick="location.reload();">
                        <span>Refresh</span>
                    </button>
                    <button class="btn btn-primary btn_tambah_data" id="tambah_partner_api">Tambah Baru</button>
                </div>
            </div>
        </div>
        <div class="row partner_api_table_section">
            <div class="col-sm-12">
                @if (ViewData["SuccessMessage"] != null)
                {
                    <div class="alert alert-success">
                        @ViewData["SuccessMessage"].ToString()
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                }
                @if (ViewData.ModelState.Any(x => x.Value.Errors.Any()))
                {
                    foreach (var modelError in ViewData.ModelState.SelectMany(x => x.Value.Errors))
                    {
                        <div class="alert alert-danger">
                            @modelError.ErrorMessage
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                    }
                }
                <table id="datatable" class="table table-striped table-bordered dataTable" role="grid" aria-describedby="datatable_info">
                    <thead>
                        <tr role="row">
                            <th class="sorting text-center" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" style="width: 30px;">Nama Partner</th>
                            <th class="sorting text-center" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" style="width: 40px;">Host</th>
                            <th class="sorting text-center" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" style="width: 30px;">Link Partner</th>
                            <th class="sorting text-center" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" style="width: 40px; max-width: 40px;">Edit</th>
                            @*<th class="sorting text-center" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" style="width: 40px; max-width: 40px;">Hapus</th>*@
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null)
                        {
                            foreach (var partnerapi in Model.ListPartnerApi)
                            {
                                <tr>
                                    <td>@partnerapi.Nama_Partner</td>
                                    <td>@partnerapi.Host</td>
                                    <td>
                                        @if (partnerapi.Status == true)
                                        {
                                            <text><center>Aktif</center></text>
                                        }
                                        else
                                        {
                                            <text><center>Tidak Aktif</center></text>
                                        }
                                    </td>
                                    <td class="edit-hapus-col">
                                        <button class="btn btn-primary" onclick="editPartnerApi(@partnerapi.fs_id)">
                                            <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
                                        </button>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
        <div class="row partner_api_editor_section" style="display: none;">
            <div class="col-lg-12">
                <div class="page-editor">
                    <h2 class="editor-title">Link Partner API</h2>
                    <span class="title-accent"></span>
                    <button id="partner-api-close-editor" type="button" class="pull-right page-close">
                        <span class="close-btn thick"></span>
                    </button>
                    <div class="form-horizontal">
                        <div class="row">
                            <div class="col-md-12 col-sm-12 col-xs-12">
                                <div class="" role="tabpanel" data-example-id="togglable-tabs">
                                    <ul id="partnerApiTab" class="nav nav-tabs" role="tablist">
                                        <li role="presentation" class="active">
                                            <a href="#tab_content_partner_api" id="partner-api-tab" role="tab" data-toggle="tab" aria-expanded="true">Partner API</a>
                                        </li>
                                        <li role="presentation" class="">
                                            <a href="#tab_content_pengaturan" id="pengaturan-tab" role="tab" data-toggle="tab" aria-expanded="false">Pengaturan API</a>
                                        </li>
                                    </ul>
                                    <div id="PembeliTabContent" class="tab-content" style="padding-top:10px">
                                        <div role="tabpanel" class="tab-pane fade active in" id="tab_content_partner_api" aria-labelledby="partner-api-tab">
                                            <div class="row">
                                                <div class="col-md-12 col-sm-12 col-xs-12">
                                                    <div class="x_panel">
                                                        <div class="x_title">
                                                            <h2 style="font-size: 16px">Link Partner API</h2>
                                                            <ul class="nav navbar-right panel_toolbox">
                                                                <li>
                                                                    <a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                                                                </li>
                                                            </ul>
                                                            <div class="clearfix"></div>
                                                        </div>
                                                        <div class="x_content">
                                                            @if (ViewData.ModelState.Any(x => x.Value.Errors.Any()))
                                                            {
                                                                foreach (var modelError in ViewData.ModelState.SelectMany(x => x.Value.Errors))
                                                                {
                                                                    <div class="alert alert-danger">
                                                                        <span class="message-error">@modelError.ErrorMessage</span>
                                                                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                                                            <span aria-hidden="true">&times;</span>
                                                                        </button>
                                                                    </div>
                                                                }
                                                            }
                                                            <br>
                                                            @using (Html.BeginForm("SavePartnerApi", "Manage", FormMethod.Post, new { @autocomplete = "off", enctype = "multipart/form-data", id = "form-partnerapi" }))
                                                            {
                                                                @*<div id="form-partner-api">  *@
                                                                @*@Html.Partial("FormPartnerApiPartial")*@
                                                                @Html.HiddenFor(m => m.partner_api.fs_id)
                                                                <div class="form-group">
                                                                    @Html.LabelFor(m => m.partner_api.Nama_Partner, "Nama Partner*", new { @class = "control-label col-md-3 col-sm-3 col-xs-12" })
                                                                    <div class="col-md-6 col-sm-6 col-xs-12">
                                                                        @Html.HiddenFor(m => m.partner_api.PartnerId)
                                                                        @Html.HiddenFor(m => m.partner_api.Nama_Partner)
                                                                        <select id="Partner" placeholder="Harap Pilih"></select>
                                                                    </div>
                                                                </div>

                                                                <div class="form-group">
                                                                    <div id="divWebhook"></div>
                                                                    @Html.HiddenFor(m => m.partner_api.Status)
                                                                </div>

                                                                <div class="form-group">
                                                                    <div id="divSyncInv"></div>
                                                                    @Html.HiddenFor(m => m.partner_api.isFaktur)
                                                                </div>

                                                                <div class="form-group">
                                                                    <div id="divInvoice"></div>
                                                                    @Html.HiddenFor(m => m.partner_api.isPaid)
                                                                </div>

                                                                <div id="divUsername"></div>
                                                                <div id="divPassword"></div>
                                                                <div id="divProgramId"></div>
                                                                <div id="divWalletId"></div>

                                                                @*<div class="form-group">*@
                                                                @*<div id="divTADA"></div>*@
                                                                @*</div>*@

                                                                <div class="form-group">
                                                                    <div id="divSchedule"></div>
                                                                    @Html.HiddenFor(m => m.partner_api.Schedule1)
                                                                </div>

                                                                <hr />

                                                                <button type="button" id="simpan_btn" class="btn btn-primary pull-right" onclick="simpanPartnerApi(this)">Simpan</button>
                                                                @*</div>*@
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div role="tabpanel" class="tab-pane fade in" id="tab_content_pengaturan" aria-labelledby="pengaturan-tab">
                                            <div class="row">
                                                <div class="col-sm-12" id="table-link-bank-partner-api">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="konfHapusEkspedisi" tabindex="-1" role="dialog" aria-labelledby="konfHapusLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="konfHapusLabel">Konfirmasi</h4>
            </div>
            <div class="modal-body">
                <div class="row text-center">
                    <h4>Apakah Anda yakin ingin menghapus data ini?</h4>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Tidak</button>
                <button type="button" class="btn btn-success" onclick="deleteAddons()">Ya</button>
            </div>
        </div>
    </div>
</div>

@section scripts
{
    <script src="~/Content/build/js/bootstrap-datepicker.min.js" type="text/javascript"></script>
    <script src="~/Content/build/js/selectivity-jquery.min.js" type="text/javascript"></script>
    <script src="~/Content/selectize.js" type="text/javascript"></script>
    <script type="text/javascript">
        //var statusAddOns = @*@Html.Raw(Json.Encode(statusAddOnsAol))*@;
        var timeSch = @Html.Raw(Json.Encode(timeText));

        $addonsId = 0;
        $(document).on('ready', function () {
            $page = 0;
            Initialize();
        });

        function Initialize() {
            $('#search_pembeli').keypress(function (e) {
                var key = e.which;
                if (key == 13)// the enter key code
                {
                    searchTableBuyer();
                    return false;
                }
            });

            $('#search_addons').keyup(function () {
                    table.search($(this).val()).draw();
                });

            $('#tambah_partner_api').on('click', function () {
                //$('.partner_api_table_section').hide();
                //$('.partner_api_editor_section').show();
                //refreshTableApiLog();

                $('#pengaturan-tab').removeAttr('data-toggle');
                $('#pengaturan-tab').addClass('disabled-tab');

                //$('#pengaturan-tab').attr('data-toggle', 'tab');
                //$('#pengaturan-tab').removeClass('disabled-tab');

                editPartnerApi(0);
            });

            $('#partner-api-close-editor').on('click', function () {
                $('.partner_api_table_section').show();
                $('.partner_api_editor_section').hide();
                $('#pengaturan-tab').attr('data-toggle', 'tab');
                $('#pengaturan-tab').removeClass('disabled-tab');
                $('#partner_api_PartnerId, #partner_api_Nama_Partner, #partner_api_Status, #partner_api_Status, #partner_api_isPaid, #partner_api_Schedule1').val('');
                removeLabelTextbox();
                var ddlPartner = $('#Partner').selectize();
                ddlPartner[0].selectize.setValue(null, true);
                $('#form-partner-api').html('');

            });

            if ($('.message-error').text() !== '') {
                $('#tambah_pembeli').click();
            }

            //refreshTableApiLog();

            getPartner();
        }

        function simpanPartnerApi() {
            //if (statusAddOns == "1") {
                $("#partner_api_Status").val($("#api_status").val());
                $("#partner_api_isPaid").val($("#inv_status").val());
                $.ajax({
                    type: "POST",
                    url: '@Url.Action("SavePartnerApi", "Manage")',
                    data: $('#form-partnerapi').serialize(),
                    beforeSend: function () {
                        $('#loading_spinner').show();
                    },
                    success: function (response) {
                        if (response.mo_error != null) {
                            alert(response.mo_error);
                            location.href = '@Url.Action("PartnerApi")';
                        }
                        if (response.Errors == null) {
                            if (response.partner_id == 20007) {
                                if (response.status == 1) {
                                    var accAuthPopUp = window.open(response.mo_data, "Accurate Authentication", "width=1000, height=600, scrollbars=yes");
                                    var timer = setInterval(function () {
                                        if (accAuthPopUp.closed) {
                                            clearInterval(timer);
                                            $('#loading_spinner').hide();
                                            window.location.href = '@Url.Action("PartnerApi")';
                                        }
                                    }, 1000);
                                } else {
                                    $('#loading_spinner').hide();
                                    location.href = '@Url.Action("PartnerApi")';
                                }
                            } else if (response.partner_id == 30007) {
                                $('#loading_spinner').hide();
                                location.href = '@Url.Action("PartnerApi")';
                            }

                            @*var popupOauth = window.open(response, "Accurate Authentication", "width=1000, height=600, scrollbars=yes, resizable=no");
                            //self.window.close();
                            if (popupOauth.closed) {
                                    $('#loading_spinner').hide();
                                    window.location.href = '@Url.Action("PartnerApi")';
                                }*@
                        }
                        else {
                            alert(response.Errors[0]);
                            location.href = '@Url.Action("PartnerApi")';
                        }
                        //alert(response);
                    },
                    error: function (xhr, status, error) {
                        alert('Gagal link dengan partner. Silahkan hubungi support.');
                        $('#loading_spinner').hide();
                        location.href = '@Url.Action("PartnerApi")';
                        console.log(error);
                    }
                });
                return false;
            //} else if (statusAddOns == "2") {
            //    alert("Masa subscription anda sudah berakhir, untuk ketentuan lebih lanjut silahkan hubungi tim support.");
            //}
            //else {
            //    alert("Fitur ini termasuk fitur ADD ON, untuk ketentuan lebih lanjut silahkan hubungi tim support.");
            //}
        }

        function editPartnerApi(addonsId) {
            $modeEdit = 1;
            var link = '@Url.Action("EditPartnerApi", "Manage", new { fs_id = "replaceId" })';
            link = link.replace("replaceId", addonsId);

            $.ajax({
                async: true,
                type: "GET",
                contentType: 'application/json',
                url: link,
                success: function (response) {
                    //$('#form-partner-api').html(response);
                    $('.partner_api_table_section').hide();
                    $('.partner_api_editor_section').show();

                    debugger;
                    console.log(response);

                    if (response.partner_api != null) {
                        $('#partner_api_fs_id').val(response.partner_api.fs_id);
                        $('#partner_api_PartnerId').val(response.partner_api.PartnerId);
                        $('#partner_api_Nama_Partner').val(response.partner_api.Nama_Partner);
                        getPartner();

                        $('#partner_api_Status').val(response.partner_api.Status);
                        getWebhookCb();

                        if (response.partner_api.PartnerId == "20007") {
                            $('#partner_api_isPaid').val(response.partner_api.isPaid);
                            getInvoiceCb();
                            $('#partner_api_isFaktur').val(response.partner_api.isFaktur);
                            getSyncInvCb();
                        }
                        else if (response.partner_api.PartnerId == "30007") {
                            $('#pengaturan-tab').removeAttr('data-toggle');
                            $('#pengaturan-tab').addClass('disabled-tab');
                            getUsernameTb(response.partner_api.Username);
                            getPasswordTb(response.partner_api.Password);
                            getProgramIdTb(response.partner_api.ProgramId);
                            getWalletIdTb(response.partner_api.WalletId);
                            $('#partner_api_Schedule1').val(timeSch);
                            getScheduleCb();
                        }
                    }
                    refreshTableApiLog();
                },
                error: function (xhr, status, error) {
                    console.log(error);
                }
            });
        }

        function removeLabelTextbox() {
            $('#lbl_partner_api_Status').remove();
            $('#hd_partner_api_Status').remove();
            $('#lbl_partner_api_isPaid').remove();
            $('#hd_partner_api_isPaid').remove();
            $('#lbl_partner_api_isFaktur').remove();
            $('#hd_partner_api_isFaktur').remove();
            $('#lbl_partner_api_Username').remove();
            $('#tb_partner_api_Username').remove();
            $('#lbl_partner_api_Password').remove();
            $('#tb_partner_api_Password').remove();
            $('#lbl_partner_api_ProgramId').remove();
            $('#tb_partner_api_ProgramId').remove();
            $('#lbl_partner_api_WalletId').remove();
            $('#tb_partner_api_WalletId').remove();
            $('#lbl_partner_api_Schedule1').remove();
            $('#cb_partner_api_Schedule1').remove();
        }

        function getUsernameTb(resp) {
            $('#fg_partner_api_Username, #lbl_partner_api_Username, #tb_partner_api_Username').remove();
            //$('#lbl_partner_api_Username').remove();
            //$('#tb_partner_api_Username').remove();
            var valuetxtUsername = resp != null ? 'value="' + resp + '"' : "";
            var opendiv = '<div class="form-group" id="fg_partner_api_Username">';
            var closediv = '</div>';
            var labelUsername = '<label class="control-label col-md-3 col-sm-3 col-xs-12" for="partner_api_Username" id="lbl_partner_api_Username">Username</label>';
            var txtUsername = '<div id="tb_partner_api_Username" class="col-md-6 col-sm-6 col-xs-12"><input class="form-control" id="partner_api_Username" name="partner_api.Username" type="text" required="required" ' + valuetxtUsername + '></div>'; //value="' + valuetxtUsername + '"
            $('#divUsername').append(opendiv + labelUsername + txtUsername + closediv);
        }

        function getPasswordTb(resp) {
            $('#fg_partner_api_Password, #lbl_partner_api_Password, #tb_partner_api_Password').remove();
            var valuetxtPassword = resp != null ? 'value="' + resp + '"' : "";
            var opendiv = '<div class="form-group" id="fg_partner_api_Password">';
            var closediv = '</div>';
            var labelPassword = '<label class="control-label col-md-3 col-sm-3 col-xs-12" for="partner_api_Password" id="lbl_partner_api_Password">Password</label>';
            var txtPassword = '<div id="tb_partner_api_Password" class="col-md-6 col-sm-6 col-xs-12"><input class="form-control" id="partner_api_Password" name="partner_api.Password" type="password" required="required" ' + valuetxtPassword + '></div>'; //value = "' + valuetxtPassword + '"
            $('#divPassword').append(opendiv + labelPassword + txtPassword + closediv);
        }

        function getProgramIdTb(resp) {
            $('#fg_partner_api_ProgramId, #lbl_partner_api_ProgramId, #tb_partner_api_ProgramId').remove();
            var valuetxtProgramId = resp != null ? 'value="' + resp + '"' : "";
            var opendiv = '<div class="form-group" id="fg_partner_api_ProgramId">';
            var closediv = '</div>';
            var labelProgramId = '<label class="control-label col-md-3 col-sm-3 col-xs-12" for="partner_api_ProgramId" id="lbl_partner_api_ProgramId">Program Id</label>';
            var txtProgramId = '<div id="tb_partner_api_ProgramId" class="col-md-6 col-sm-6 col-xs-12"><input class="form-control" id="partner_api_ProgramId" name="partner_api.ProgramId" type="text" required="required" ' + valuetxtProgramId + '></div>'; //value="' + valuetxtProgramId + '"
            $('#divProgramId').append(opendiv + labelProgramId + txtProgramId + closediv);
        }

        function getWalletIdTb(resp) {
            $('#fg_partner_api_WalletId, #lbl_partner_api_WalletId, #tb_partner_api_WalletId').remove();
            var valuetxtWalletId = resp != null ? 'value="' + resp + '"' : "";
            var opendiv = '<div class="form-group" id="fg_partner_api_WalletId">';
            var closediv = '</div>';
            var labelWalletId = '<label class="control-label col-md-3 col-sm-3 col-xs-12" for="partner_api_WalletId" id="lbl_partner_api_WalletId">Wallet Id</label>';
            var txtWalletId = '<div id="tb_partner_api_WalletId" class="col-md-6 col-sm-6 col-xs-12"><input class="form-control" id="partner_api_WalletId" name="partner_api.WalletId" type="text" required="required" ' + valuetxtWalletId + '></div>'; //value="' + valuetxtWalletId + '
            $('#divWalletId').append(opendiv + labelWalletId + txtWalletId + closediv);
        }

        //function removeLabelTextbox() {
        //    $('#lbl_partner_api_Status').remove();
        //    $('#hd_partner_api_Status').remove();
        //    $('#lbl_partner_api_isPaid').remove();
        //    $('#hd_partner_api_isPaid').remove();
        //    $('#lbl_partner_api_Username').remove();
        //    $('#tb_partner_api_Username').remove();
        //    $('#lbl_partner_api_Password').remove();
        //    $('#tb_partner_api_Password').remove();
        //    $('#lbl_partner_api_ProgramId').remove();
        //    $('#tb_partner_api_ProgramId').remove();
        //    $('#lbl_partner_api_WalletId').remove();
        //    $('#tb_partner_api_WalletId').remove();
        //    $('#lbl_partner_api_Schedule1').remove();
        //    $('#cb_partner_api_Schedule1').remove();
        //}
        function getScheduleCb() {

            $('#lbl_partner_api_Schedule1').remove();
            $('#cb_partner_api_Schedule1').remove();

            var labelSchedule = '<label class="control-label col-md-3 col-sm-3 col-xs-12" for="partner_api_Status" id="lbl_partner_api_Schedule1">Schedule</label>';
            var txtSchedule = '<div id="cb_partner_api_Schedule1" class="col-md-6 col-sm-6 col-xs-12"><input class="form-control" id="partner_api_Schedule1" name="partner_api.Schedule1" type="text" value="02:00:00" disabled></div>'; //<select id="api_schedule" name="api_schedule" placeholder="02:00:00" disabled> //<option value="19:00:00">02:00:00</option></select>
            $('#divSchedule').append(labelSchedule + txtSchedule);

            //var listTime = [];
            //for (let i = 0; i <= 23; i++) {
            //    //let j = i + 1;
            //    if (i <= 9) {
            //        listTime.push({ id: "0" + i, text: "0" + i + ":00:00" });
            //    } else {
            //        listTime.push({ id: "" + i, text: i + ":00:00" });
            //    }
            //}
            //var listTime = [];
            //listTime[0] = {
            //    id: "02",
            //    text: "02:00:00"
            //};
            //listTime[1] = {
            //    id: "19",
            //    text: "19:00:00"
            //};
            var selectize1 = $('#api_schedule').selectize({
                valueField: 'text',
                searchField: 'text',
                //options: listTime,
                //onChange: function (value) {
                //    $('#partner_api_Schedule1').val("19:00:00");
                //}
            });
            selectize1[0].selectize.setValue($('#partner_api_Schedule1').val("19:00:00"), true);
        }

        function getTadaTb() {
            debugger;
            //$('#lbl_partner_api_Username').remove();
            //$('#tb_partner_api_Username').remove();
            $('#lbl_partner_api_Password').remove();
            $('#tb_partner_api_Password').remove();
            $('#lbl_partner_api_ProgramId').remove();
            $('#tb_partner_api_ProgramId').remove();
            $('#lbl_partner_api_WalletId').remove();
            $('#tb_partner_api_WalletId').remove();
            $('#lbl_partner_api_Schedule1').remove();
            $('#cb_partner_api_Schedule1').remove();

            //var valuetxtUsername = "";
            //var valuetxtPassword = "";
            //var valuetxtProgramId = "";
            //var valuetxtWalletId = "";

            //if ($('#partner_api_PartnerId').val() != null && $('#partner_api_PartnerId').val() == 30007) {
            //    valuetxtUsername = $('#partner_api_Username').val();
            //    valuetxtPassword = $('#partner_api_Password').val();
            //    valuetxtProgramId = $('#partner_api_ProgramId').val();
            //    valuetxtWalletId = $('#partner_api_WalletId').val();
            //}

            var opendiv = '<div class="form-group">';
            var closediv = '</div>';
            var labelUsername = '<label class="control-label col-md-3 col-sm-3 col-xs-12" for="partner_api_Username" id="lbl_partner_api_Username">Username</label>';
            var txtUsername = '<div id="tb_partner_api_Username" class="col-md-6 col-sm-6 col-xs-12"><input class="form-control" id="partner_api_Username" name="partner_api.Username" type="text" required="required"></div>'; //value="' + valuetxtUsername + '"
            var labelPassword = '<label class="control-label col-md-3 col-sm-3 col-xs-12" for="partner_api_Password" id="lbl_partner_api_Password">Password</label>';
            var txtPassword = '<div id="tb_partner_api_Password" class="col-md-6 col-sm-6 col-xs-12"><input class="form-control" id="partner_api_Password" name="partner_api.Password" type="text" required="required"></div>'; //value = "' + valuetxtPassword + '"
            var labelProgramId = '<label class="control-label col-md-3 col-sm-3 col-xs-12" for="partner_api_ProgramId" id="lbl_partner_api_ProgramId">Program Id</label>';
            var txtProgramId = '<div id="tb_partner_api_ProgramId" class="col-md-6 col-sm-6 col-xs-12"><input class="form-control" id="partner_api_ProgramId" name="partner_api.ProgramId" type="text" required="required"></div>'; //value="' + valuetxtProgramId + '"
            var labelWalletId = '<label class="control-label col-md-3 col-sm-3 col-xs-12" for="partner_api_WalletId" id="lbl_partner_api_WalletId">Wallet Id</label>';
            var txtWalletId = '<div id="tb_partner_api_WalletId" class="col-md-6 col-sm-6 col-xs-12"><input class="form-control" id="partner_api_WalletId" name="partner_api.WalletId" type="text" required="required"></div>'; //value="' + valuetxtWalletId + '
            var labelSchedule = '<label class="control-label col-md-3 col-sm-3 col-xs-12" for="partner_api_Status" id="lbl_partner_api_Schedule1">Schedule</label>';
            var txtSchedule = '<div id="cb_partner_api_Schedule1" class="col-md-6 col-sm-6 col-xs-12"><select id="api_schedule" placeholder="Harap Pilih" name="api_schedule" required="required"></div>';


            $('#divTADA').append(/*opendiv + labelUsername + txtUsername + closediv +*/ opendiv + labelPassword + txtPassword + closediv + opendiv + labelProgramId + txtProgramId + closediv +
                opendiv + labelWalletId + txtWalletId + closediv + opendiv + labelSchedule + txtSchedule + closediv);

            var listTime = [];
            for (let i = 0; i <= 23; i++) {
                //let j = i + 1;
                if (i <= 9) {
                    listTime.push({ id: "0" + i, text: "0" + i + ":00:00" });
                } else {
                    listTime.push({ id: "" + i, text: i + ":00:00" });
                }
            }
            var selectize1 = $('#api_schedule').selectize({
                valueField: 'text',
                searchField: 'text',
                options: listTime,
                onChange: function (value) {
                    $('#partner_api_Schedule1').val(value);
                }
            });
            selectize1[0].selectize.setValue($('#partner_api_Schedule1').val(), true);
            //var valuetxtSort1_Cust = "";
            //if ($('#Customers_Sort1_Cust').val() != null) {
            //    valuetxtSort1_Cust = $('#Customers_Sort1_Cust').val();
            //}
        }

        function getWebhookCb()/*resp*/ {

            @* class="form-control"*@

            //if (response == "" || response == null) {
            //$('#partner_api_Status').val(resp);
            //}

            debugger;
            $('#lbl_partner_api_Status').remove();
            $('#hd_partner_api_Status').remove();
            var labelWebhook = '<label class="control-label col-md-3 col-sm-3 col-xs-12" for="partner_api_Status" id="lbl_partner_api_Status">Link Partner*</label>';
            var txtWebhook = '<div id="hd_partner_api_Status" class="col-md-6 col-sm-6 col-xs-12"><select id="api_status" placeholder="Harap Pilih" name="api_status" required="required"></div>';
            $('#divWebhook').append(labelWebhook + txtWebhook);

            var listStatus = [];

            listStatus[0] = {
                id: "true",
                text: "Aktif"
            };
            listStatus[1] = {
                id: "false",
                text: "Tidak Aktif"
            };

            var comboSelect = $('#api_status').selectize({
                valueField: 'id',
                searchField: 'text',
                options: listStatus,
                onChange: function (value) {
                    $('#partner_api_Status').val(value);
                }
            });
            comboSelect[0].selectize.setValue($('#partner_api_Status').val(), true);
        }

        function getInvoiceCb() {

            $('#lbl_partner_api_isPaid').remove();
            $('#hd_partner_api_isPaid').remove();
            var labelInvoice = '<label class="control-label col-md-3 col-sm-3 col-xs-12" for="partner_api_isPaid" id="lbl_partner_api_isPaid">Status Invoice*</label>';
            var infoIntegration = '<label>Untuk mendapatkan panduan integrasi, silahkan klik petunjuk <a href="javascript:window.open(\'https://masteronline.co.id/Content/Static/mo-accurate-integration.html\', \'_blank\').focus();" style="color:blue"><u>Di Sini</u></a>';
            var txtInvoice = '<div id="hd_partner_api_isPaid" class="col-md-6 col-sm-6 col-xs-12"><select id="inv_status" placeholder="Harap Pilih" name="inv_status" required="required">' + infoIntegration + '</div>';
            $('#divInvoice').append(labelInvoice + txtInvoice);

            var listStatus = [];
            //$('#divVersiAPI').remove();
            //var sHTML = '<div id="divVersiAPI"><select id="cbVersiAPI" placeholder="Harap pilih" required="required"></select></div>';
            //$('#divCBVersi').append(sHTML);

            listStatus[0] = {
                id: "true",
                text: "Lunas"
            };
            listStatus[1] = {
                id: "false",
                text: "Belum Lunas"
            };

            var comboSelect = $('#inv_status').selectize({
                valueField: 'id',
                searchField: 'text',
                options: listStatus,
                onChange: function (value) {
                    $('#partner_api_isPaid').val(value);
                }
            });
            comboSelect[0].selectize.setValue($('#partner_api_isPaid').val(), true);
        }

        function getSyncInvCb()/*resp*/ {

            @* class="form-control" *@

            //if (response == "" || response == null) {
            //$('#partner_api_Status').val(resp);
            //}

            debugger;
            $('#lbl_partner_api_isFaktur').remove();
            $('#hd_partner_api_isFaktur').remove();
            var labelSyncInv = '<label class="control-label col-md-3 col-sm-3 col-xs-12" for="partner_api_isFaktur" id="lbl_partner_api_isFaktur">Sync Faktur*</label>';
            var txtSyncInv = '<div id="hd_partner_api_isFaktur" class="col-md-6 col-sm-6 col-xs-12"><select id="sync_inv_status" placeholder="Harap Pilih" name="sync_inv_status" required="required"></div>';
            $('#divSyncInv').append(labelSyncInv + txtSyncInv);

            var listStatus = [];

            listStatus[0] = {
                id: "true",
                text: "Aktif"
            };
            listStatus[1] = {
                id: "false",
                text: "Tidak Aktif"
            };

            var comboSelect = $('#sync_inv_status').selectize({
                valueField: 'id',
                searchField: 'text',
                options: listStatus,
                onChange: function (value) {
                    $('#partner_api_isFaktur').val(value);
                }
            });
            comboSelect[0].selectize.setValue($('#partner_api_isFaktur').val(), true);
        }

        function getPartner() {
            debugger;
            //removeWebhookInvoice();
            $.ajax({
                type: "GET",
                url: '@Url.Action("GetDataPartner", "Manage")',
                contentType: 'application/json',
                cache: false,
                success: function (data) {
                    var partnerList = [];
                    $.each(data,
                        function (i, item) {
                            partnerList[i] = {
                                id: item.PartnerId,
                                text: item.Username,
                            };
                        });

                    var partnerSelect = $('#Partner').selectize({
                        valueField: 'id',
                        searchField: 'text',
                        options: partnerList,
                        onChange: function (value) {
                            var $objSup = $.grep(partnerList, function (data) { return data.id == value });
                            if (value == null) {
                                $('#partner_api_PartnerId').val(null);
                                partnerSelect[0].selectize.setValue($('#partner_api_PartnerId').val(), true);
                            } else {
                                var url = '@Url.Action("CekPartner", "Manage")';
                                url += "?partnerId=" + value;
                                $.ajax({
                                    type: "GET",
                                    url: url,
                                    contentType: 'application/json',
                                    cache: false,
                                    success: function (response) {
                                        if (response.Errors[0] != "") {
                                            alert(response.Errors[0]);
                                            $('#partner_api_PartnerId').val(null);
                                            partnerSelect[0].selectize.setValue($('#partner_api_PartnerId').val(), true);

                                        }
                                        else {
                                            $('#partner_api_PartnerId').val(value);
                                            partnerSelect[0].selectize.setValue($('#partner_api_PartnerId').val(), true);
                                            removeLabelTextbox();
                                            if ($objSup[0] != null) {
                                                //$('#partner_api_PartnerId').val($objSup[0].id);
                                                $('#partner_api_Nama_Partner').val($objSup[0].text);
                                                if (value == "20007") {
                                                    getWebhookCb();
                                                    getSyncInvCb();
                                                    getInvoiceCb();

                                                    //$('#partnerApiTab li a').each(function (index) {
                                                    //    $(this).attr('data-toggle', 'tab');
                                                    //    $(this).removeClass('disabled-tab');
                                                    //});
                                                }
                                                else if (value == "30007") {
                                                    getWebhookCb();
                                                    getUsernameTb(null);
                                                    getPasswordTb(null);
                                                    getProgramIdTb(null);
                                                    getWalletIdTb(null);
                                                    getScheduleCb();
                                                    //getTadaTb();

                                                    //$('#partnerApiTab li a').each(function (index) {
                                                    //    $(this).removeAttr('data-toggle');
                                                    //    if ($(this).attr('id') === 'pengaturan-tab') return;
                                                    //    $(this).addClass('disabled-tab');
                                                    //});
                                                }
                                            }
                                        }
                                    },
                                    error: function (xhr) {
                                        console.log(xhr);
                                    }
                                });
                            }
                        }
                    });
                    if (partnerSelect[0] != undefined) {
                        partnerSelect[0].selectize.setValue($('#partner_api_PartnerId').val(), true);
                    }
                },
                error: function (xhr) {
                    console.log(xhr);
                }
            });
        }

        function searchTableLog() {
            var $link = '@Html.Raw(Url.Action("RefreshTableBankPartnerApi", "Manage", new { search = "replaceSearch", fsid = "replacefsid" }))';
            $link = $link.replace("replaceSearch", encodeURIComponent($('#search-bank-api').val()));
            $link = $link.replace("replacefsid", encodeURIComponent($("#partner_api_fs_id").val()));

            $.ajax({
                type: "GET",
                url: $link,
                beforeSend: function () {
                    //$('#table-barang-1-partial').hide();
                    //$('#search_api_log_btn')[0].disabled = true;
                    $('#loading_link_bank').show();
                },
                success: function (response) {
                    $('#search-bank-api-btn')[0].disabled = false;
                    $('#table-link-bank-partner-api').html(response);
                    $('#loading_link_bank').hide();

                },
                error: function (xhr, status, error) {
                    $('#search-bank-api-btn')[0].disabled = false;
                    console.log(error);
                }
            });
        }

        function refreshTableApiLog() {
            var $link = '@Html.Raw(Url.Action("RefreshTableBankPartnerApi", "Manage", new { page = "replaceLastPage", search = "replaceSearch", fsid = "replacefsid" }))';
            $link = $link.replace("replaceSearch", encodeURIComponent($('#search-bank-api').val()));
            $link = $link.replace("replacefsid", encodeURIComponent($("#partner_api_fs_id").val()));
            $link = $link.replace("replaceLastPage", encodeURIComponent($('#txt_last_page').val()));

            $.ajax({
                type: "GET",
                url: $link,
                beforeSend: function () {
                    //$('#table-barang-1-partial').hide();
                    //$('#search_api_log_btn')[0].disabled = true;
                    $('#loading_link_bank').show();
                },
                success: function (response) {
                    //$('#search_api_log_btn')[0].disabled = false;
                    $('#table-link-bank-partner-api').html(response);
                    $('#loading_link_bank').hide();
                },
                error: function (xhr, status, error) {
                    $('#search_api_log_btn')[0].disabled = false;
                    console.log(error);
                }
            });
        }

        function editKodeSap($kodecust, flag) {
            debugger;
            var $tr = 'tr[data-kode-id="' + $kodecust + '"]';
            var $btnEdit = $($tr + ' .icon-btn-edit');

            var $branchInitialSpan = $($tr + ' .branch-initial');
            var $branchInputBox = $($tr + ' .branch-input-box_'+$kodecust);
            var $branchAwal = $branchInitialSpan.text();

            var $kodesapInitialSpan = $($tr + ' .kodesap-initial');
            var $kodesapInputBox = $($tr + ' .kodesap-input-box');
            var $kodesapAwal = $kodesapInitialSpan.text();

            if ($btnEdit.hasClass('glyphicon-pencil')) {
                $btnEdit.parent().removeClass('btn-primary').addClass('btn-success');
                $btnEdit.removeClass('glyphicon-pencil').addClass('glyphicon-floppy-disk');

                if (flag == "true") {
                    $kodesapInitialSpan.hide();
                    $kodesapInputBox.val($kodesapAwal).show();
                }

                $branchInitialSpan.hide();
                $branchInputBox.val($branchAwal).show();
                getDataBranch($kodecust);
            } else {
                var kodesapInitialBeforeValidation = $kodesapInitialSpan.val();

                if (flag == "true") {
                    $kodesapInitialSpan.text($kodesapInputBox.val());
                }
                else {
                    $kodesapInputBox.val($kodesapAwal);
                    $kodesapInitialSpan.text($kodesapInputBox.val());
                }

                var branchid = $('.branch-input-box_' + $kodecust).val();
                var branchname = $('#BRNCH').val();
                var branchInitialBeforeValidation = $branchInitialSpan.val();
                $branchInitialSpan.text(branchname);

                simpanKodeSap($kodecust, $kodesapInputBox, $kodesapInitialSpan, kodesapInitialBeforeValidation, $branchInputBox, $btnEdit, $branchInitialSpan, branchInitialBeforeValidation, branchid, branchname); //, bank_code
            }
        }

        function simpanKodeSap($kodecust, $kodesapInputBox, $kodesapInitialSpan, kodesapInitialBeforeValidation, $branchInputBox, $btnEdit, $branchInitialSpan, branchInitialBeforeValidation, branchid, branchname) {

            $postdata = {
                kodecust: $kodecust,
                kodesap: $kodesapInputBox.val(),
                branchname: branchname,
                branchid: branchid
            };

            $.ajax({
                type: "POST",
                contentType: "application/json; charset=UTF-8",
                url: '@Url.Action("SaveBankPartnerApi", "Manage")',
                data: JSON.stringify($postdata),
                cache: false,
                beforeSend: function() {
                    $('#loading_link_bank').show();
                },
                success: function (response) {

                    if (response.Errors == null) {
                        $modeEdit = 1; // 0 new, 1 edit
                        $btnEdit.parent().removeClass('btn-success').addClass('btn-primary');
                        $btnEdit.removeClass('glyphicon-floppy-disk').addClass('glyphicon-pencil');
                        $kodesapInitialSpan.show();
                        $kodesapInputBox.hide();
                        $branchInitialSpan.show();
                        $branchInputBox.hide();
                        $('.branch-input-box_' + $kodecust).val('');
                        $('#BRNCH').val('');
                        $('#loading_link_bank').hide();
                    } else {
                        $kodesapInitialSpan.text(kodesapInitialBeforeValidation);
                        $branchInitialSpan.text(branchInitialBeforeValidation);
                        //console.log(response.Errors);
                        alert(response.Errors);
                        $('#loading_link_bank').hide();
                    }
                },
                error: function (xhr) {
                    console.log(xhr);
                }
            });
        }

        function getDataBranch(cust) {
            $.ajax({
                type: "GET",
                url: '@Url.Action("GetDataBranchAccurate", "Manage")',
                contentType: 'application/json',
                cache: false,
                success: function(data) {
                    var listKodeBarang = [];

                    $.each(data,
                        function(i, item) {
                            listKodeBarang[i] = {
                                id: item.id + ';' + item.name,
                                text: item.name
                            };
                        });

                    debugger;
                    //#BRG _' + cust
                    $('.branch-input-box_' + cust).selectivity({
                        allowClear: true,
                        items: listKodeBarang,
                        placeholder: 'Harap pilih',
                    }).change(function () {

                        debugger;
                        var val = $(this).selectivity('value');
                        var $trId = $(this).closest('tr').attr('data-kode-id');
                        var $trElement = 'tr[data-kode-id="' + $trId + '"]';
                        var splitVal = val.split(';');

                        if (val != null) {
                            $('.branch-input-box_' + cust).val(splitVal[0]);
                            $('#BRNCH').val(splitVal[1]);
                            //$.each(data,
                            //    function(i, item) {
                            //        if (item.BRG === val) {
                            //            return;
                            //        }
                            //    });
                        } else {
                            $($trElement + ' .nama-barang').text('-');
                        }
                    });

                    if ($('.branch-input-box_' + cust).selectivity('value') != null) {
                        $('.branch-input-box_' + cust).trigger('change');
                    }
                },
                error: function(xhr) {
                    console.log(xhr);
                }
            });
        }

    </script>
}