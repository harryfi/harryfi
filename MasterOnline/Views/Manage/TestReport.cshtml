@using MasterOnline.ViewModels
@model MasterOnline.Models.UpdateData
@{
    ViewBag.Title = "TestReport";
    Layout = "~/Views/Shared/_LayoutManage.cshtml";
    var context = new MoDbContext();
    var dataSession = Session["SessionInfo"] as AccountUserViewModel;

    var userId = "";
    if (dataSession?.User != null)
    {
        var accId = context.User.Single(u => u.Username == dataSession.User.Username).AccountId;
        userId = context.Account.Single(a => a.AccountId == accId).UserId;
        context.Dispose();
    }
    else
    {
        userId = dataSession?.Account?.UserId;
    }
}

@section styles
{
    <link href="~/Content/build/css/bootstrap-datepicker.min.css" rel="stylesheet" />
}

<h2>Test Pembeli</h2>

<div class="row">
    <div class="col-md-2">
        <div class="form-group">
            @Html.Label("", "Pembeli")
            <div class="input-group">
                @Html.TextBox("Pembeli", null, new { @class = "form-control" })
                <span class="input-group-btn">
                    <button id="lihat-pembeli" class="btn btn-default" type="button" style="height: 34px;">
                        <span class="glyphicon glyphicon-option-horizontal"></span>
                    </button>
                </span>
            </div>
        </div>
    </div>
</div>

<hr/>

<h2>Test Report From API</h2>

<div class="row">
    <div class="col-md-6">
        @Html.Label("", "Dari Tanggal")
        <div class="input-group date">
            @Html.TextBox("FromDate", null, new { @class = "form-control" })
            <span class="input-group-addon">
                <span class="glyphicon glyphicon-calendar"></span>
            </span>
        </div>
    </div>
    <div class="col-md-6">
        @Html.Label("", "Sampai Tanggal")
        <div class="input-group date">
            @Html.TextBox("ToDate", null, new { @class = "form-control" })
            <span class="input-group-addon">
                <span class="glyphicon glyphicon-calendar"></span>
            </span>
        </div>
    </div>
</div>
<br />
<div class="row">
    <div class="col-md-12">
        <button type="button" class="btn btn-primary" id="preview-report">Preview Report</button>
    </div>
</div>
<br />
<br />
<div class="row text-center">
    <object id="pdf_viewer" data="#" type="application/pdf" width="1079" height="600"></object>
</div>

@section scripts
{
    <script src="~/Content/build/js/bootstrap-datepicker.min.js" type="text/javascript"></script>

    <script>
        $(document).ready(function() {
            $('#FromDate, #ToDate').datepicker({
                format: 'dd/mm/yyyy',
                language: 'id'
            }).datepicker('setDate', '0');

            $('#preview-report').click(function() {
                previewing();
            });

            $('#lihat-pembeli').click(function () {
                var $link = '@Url.Action("LihatListPembeliPopup", "Manage")';
                window.open($link, "popupWindow", "width=600, height=400, scrollbars=yes");
            });
        });

        function previewing() {
            if (selisihValid()) {
                $.ajax({
                    type: "POST",
                    url: 'http://localhost:51742/api/testreport',
                    data: JSON.stringify({
                        UserId: '@(userId)',
                        FromDate: $('#FromDate').val(),
                        ToDate: $('#ToDate').val()
                    }),
                    contentType: 'application/json; charset=UTF-8',
                    cache: false,
                    success: function(data) {
                        $('#pdf_viewer').attr('data', data);
                    },
                    error: function (xhr) {
                        console.log(xhr);
                    }
                });
            }
        }

        function selisihValid() {
            var start = $("#FromDate").datepicker("getDate");
            var end = $("#ToDate").datepicker("getDate");
            var days = (end - start) / (1000 * 60 * 60 * 24);

            if (days < 0) {
                alert('Tanggal awal tidak boleh melebihi tanggal akhir!');
                return false;
            } else {
                return true;
            }
        }

        function refreshPembeliBox($buyerCode) {
            $('#Pembeli').val($buyerCode);
        }
    </script>
}
