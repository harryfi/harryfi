@using System.Globalization
@using MasterOnline.ViewModels
@model HargaJualViewModel
@{
    ViewBag.Title = "Harga Jual Barang";
    Layout = "~/Views/Shared/_LayoutManage.cshtml";
    var dataSession = Session["SessionInfo"] as AccountUserViewModel;
    var username = "";
    var context = new MoDbContext();
    if (dataSession?.User != null)
    {
        var accId = context.User.Single(u => u.Username == dataSession.User.Username).AccountId;
        username = context.Account.Single(a => a.AccountId == accId).Username;
        context.Dispose();
    }
    else
    {
        username = dataSession?.Account.Username;
    }
}
@section styles
{
    <link href="~/Content/selectize.css" rel="stylesheet" />
    <link href="~/Content/build/css/selectivity-jquery.min.css" rel="stylesheet" />
    <link href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" rel="stylesheet" />
    <style>
        #hargaJual-section > div {
            background-color: #fff;
            padding: 20px;
        }

        #HargaJuals_AL {
            resize: vertical;
            height: 100px;
            max-height: 100px;
        }

        #hapus_label {
            color: orange;
            font-weight: bold;
        }

        @@media screen and (max-width: 767px) {
            .marginmin {
                margin-left: 0px;
            }

            #hargaJual-section > div {
                padding: 2px;
            }

            .dataTables_paginate {
                margin-top: 9px;
            }
        }
    </style>
}
<div class="row" id="hargaJual-section">
    <div class="col-lg-12 col-md-12">
        <div class="row hargaJual_table_section marginmin">
            <div class="col-lg-4 col-sm-6">
                <div class="input-group">
                    <input id="search_hargaJual" type="text" class="form-control" placeholder="Pencarian">
                    <span class="input-group-btn">
                        <button type="button" id="search_hargaJual_click" class="btn btn-primary">
                            <i class="fa fa-search"></i>
                        </button>
                    </span>
                </div>
            </div>
            <div class="col-lg-8 col-sm-6">
                <div class="pull-right">
                    @*<button type="button" class=" btn btn-default" data-style="expand-right">
                        <span>Refresh</span>
                    </button>*@
                    <button type="button" onclick="exportExcel()" class=" btn btn-primary" data-style="expand-right">
                        <span>Export ke Excel</span>
                    </button>
                </div>
            </div>
        </div>
        <div class="row hargaJual_table_section">
            <div class="col-sm-12" id="table-hargaJual-partial">
                @*@Html.Partial("TableHargaJualPartial")*@
            </div>
        </div>
    </div>
</div>
<!-- Modal Hapus hargaJual -->
<div class="modal fade" id="konfHapusHargaJual" tabindex="-1" role="dialog" aria-labelledby="konfirmasiHapusLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="konfirmasiHapusLabel">Konfirmasi</h4>
            </div>
            <div class="modal-body">
                <div class="row text-center">
                    <h4>Apakah Anda yakin ingin menghapus akun penghubung marketplace <span id="hapus_label"></span>?</h4>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Tidak</button>
                <button type="button" class="btn btn-success" onclick="deletehargaJual()">Ya</button>
            </div>
        </div>
    </div>
</div>
<!-- Modal Edit Harga Jual -->
<div class="modal fade" id="modalEditHargaJual" tabindex="-1" role="dialog" aria-labelledby="editHargaJualLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="editHargaJualLabel">Edit Harga Jual</h4>
            </div>
            <div class="modal-body" id="modal-gudang-qty-body">
                <div class="row">
                    <div class="col-md-6">
                        <p id="kodeBarang">-</p>
                        <p id="namaBarang">-</p>
                        <p id="labelAkunMp">-</p>
                        <p>Harga jual awal: Rp <span id="hJualAwal"></span></p>
                    </div>
                    <div class="col-md-6">
                        <b>Masukkan harga jual yang baru:</b>
                        <input type="text" id="HJUALBARU" name="HJUALBARU" class="form-control" style="margin-top: 10px;" />
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="saveHargaJualBaru();" id="btnUbahHJual" type="button" class="btn btn-success">Simpan</button>
                <div id="loading_spinner_btn">
                    <div id="loading_spinner_image_btn">
                        <img id="spinner_btn" src="~/Content/Images/spinner.gif" />
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@section scripts
{
    <script src="~/Content/selectize.js" type="text/javascript"></script>
    <script src="~/Content/build/js/selectivity-jquery.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        //add by nurul 12/2/2019
        var $page = window.text;
        //end add by nurul 12/2/2019
        var $recNum = 0;

        $(document).on('ready',
            function () {
                //add by nurul 12/2/2019
                $page = 0;
            //end add by nurul 12/2/2019
                //Initialize();
                refreshTableHargaJual();
                //add by nurul 12/2/2019
                //$('#datatable').on('page.dt', function () {
                //    $page = $('#datatable').DataTable().page.info().page;
                //});
                //$('#datatable').DataTable().page($page).draw(false);
                    //end add by nurul 12/2/2019

                $('#search_hargaJual').keypress(function (e) {
                    var key = e.which;
                    if (key == 13)// the enter key code
                    {
                        searchTableHargaJual();
                        return false;
                    }
                });
                $('#search_hargaJual_click').click(function () {
                    searchTableHargaJual();
                });
            });
        //add by Tri, 27 Mei 2019
        function exportExcel() {
            var link = '@Html.Raw(Url.Action("HargaJualtoExcel", "TransferExcel"))';

            $.ajax({
                type: "GET",
                url: link,
                contentType: 'application/json',
                cache: false,
                async: false,
                beforeSend: function () {
                    $('#loading_spinner_btn').show();
                },
                success: function (response) {
                    $('#loading_spinner_btn').hide();
                    if (response.Errors.length == 0) {

                        @*var url2 = '@Url.Action("DownloadFileExcel", "TransferExcel", new { file = "replace1", fileName = "replace2" })';
                        url2 = url2.replace("replace1", response.byteExcel);
                        url2 = url2.replace("replace2", response.namaFile);

                        window.location = url2;*@
                        //downloadXcel(response);
                        //var sampleArr = base64ToArrayBuffer(response.byteExcel);
                        var bytes = new Uint8Array(response.byteExcel);
                        saveByteArray(response.namaFile, bytes);

                    } else {
                        alert(response.Errors[0]);
                    }
                    //var response = JSON.parse(data);
                    //window.location = '/Download?fileGuid=' + response.FileGuid
                    //    + '&filename=' + response.FileName;
                    //window.location = '/Download?file=' + data;
                },
                error: function (xhr) {
                    $('#loading_spinner_btn').hide();
                    console.log(xhr);
                }
            });

        }

        function base64ToArrayBuffer(base64) {
            var binaryString = window.atob(base64);
            var binaryLen = binaryString.length;
            var bytes = new Uint8Array(binaryLen);
            for (var i = 0; i < binaryLen; i++) {
                var ascii = binaryString.charCodeAt(i);
                bytes[i] = ascii;
            }
            return bytes;
        }

        function saveByteArray(reportName, byte) {
            var blob = new Blob([byte], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
            var link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            var fileName = reportName;
            link.download = fileName;
            link.click();
        };

        function downloadXcel(value) {
            //var dataPost = new FormData();
            //dataPost.append("data", value);
            var dataPost = {
                data: JSON.stringify(value)
            }

            $.ajax({
                type: "POST",
                url: '@Url.Action("DownloadFileExcel", "TransferExcel")',
                contentType: "application/json;charset=utf-8",
                data: dataPost,
                //dataType: "json",
                async: true,
                //processData: false,  // tell jQuery not to process the data
                //contentType: false,  // tell jQuery not to set contentType
                beforeSend: function () {
                    //$('#loading_spinner').show();
                },
                success: function (response) {
                    if (response.Errors == null) {

                    }
                },
                error: function (xhr, status, error) {
                    console.log(error);
                    //$('#loading_spinner').hide();
                }
            });
            return null
        }
        //end add by Tri, 27 Mei 2019

        function Initialize() {
            //var table = $('#datatable').DataTable();

            //$('#search_hargaJual').keyup(function () {
            //    table.search($(this).val()).draw();
            //});
            $('#search_hargaJual').keypress(function (e) {
                var key = e.which;
                if (key == 13)// the enter key code
                {
                    searchTableHargaJual();
                    return false;
                }
            });
            $('#search_hargaJual_click').click(function () {
                searchTableHargaJual();
            });

            //add by nurul 26 nov 2018, setelah di close, search lg
            //table.search($('#search_hargaJual').val()).draw();
            //end add by nurul 26 nov 2018, setelah di close, search lg
            //add by nurul 12/2/2019
            //$('#datatable').on('page.dt', function () {
            //    $page = $('#datatable').DataTable().page.info().page;
            //});
            //$('#datatable').DataTable().page($page).draw(false);
                    //end add by nurul 12/2/2019
        }

        function pass(recNum, kdBrg, nmBrg, nmMp, hjual) {
            $recNum = recNum;
            $('#kodeBarang').text(kdBrg);
            $('#namaBarang').text(nmBrg);
            $('#labelAkunMp').text(nmMp);
            $('#hJualAwal').text(hjual);
            $('#HJUALBARU').val('');
        }

        function saveHargaJualBaru() {
            var link = '@Html.Raw(Url.Action("UbahHargaJual", "Manage", new { recNum = "replaceRecNum", hargaJualBaru = "replaceHargaBaru" }))';
            link = link.replace("replaceRecNum", $recNum);
            link = link.replace("replaceHargaBaru", $('#HJUALBARU').val());

            $.ajax({
                type: "GET",
                url: link,
                contentType: 'application/json',
                cache: false,
                beforeSend: function () {
                    $('#btnUbahHJual').hide();
                    $('#loading_spinner_btn').show();
                },
                success: function (res) {
                    $('#btnUbahHJual').show();
                    $('#loading_spinner_btn').hide();
                    if (res.message == null) {
                        refreshTableHargaJual();
                        alert("Harga jual berhasil diubah");
                        $('#table-hargaJual-partial').html(res);
                        //Initialize();
                        
                        $('#modalEditHargaJual').modal('hide');
                    } else {
                        alert(res.message);
                    }

                },
                error: function (xhr) {
                    $('#btnUbahHJual').show();
                    $('#loading_spinner_btn').hide();
                    console.log(xhr);
                }
            });
        }

        function convertToRupiah(angka) {
            //change by calvin 26 september 2018
            //var rupiah = '';
            //var angkarev = angka.toString().split('').reverse().join('');
            //for (var i = 0; i < angkarev.length; i++) if (i % 3 === 0) rupiah += angkarev.substr(i, 3) + '.';
            //return rupiah.split('', rupiah.length - 1).reverse().join('') + ',00';
            return $.number(angka, 2, ',', '.');
            //end change by calvin 26 september 2018
        }

        function convertToAngka(rupiah) {

            if (rupiah == '') {
                rupiah = '0';
            }
            //change by calvin 26 september 2018
            //return parseInt(rupiah.replace(/,.*|[^0-9]/g, ''), 10);
            if (rupiah.includes(",")) {
                return parseFloat(rupiah.replaceAll('.', '').replaceAll(',', '.'));
            }
            else {
                //jika bisa desimal
                return parseFloat(rupiah.replaceAll(',', '.'));
            }
            //end change by calvin 26 september 2018
        }

        //add by nurul 13/6/2019
        function refreshTableHargaJual() {
            var $link = '@Html.Raw(Url.Action("RefreshTableHargaJual", "Manage", new { page = "replaceLastPage", search = "replaceSearch" }))';
            $link = $link.replace("replaceSearch", $('#search_hargaJual').val());
            $link = $link.replace("replaceLastPage", $('#txt_last_page').val());

            $.ajax({
                type: "GET",
                url: $link,
                beforeSend: function () {
                    $('#table-hargaJual-partial').hide();
                    $('#loading_hargaJual_tab').show();
                },
                success: function (response) {
                    $('#table-hargaJual-partial').html(response);
                    $('#loading_hargaJual_tab').hide();
                    $('#table-hargaJual-partial').show();

                },
                error: function (xhr, status, error) {
                    console.log(error);
                }
            });
        }
        function searchTableHargaJual(){
            var $link = '@Html.Raw(Url.Action("RefreshTableHargaJual", "Manage", new { search = "replaceSearch" }))';
            $link = $link.replace("replaceSearch", $('#search_hargaJual').val());

            $.ajax({
                type: "GET",
                url: $link,
                beforeSend: function () {
                    $('#search_hargaJual_click')[0].disabled = true;
                    $('#loading_hargaJual_tab').show();
                },
                success: function (response) {
                    $('#search_hargaJual_click')[0].disabled = false;
                    $('#table-hargaJual-partial').html(response);
                    $('#loading_hargaJual_tab').hide();
                },
                error: function (xhr, status, error) {
                    $('#search_hargaJual_click')[0].disabled = false;
                    console.log(error);
                }
            });
        }
        //end add by nurul 13/6/2019
    </script>
}