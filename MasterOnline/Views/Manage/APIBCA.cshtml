@using MasterOnline.Models
@using MasterOnline.ViewModels
@model MasterOnline.ViewModels.DataPerusahaanViewModel
@{
    ViewBag.Title = "API BCA";
    Layout = "~/Views/Shared/_LayoutManage.cshtml";

    //var dataSession = Session["SessionInfo"] as AccountUserViewModel;
    var username = "";
    var context = new MoDbContext("");
    //if (dataSession?.User != null)
    //{
    //    var accId = context.User.Single(u => u.Email == dataSession.User.Email).AccountId;
    //    username = context.Account.Single(a => a.AccountId == accId).Username;
    //    context.Dispose();
    //}
    //else
    //{
    //    username = dataSession?.Account.Username;
    //}

    var sessionAccount = HttpContext.Current.Session["SessionAccount"];
    var sessionAccountUserID = HttpContext.Current.Session["SessionAccountUserID"];
    var sessionAccountUserName = HttpContext.Current.Session["SessionAccountUserName"];
    var sessionAccountEmail = HttpContext.Current.Session["SessionAccountEmail"];
    var sessionAccountTglSub = HttpContext.Current.Session["SessionAccountTglSub"];
    var sessionAccountKodeSub = HttpContext.Current.Session["SessionAccountKodeSub"];
    var sessionAccountDataSourcePathDebug = HttpContext.Current.Session["SessionAccountDataSourcePathDebug"];
    var sessionAccountDataSourcePath = HttpContext.Current.Session["SessionAccountDataSourcePath"];
    var sessionAccountDatabasePathErasoft = HttpContext.Current.Session["SessionAccountDatabasePathErasoft"];

    var sessionUser = System.Web.HttpContext.Current.Session["SessionUser"];
    var sessionUserUserID = System.Web.HttpContext.Current.Session["SessionUserUserID"];
    var sessionUserUsername = System.Web.HttpContext.Current.Session["SessionUserUsername"];
    var sessionUserEmail = System.Web.HttpContext.Current.Session["SessionUserEmail"];
    var sessionUserAccountID = System.Web.HttpContext.Current.Session["SessionUserAccountID"];

    if (sessionUser != null)
    {
        var accId = context.User.Single(u => u.Email == sessionUserEmail.ToString()).AccountId;
        username = context.Account.Single(a => a.AccountId == accId).Username;
        context.Dispose();
    }
    else
    {
        username = sessionAccountUserName.ToString();
    }
}

@section styles
{
    <link href="~/Content/build/css/selectivity-jquery.min.css" rel="stylesheet" />

    <style>
        #data-usaha-section > div {
            background-color: #fff;
            padding: 20px;
        }

        #DataUsaha_ALAMAT_PT {
            resize: vertical;
            height: 100px;
            max-height: 100px;
        }

        .logo_perusahaan_section {
            padding: 0 10px 10px 10px;
        }

        .logo_perusahaan_section > .box_upload {
            width: 300px;
            height: 300px;
            border: dashed 1.5px #bbb;
            border-radius: 10px;
            background-color: #f7f7f7;
            background-image: url('');
            text-align: center;
            display: table;
            cursor: pointer;
        }

        .box_upload > .box_upload_placeholder {
            color: #ccc;
            font-size: 20px;
            display: table-cell;
            vertical-align: middle;
        }

        .btn_hapus_logo {
            position: absolute;
            bottom: 25px;
            left: 20px;
        }
    </style>
}

<div class="row" id="data-usaha-section">
    <div class="col-lg-12 col-md-12">
        <div class="col-lg-12">
            <div class="page-editor">
                <h2 class="editor-title">API BCA</h2>
                <span class="title-accent"></span>
                <div class="form-horizontal">
                    <div class="row">
                        <div class="col-md-12 col-sm-12 col-xs-12">
                            <div class="x_panel">
                                <div class="x_title">
                                    <h2 style="font-size: 16px">Detail Data</h2>
                                    <ul class="nav navbar-right panel_toolbox">
                                        <li>
                                            <a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                                        </li>
                                    </ul>
                                    <div class="clearfix"></div>
                                </div>
                                <div class="x_content">
                                    @if (ViewData.ModelState.Any(x => x.Value.Errors.Any()))
                                    {
                                        foreach (var modelError in ViewData.ModelState.SelectMany(x => x.Value.Errors))
                                        {
                                            <div class="alert alert-danger">
                                                <span class="message-error">@modelError.ErrorMessage</span>
                                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                        }
                                    }
                                    <br>
                                    @using (Html.BeginForm("SaveAPIBCA", "Manage", FormMethod.Post, new { enctype = "multipart/form-data" }))
                                    {
                                        @Html.HiddenFor(m => m.DataUsaha.USERNAME, new { Value = username })
                                        @Html.HiddenFor(m => m.DataUsaha.VALIDASI_U_MUKA, new { Value = "1" })
                                        @Html.HiddenFor(m => m.DataUsaha.KODE_BRG_STYLE, new { Value = "-" })
                                        @Html.HiddenFor(m => m.DataUsaha.GUDANG_SALESMAN, new { Value = "0" })
                                        @Html.HiddenFor(m => m.DataUsaha.BARANG_SAMA, new { Value = "0" })
                                        @Html.HiddenFor(m => m.DataUsaha.EDIT_BONUS, new { Value = "0" })
                                        @Html.HiddenFor(m => m.DataUsaha.VALIDASI_BRG_FAKTUR, new { Value = "0" })
                                        @Html.HiddenFor(m => m.DataUsaha.METODA_DISCOUNT, new { Value = "0" })
                                        
                                        <div class="form-group">
                                            @Html.LabelFor(m => m.DataUsaha.BCA_API_KEY, "BCA API KEY", new { @class = "control-label col-md-3 col-sm-3 col-xs-12" })
                                            <div class="col-md-6 col-sm-6 col-xs-12">
                                                @(Model?.DataUsaha?.NAMA_PT != "PT ERAKOMP INFONUSA" ? Html.TextBoxFor(m => m.DataUsaha.BCA_API_KEY, new { @class = "form-control" }) : Html.TextBoxFor(m => m.DataUsaha.BCA_API_KEY, new { @class = "form-control", Value = "" }))
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            @Html.LabelFor(m => m.DataUsaha.BCA_API_SECRET, "BCA API SECRET", new { @class = "control-label col-md-3 col-sm-3 col-xs-12" })
                                            <div class="col-md-6 col-sm-6 col-xs-12">
                                                @(Model?.DataUsaha?.NAMA_PT != "PT ERAKOMP INFONUSA" ? Html.TextBoxFor(m => m.DataUsaha.BCA_API_SECRET, new { @class = "form-control" }) : Html.TextBoxFor(m => m.DataUsaha.BCA_API_SECRET, new { @class = "form-control", Value = "" }))
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            @Html.LabelFor(m => m.DataUsaha.BCA_CLIENT_ID, "BCA CLIENT ID", new { @class = "control-label col-md-3 col-sm-3 col-xs-12" })
                                            <div class="col-md-6 col-sm-6 col-xs-12">
                                                @(Model?.DataUsaha?.NAMA_PT != "PT ERAKOMP INFONUSA" ? Html.TextBoxFor(m => m.DataUsaha.BCA_CLIENT_ID, new { @class = "form-control" }) : Html.TextBoxFor(m => m.DataUsaha.BCA_CLIENT_ID, new { @class = "form-control", Value = "" }))
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            @Html.LabelFor(m => m.DataUsaha.BCA_CLIENT_SECRET, "BCA CLIENT SECRET", new { @class = "control-label col-md-3 col-sm-3 col-xs-12" })
                                            <div class="col-md-6 col-sm-6 col-xs-12">
                                                @(Model?.DataUsaha?.NAMA_PT != "PT ERAKOMP INFONUSA" ? Html.TextBoxFor(m => m.DataUsaha.BCA_CLIENT_SECRET, new { @class = "form-control" }) : Html.TextBoxFor(m => m.DataUsaha.BCA_CLIENT_SECRET, new { @class = "form-control", Value = "" }))
                                            </div>
                                        </div>                                        
                                        <input type="button" class="btn btn-primary pull-right" value="Simpan" id="simpan_btn" onclick="simpanDataUsaha(this);"/>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts
{
    <script src="~/Content/build/js/selectivity-jquery.min.js" type="text/javascript"></script>
    <script>
        $(document).on('ready',
            function () {
                Initialize();
            });

        function Initialize() {
            $("input[type=file]").on("click",
                function (e) {
                    e.stopPropagation();
                });
        }

        function simpanDataUsaha(btnClicked) {
            if (!validateForm()) return false;

            var $form = $(btnClicked).parents('form');
            var $formData = new FormData($('form')[0]);

            $.ajax({
                type: "POST",
                url: $form.attr('action'),
                data: $formData,
                processData: false,
                contentType: false,
                beforeSend: function () {
                    //$('#loading_spinner').show();
                },
                success: function (response) {
                    if (response.Errors == null) {
                        if (response.Errors == null) {
                            alert('Data API BCA berhasil disimpan!');
                            window.location = '@Url.Action("Bantuan")';
                        } else {
                            console.log(response.Errors);
                            alert('Ada data yang tidak valid!');
                        }

                    } else {
                        console.log(response.Errors);
                        alert('Ada data yang tidak valid!');
                    }
                },
                error: function (xhr, status, error) {
                    console.log(error);
                }
            });

            return false;
        }

        
    </script>
}
