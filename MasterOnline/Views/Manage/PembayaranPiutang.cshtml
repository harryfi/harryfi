@model MasterOnline.ViewModels.BayarPiutangViewModel
@{
    ViewBag.Title = "Pembayaran Piutang";
    Layout = "~/Views/Shared/_LayoutManage.cshtml";

    var context = new MoDbContext("");
    var listErr = Model.Errors;
}

@section styles
{
    <link href="~/Content/build/css/bootstrap-datepicker.min.css" rel="stylesheet" />
    <link href="~/Content/build/css/selectivity-jquery.min.css" rel="stylesheet" />
    <link href="~/Content/selectize.css" rel="stylesheet" />

    <style>
        #div-scroll-list {
            overflow-x: hidden;
            overflow-y: scroll;
            height: 380px;
        }

        .input-group {
            margin-bottom: 0;
        }

        .btn-success[disabled]:hover {
            background: #6ad6bf;
            border-color: #6ad6bf;
        }

        table#table_tambah_piutang thead tr {
            background-color: #c7f1f5;
        }

        .qty-input {
            width: 50px;
        }

        .disc-input {
            width: 50px;
        }

        .ndisc-input {
            width: 100px;
        }

        #FAKTUR {
            width: 120px !important;
        }

        @@media screen and (max-width: 767px) {
            .table-responsive {
                width: 44%;
            }

            .dataTables_paginate a {
                padding: 3px !important;
            }

            .addpixeltpiutang {
                width: 813px;
            }

            .addpixeltpiutangbyr {
                width: 780px;
            }

            .addpixelmodaltpiutang2 {
                width: 52%;
            }

            .addpixelmodaltpiutang {
                width: 35%;
            }

            .modalresponsive {
                width: 100%;
            }
        }

        @@media screen and (max-width: 325px) {
            .table-responsive {
                width: 35%;
            }
        }

        .hscroll {
            overflow-x: auto; /* Horizontal */
        }
    </style>
    <style>
        #loading_upload {
            display: none;
            width: 100%;
            height: 100%;
            position: fixed;
            z-index: 100;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background-color: rgba(0,0,0,.5);
        }

        #loading_upload_image {
            width: 20px;
            height: 20px;
            margin-top: -90px;
            margin-left: -90px;
            position: absolute;
            top: 50%;
            left: 50%;
            border-width: 30px;
            border-radius: 50%;
        }
    </style>
}

<div class="row">
    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <div class="" role="tabpanel" data-example-id="togglable-tabs">
            <ul id="myTab" class="nav nav-tabs" role="tablist">
                <li role="presentation" class="active">
                    <a href="#tab_content1" id="piutang-tab" role="tab" data-toggle="tab" aria-expanded="true">Pembayaran Piutang</a>
                </li>
                @*<li role="presentation" class="">
                        <a href="#tab_content2" role="tab" id="nunggu-tab" data-toggle="tab" aria-expanded="false">Menunggu Pembayaran</a>
                    </li>
                    <li role="presentation" class="">
                        <a href="#tab_content4" role="tab" id="sedangproses-tab" data-toggle="tab" aria-expanded="false">Dalam Proses</a>
                    </li>
                    <li role="presentation" class="">
                        <a href="#tab_content6" role="tab" id="sudahkirim-tab" data-toggle="tab" aria-expanded="false">Sudah Dikirim</a>
                    </li>
                    <li role="presentation" class="">
                        <a href="#tab_content7" role="tab" id="selesai-tab" data-toggle="tab" aria-expanded="false">Selesai</a>
                    </li>*@
            </ul>
            <div id="myTabContent" class="tab-content" style="padding-top:10px">
                <div role="tabpanel" class="tab-pane fade active in" id="tab_content1" aria-labelledby="piutang-tab">
                    <div class="row piutang_table_section">
                        <div class="col-lg-4 col-sm-6" style="margin-bottom:7px;">
                            <div class="input-group">
                                <input id="search_piutang" type="text" class="form-control" placeholder="Pencarian">
                                <span class="input-group-btn">
                                    <button type="button" id="search_piutang_click" class="btn btn-primary">
                                        <i class="fa fa-search"></i>
                                    </button>
                                </span>
                            </div>
                        </div>
                        <div class="col-lg-8 col-sm-6">
                            <div class="pull-right">
                                @*<button type="button" class=" btn btn-default" data-style="expand-right">
                                        <span>Refresh</span>
                                    </button>*@
                                <button class="btn btn-primary btn_tambah_data" id="tambah_piutang">Tambah Baru</button>
                            </div>
                        </div>
                    </div>
                    <div class="row piutang_table_section" style="margin-top: 5px;">
                        <div class="col-sm-12 addpixeltpiutang" id="table-piutang-partial">
                            @*@Html.Partial("TableBayarPiutangPartial")*@
                        </div>
                    </div>
                    <div class="row piutang_editor_section" style="display: none;">
                        <div class="col-lg-12 modalresponsive">
                            <div class="page-editor">
                                <h2 class="editor-title">Pembayaran Piutang</h2>
                                <span class="title-accent"></span>
                                <button id="close-editor-1" type="button" class="pull-right page-close">
                                    <span class="close-btn thick"></span>
                                </button>
                                @if (ViewData.ModelState.Any(x => x.Value.Errors.Any()))
                                {
                                    foreach (var modelError in ViewData.ModelState.SelectMany(x => x.Value.Errors))
                                    {
                                        <div class="alert alert-danger">
                                            <span class="message-error">@modelError.ErrorMessage</span>
                                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                    }
                                }
                                @using (Html.BeginForm("SavePiutang", "Manage", FormMethod.Post, new { enctype = "multipart/form-data", id = "form-piutang" }))
                                {
                                    <div id="form-partial">
                                        @*@Html.Partial("DetailBayarPiutangPartial")*@
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
                @*<div role="tabpanel" class="tab-pane fade" id="tab_content2" aria-labelledby="nunggu-tab">
                        <div class="row">
                            <div class="col-lg-4 col-sm-6">
                                <div class="input-group">
                                    <input id="search_nunggu" type="text" class="form-control" placeholder="Pencarian">
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-primary">
                                            <i class="fa fa-search"></i>
                                        </button>
                                    </span>
                                </div>
                            </div>
                            <div class="col-lg-8 col-sm-6">
                                <div class="pull-right">
                                    <button type="button" class=" btn btn-default" data-style="expand-right">
                                        <span>Refresh</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="row" style="margin-top: 5px;">
                            <div class="col-sm-12">
                                <table id="datatable_nunggu" class="table table-striped table-bordered dataTable" role="grid" aria-describedby="datatable_info">
                                    <thead>
                                        <tr role="row">
                                            <th class="sorting_asc" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-sort="ascending" aria-label="Name: activate to sort column descending" style="width: 130px;">No. Order</th>
                                            <th class="sorting" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-label="Position: activate to sort column ascending" style="width: 100px;">Tanggal Piutang</th>
                                            <th class="sorting" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-label="Office: activate to sort column ascending" style="width: 117px;">Marketplace</th>
                                            <th class="sorting" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-label="Age: activate to sort column ascending" style="width: 90px;">Pembeli</th>
                                            <th class="sorting" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-label="Start date: activate to sort column ascending" style="width: 115px;">Total</th>
                                            <th class="sorting" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-label="Salary: activate to sort column ascending" style="width: 50px; max-width: 50px;">Edit</th>
                                            <th class="sorting" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-label="Status: activate to sort column ascending" style="width: 50px; max-width: 50px;">Hapus</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var piutang in Model.ListPiutang)
                                        {
                                            var pemesanRecNum = Convert.ToInt32(piutang.NAMA);
                                            var buyer = Model.ListPembeli.Single(m => m.RecNum == pemesanRecNum);
                                            var marketCust = Convert.ToInt32(piutang.SUPP);
                                            var pelanggan = Model.ListPelanggan.Single(m => m.RecNum == marketCust);
                                            var idMarket = Convert.ToInt32(pelanggan.NAMA);
                                            <tr>
                                                <td>@piutang.INV</td>
                                                <td>@piutang.TGL</td>
                                                <td>@Model.ListMarketplace.Single(m => m.IdMarket == idMarket).NamaMarket</td>
                                                <td>
                                                    @(buyer.NAMA + " (" + buyer.PERSO + ")")
                                                </td>
                                                <td>@String.Format(CultureInfo.CreateSpecificCulture("id-id"), "{0:N}", piutang.NETTO)</td>
                                                <td class="edit-hapus-col">
                                                    <button class="btn btn-primary" onclick="editPiutang(@piutang.RecNum)">
                                                        <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
                                                    </button>
                                                </td>
                                                <td class="edit-hapus-col">
                                                    <button class="btn btn-danger" data-toggle="modal" data-target="#konfHapusPiutang" onclick="pass(@piutang.RecNum)">
                                                        <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div role="tabpanel" class="tab-pane fade" id="tab_content4" aria-labelledby="sedangproses-tab">
                        <div class="row">
                            <div class="col-lg-4 col-sm-6">
                                <div class="input-group">
                                    <input id="search_sedangproses" type="text" class="form-control" placeholder="Pencarian">
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-primary">
                                            <i class="fa fa-search"></i>
                                        </button>
                                    </span>
                                </div>
                            </div>
                            <div class="col-lg-8 col-sm-6">
                                <div class="pull-right">
                                    <button type="button" class=" btn btn-default" data-style="expand-right">
                                        <span>Refresh</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="row" style="margin-top: 5px;">
                            <div class="col-sm-12">
                                <table id="datatable_sedangproses" class="table table-striped table-bordered dataTable" role="grid" aria-describedby="datatable_info">
                                    <thead>
                                        <tr role="row">
                                            <th class="sorting_asc" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-sort="ascending" aria-label="Name: activate to sort column descending" style="width: 130px;">No. Pengambilan</th>
                                            <th class="sorting" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-label="Position: activate to sort column ascending" style="width: 140px;">No. Piutang</th>
                                            <th class="sorting" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-label="Office: activate to sort column ascending" style="width: 117px;">Tgl. Piutang</th>
                                            <th class="sorting" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-label="Age: activate to sort column ascending" style="width: 60px;">Pelanggan</th>
                                            <th class="sorting" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-label="Start date: activate to sort column ascending" style="width: 90px;">Lokasi</th>
                                            <th class="sorting" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-label="Salary: activate to sort column ascending" style="width: 90px;">Sumber</th>
                                            <th class="sorting" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-label="Status: activate to sort column ascending" style="width: 120px;">Status Pengambilan</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div role="tabpanel" class="tab-pane fade" id="tab_content6" aria-labelledby="sudahkirim-tab">
                        <div class="row">
                            <div class="col-lg-4 col-sm-6">
                                <div class="input-group">
                                    <input id="search_sudahkirim" type="text" class="form-control" placeholder="Pencarian">
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-primary">
                                            <i class="fa fa-search"></i>
                                        </button>
                                    </span>
                                </div>
                            </div>
                            <div class="col-lg-8 col-sm-6">
                                <div class="pull-right">
                                    <button type="button" class=" btn btn-default" data-style="expand-right">
                                        <span>Refresh</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="row" style="margin-top: 5px;">
                            <div class="col-sm-12">
                                <table id="datatable_sudahkirim" class="table table-striped table-bordered dataTable" role="grid" aria-describedby="datatable_info">
                                    <thead>
                                        <tr role="row">
                                            <th class="sorting_asc" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-sort="ascending" aria-label="Name: activate to sort column descending" style="width: 130px;">No. Piutang</th>
                                            <th class="sorting" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-label="Position: activate to sort column ascending" style="width: 259px;">Tgl. Piutang</th>
                                            <th class="sorting" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-label="Office: activate to sort column ascending" style="width: 117px;">Sumber</th>
                                            <th class="sorting" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-label="Age: activate to sort column ascending" style="width: 60px;">Pelanggan</th>
                                            <th class="sorting" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-label="Start date: activate to sort column ascending" style="width: 115px;">Alamat Kirim</th>
                                            <th class="sorting" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-label="Salary: activate to sort column ascending" style="width: 90px;">Kurir</th>
                                            <th class="sorting" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-label="Status: activate to sort column ascending" style="width: 90px;">Resi</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div role="tabpanel" class="tab-pane fade" id="tab_content7" aria-labelledby="selesai-tab">
                        <div class="row">
                            <div class="col-lg-4 col-sm-6">
                                <div class="input-group">
                                    <input id="search_selesai" type="text" class="form-control" placeholder="Pencarian">
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-primary">
                                            <i class="fa fa-search"></i>
                                        </button>
                                    </span>
                                </div>
                            </div>
                            <div class="col-lg-8 col-sm-6">
                                <div class="pull-right">
                                    <button type="button" class=" btn btn-default" data-style="expand-right">
                                        <span>Refresh</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="row" style="margin-top: 5px;">
                            <div class="col-sm-12">
                                <table id="datatable_selesai" class="table table-striped table-bordered dataTable" role="grid" aria-describedby="datatable_info">
                                    <thead>
                                        <tr role="row">
                                            <th class="sorting_asc" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-sort="ascending" aria-label="Name: activate to sort column descending" style="width: 130px;">Nomor</th>
                                            <th class="sorting" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-label="Position: activate to sort column ascending" style="width: 100px;">Tanggal Piutang</th>
                                            <th class="sorting" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-label="Office: activate to sort column ascending" style="width: 117px;">Pelanggan</th>
                                            <th class="sorting" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-label="Age: activate to sort column ascending" style="width: 60px;">Lokasi</th>
                                            <th class="sorting" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-label="Start date: activate to sort column ascending" style="width: 115px;">Nilai</th>
                                            <th class="sorting" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-label="Salary: activate to sort column ascending" style="width: 90px;">Sumber</th>
                                            <th class="sorting" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-label="Status: activate to sort column ascending" style="width: 90px;">Status Market</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>*@
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="konfHapusPiutang" tabindex="-1" role="dialog" aria-labelledby="konfirmasiHapusLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content addpixelmodaltpiutang">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="konfirmasiHapusLabel">Konfirmasi</h4>
            </div>
            <div class="modal-body">
                <div class="row text-center">
                    <h4>Apakah Anda yakin ingin menghapus piutang ini?</h4>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Tidak</button>
                <button type="button" class="btn btn-success" onclick="deletePiutang();">Ya</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="konfHapusFaktur" tabindex="-1" role="dialog" aria-labelledby="konfirmasiHapusLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content addpixelmodaltpiutang2">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="konfirmasiHapusLabel">Konfirmasi</h4>
            </div>
            <div class="modal-body">
                <div class="row text-center">
                    <h4>Apakah Anda yakin ingin menghapus faktur ini?</h4>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Tidak</button>
                <button type="button" class="btn btn-success" onclick="deleteDetail();">Ya</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="konfAutoload" tabindex="-1" role="dialog" aria-labelledby="konfirmasiAutoload">
    <div class="modal-dialog" role="document">
        <div class="modal-content addpixelmodaltpiutang2">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="konfirmasiAutoload">Autoload Pembayaran Piutang</h4>
            </div>
            <div class="modal-body">
                @*<div class="row text-center">
                        <h4>Apakah Anda ingin autoload faktur dengan periode di bawah?</h4>
                    </div>*@
                @*<div class="row">
                        <label class="col-md-4 col-sm-4 col-xs-12 control-label">Dari Tanggal :</label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                            <div class="input-group date">
                                <input type="text" id="DR_TGL" class="form-control" />
                                <span class="input-group-addon">
                                    <span class="glyphicon glyphicon-calendar"></span>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <label class="col-md-4 col-sm-4 col-xs-12 control-label"> Sampai Tanggal :</label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                            <div class="input-group date">
                                <input type="text" id="SD_TGL" class="form-control" />
                                <span class="input-group-addon">
                                    <span class="glyphicon glyphicon-calendar"></span>
                                </span>
                            </div>
                        </div>
                    </div>*@
                @*//add by nurul 21/6/2019*@
                <div class="row">
                    @Html.Label("Masukkan nilai yang akan ditarik dari marketplace !", new { @class = "col-md-12 col-sm-12 control-label" })
                </div>
                <div class="row">
                    @Html.Label("Nilai ini akan melunasi faktur-faktur yang belum lunas urut berdasarkan data faktur terlama", new { @class = "col-md-12 col-sm-12 control-label" })
                </div>
                <br />
                @*//end add by nurul 21/6/2019*@
                <div class="row">
                    @*@Html.Label("Total Pelunasan", new { @class = "col-md-4 col-sm-4 control-label control-label-bold" })*@
                    @Html.Label("Total Penarikan", new { @class = "col-md-4 col-sm-4 control-label control-label-bold" })
                    <div class="col-md-6">
                        @*@Html.TextBoxFor(m => m.bayarPiutang, new { Value = 0, @class = "form-control", type = "number", min = 0 })*@
                        <input type="number" id="BAYAR_PIUTANG" class="form-control" />
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-success" onclick="autoloadFaktur();">Autoload</button>
            </div>
        </div>
    </div>
</div>
@*//add by nurul 18/10/2019*@
<div class="modal fade" id="konfUpload" tabindex="-1" role="dialog">
    <div class="modal-dialog" id="modal-upload" role="document">
        @*<div class="modal-content modalresponsive">*@
        <div class="modal-content" modalresponsive >
            @*<div id="loading_upload" class="text-center">
                    <div id="loading_upload_image">
                        <img src="~/Content/Images/spinner.gif" />
                    </div>
                </div>*@
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="uploadlabel">Upload Pembayaran</h4>
            </div>
            <div class="modal-body" id="modal-upload-body" style="margin:auto;height:450px">
                <div class="row">
                    <div class="col-md-11">
                        <div id="note_shopee" style="display:none">
                            <h5>Anda bisa “UPLOAD” data pembayaran piutang ke MasterOnline (MO), tanpa harus input satu per satu.</h5>
                            <h5>Untuk Marketplace Shopee dengan cara :</h5>
                            <h5>
                                1. Buka https://seller.shopee.co.id/
                            </h5>
                            <h5>2. Klik Saldo Saya</h5>
                            <h5>3. Isi password akun Anda bila diminta</h5>
                            <h5>4. Klik Lihat Riwayat Transaksi</h5>
                            <h5>5. Pilih rentang tanggal yang diinginkan</h5>
                            <h5>6. Klik Export</h5>
                            <h5>7. Klik Download</h5>
                            <h5>8. Save di direktori yang diinginkan</h5>
                        </div>
                        <div id="note_tokopedia" style="display:none">
                            <h5>Anda bisa “UPLOAD” data pembayaran piutang ke MasterOnline (MO), tanpa harus input satu per satu.</h5>
                            <h5>Untuk Marketplace Tokopedia dengan cara :</h5>
                            <h5>
                                1. Buka https://www.tokopedia.com/
                            </h5>
                            <h5>2. Klik Saldo</h5>
                            <h5>3. Pilih rentang tanggal yang diinginkan</h5>
                            <h5>4. Klik Ekspor Riwayat</h5>
                            <h5>5. Save di direktori yang diinginkan</h5>
                        </div>
                        <div id="note_lazada" style="display:none">
                            <h5>Anda bisa “UPLOAD” data pembayaran piutang ke MasterOnline (MO), tanpa harus input satu per satu.</h5>
                            <h5>Untuk Marketplace Lazada dengan cara :</h5>
                            <h5>
                                1. Buka https://sellercenter.lazada.co.id/
                            </h5>
                            <h5>2. Arahkan kursor ke "Keuangan"</h5>
                            <h5>3. Klik "Laporan Akun"</h5>
                            <h5>4. Pilih rentang tanggal yang diinginkan</h5>
                            <h5>5. Klik "Export"</h5>
                            <h5>6. Klik "Download"</h5>
                            <h5>7. Save di direktori yang diinginkan</h5>
                        </div>
                        <div id="note_bukalapak" style="display:none">
                            <h5>Anda bisa “UPLOAD” data pembayaran piutang ke MasterOnline (MO), tanpa harus input satu per satu.</h5>
                            <h5>Untuk Marketplace Bukalapak dengan cara :</h5>
                            <h5>
                                1. Buka https://www.bukalapak.com/
                            </h5>
                            <h5>2. Klik nominal di halaman bagian atas (nominal tiap akun besarnya berbeda2)</h5>
                            <h5>3. Klik "Detail" pada BukaDompet</h5>
                            <h5>4. Pilih rentang tanggal yang diinginkan</h5>
                            <h5>5. Klik tombol download</h5>
                            <h5>6. Save di direktori yang diinginkan</h5>
                        </div>
                        <div id="note_blibli" style="display:none">
                            <h5>Anda bisa “UPLOAD” data pembayaran piutang ke MasterOnline (MO), tanpa harus input satu per satu.</h5>
                            <h5>Untuk Marketplace Blibli dengan cara :</h5>
                            <h5>
                                1. Buka https://merchant.blibli.com/
                            </h5>
                            <h5>2. Arahkan kursor ke "Laporan"</h5>
                            <h5>3. Klik "Dokumen Pembayaran"</h5>
                            <h5>4. Download file yang diinginkan</h5>
                            <h5>5. Save di direktori yang diinginkan</h5>
                        </div>
                    </div>
                </div>
                <br />
                <div class="row">
                    <div class="col-md-8 file_upload_section">
                        <input type='file' id='file_upload_excel' name="file_upload_faktur" onchange="checkfile(this);"
                               accept="application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,.csv" />
                    </div>
                    <div class="col-md-4">
                        @*<button type="button" class="btn btn-primary pull-right" onclick="uploadFile();" data-style="expand-right">*@
                        <button type="button" class="btn btn-primary pull-right" id="btnUploadExcelPiutang" onclick="uploadExcelPP();" data-style="expand-right">
                            <span>Upload</span>
                        </button>
                    </div>
                </div>
                @*<div>
            <input type="button" class="btn btn-primary pull-right" id="log_btn" value="Lihat Log" onclick="ViewLog()" />
        </div>*@
                @*<div id="uploadbrgviewdiv" class="row">
        </div>*@

                @*//add by nurul 2/4/2020*@
                @*<div class="col-md-12">
            <div id="loading_upload" class="text-center" hidden="hidden">
                <div id="loading_upload_image">
                    <img src="~/Content/Images/spinner.gif" />
                </div>
            </div>
        </div>*@
                <br />
                <div class="col-md-12">
                    <div id="progressBarDownload" class="text-center" style="display:none;">
                        <table class="col-md-12" id="tbl_progbar2">
                            <tr>
                                <td class="col-md-2">
                                    <label id="lblPBDownload"></label>
                                </td>
                                <td class="col-md-10">
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-success progress-bar-striped active" role="progressbar" id="pBar_DownloadFile"
                                             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:0%">
                                            0% Complete (success)
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="col-md-12">
                    <div id="progressBarUpload" class="text-center" style="display:none;">
                        <table class="col-md-12" id="tbl_progbar2">
                            <tr>
                                <td class="col-md-2">
                                    <label id="lblPBUpload"></label>
                                </td>
                                <td class="col-md-10">
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-success progress-bar-striped active" role="progressbar" id="pBar_uploadFile"
                                             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:0%">
                                            0% Complete (success)
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                @*//end add by nurul 2/4/2020*@
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Tutup</button>
                @*<button type="button" class="btn btn-success" onclick="closeEditor()">Ya</button>*@
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="konfCreatePot" tabindex="-1" role="dialog">
    <div class="modal-dialog" id="modal-create" role="document">
        <div class="modal-content modalresponsive">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="createlabel">Konfirmasi Pelunasan</h4>
            </div>
            <div class="modal-body" id="modal-create-body">
                @*<div id="loading_pot" class="text-center">
                        <img src="~/Content/Images/spinner.gif" width="100" />
                    </div>*@
                <div class="row">
                    <div class="col-md-10 ">
                        <h5>Proses ini akan melunasi faktur. Apakah anda yakin akan melakukan pelunasan?</h5>
                    </div>
                    <div class="col-md-4"></div>

                </div>
                <br />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary pull-right" onclick="createPOT();">Proses</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="progressBarUpload" tabindex="-1" role="dialog" aria-labelledby="modalProgressLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content" style="margin:auto;height:100px;width:800px;">
            <div class="modal-body">
                <table class="col-md-12" id="tbl_progbar2">
                    <tr>
                        <td class="col-md-2">
                            <label id="lblPBUpload"></label>
                        </td>
                        <td class="col-md-10">
                            <div class="progress">
                                <div class="progress-bar progress-bar-success progress-bar-striped active" role="progressbar" id="pBar_uploadFile"
                                     aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:0%">
                                    0% Complete (success)
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Tutup</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modalError" tabindex="-1" role="dialog" aria-labelledby="modalErrorLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content" style="width:700px;">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="modalErrorLabel">List Error</h4>
            </div>
            <div class="modal-body edit-content" id="error-list">
                @*<div id="loading_error" class="text-center">
                        <img src="~/Content/Images/spinner.gif" width="100" />
                    </div>*@
                @*@Html.Partial("ListErrorPembayaranPiutang", listErr)*@
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Tutup</button>
            </div>
        </div>
    </div>
</div>
@*//end add by nurul 18/10/2019*@

@section scripts
{
    <script src="//cdn.datatables.net/plug-ins/1.10.11/sorting/date-eu.js" type="text/javascript"></script>
    <script src="~/Content/build/js/bootstrap-datepicker.min.js" type="text/javascript"></script>
    <script src="~/Content/build/js/selectivity-jquery.min.js" type="text/javascript"></script>
    <script src="~/Content/vendors/moment/min/moment.min.js" type="text/javascript"></script>
    <script src="~/Content/selectize.js" type="text/javascript"></script>
    <script src='@Url.Content("~/Scripts/jquery.validate.js")' type='text/javascript'></script>
    <script src='@Url.Content("~/Scripts/jquery.validate.unobtrusive.js")' type='text/javascript'></script>

    <script type="text/javascript">
        var tempNobuk = "";
        var tempLog = "";
        var $tempErr = [];
        var $tempMP1 = "";
        var $tempMP = "";
        var $modeEdit = 0; // 0 new, 1 edit
        //add by nurul 12/2/2019
        var $page = window.text;
            //end add by nurul 12/2/2019
        $(document).ready(function () {
            $("#konfUpload").on('hidden.bs.modal', function (e) {
                //$('#progressBarUpload').modal('hide');
                $('#progressBarUpload').hide();
                $('#progressBarDownload').hide();
                refreshTablePiutang1();
            });
            refreshTablePiutang1();
            //add by nurul 12/2/2019
            $page = 0;
            //end add by nurul 12/2/2019
            var tableSiapProses = $('#datatable_siapproses').DataTable({
                columnDefs: [{
                    orderable: false,
                    className: 'select-checkbox',
                    targets: 0
                }],
                select: {
                    style: 'os',
                    selector: 'td:first-child'
                }
            });

            $('#search_siapproses').keyup(function () {
                tableSiapProses.search($(this).val()).draw();
            });

            //Initialize();
            //add by nurul 12/2/2019
            //$('#datatable').on('page.dt', function () {
            //    $page = $('#datatable').DataTable().page.info().page;
            //});
            //$('#datatable').DataTable().page($page).draw(false);
                    //end add by nurul 12/2/2019

            $('#search_piutang').keypress(function (e) {
                var key = e.which;
                if (key == 13)// the enter key code
                {
                    searchTablePiutang1();
                    return false;
                }
            });
            $('#search_piutang_click').click(function () {
                searchTablePiutang1();
            });
            $('#tambah_piutang').on('click', function () {
                //$('.piutang_table_section').hide();
                //$('.piutang_editor_section').show();
                //$('#TGL').change();
                refreshForm1();
            });

            $('#close-editor-1').on('click', function () {

                $('input, select, .btn-danger').each(function () {
                    $(this).removeAttr('disabled');
                });
                $("#modalError").on('show.bs.modal', function (e) {
                    var $modal = $(this);
                    $modal.find('.edit-content').html('');
                });

                $('.piutang_table_section').show();
                $('.piutang_editor_section').hide();
                //refreshForm1();
                refreshTablePiutang1();
                $modeEdit = 0; // 0 new, 1 edit
                //add by nurul 12/2/2019
                //$('#datatable').on('page.dt', function () {
                //    $page = $('#datatable').DataTable().page.info().page;
                //});
                //$('#datatable').DataTable().page($page).draw(false);
                //end add by nurul 12/2/2019
                tempLog = "";
                tempNobuk = "";
            });

        });

        //var table = $('#datatable').DataTable({
        //    "order": [[0,1, "desc"]], //or asc
        //    "columnDefs": [{ "targets": 1, "type": "date-eu" }],
        //});

        function Initialize() {
            $('#konfAutoload').modal('hide');
            //var table = $('#datatable').DataTable();
            //var tableNunggu = $('#datatable_nunggu').DataTable();
            //var tableSedangProses = $('#datatable_sedangproses').DataTable();
            //var tableSiapKirim = $('#datatable_siapkirim').DataTable();
            //var tableSudahKirim = $('#datatable_sudahkirim').DataTable();
            //var tableSelesai = $('#datatable_selesai').DataTable();

            //$('#search_piutang').keyup(function () {
            //    table.search($(this).val()).draw();
            //});
            $('#search_piutang').keypress(function (e) {
                var key = e.which;
                if (key == 13)// the enter key code
                {
                    searchTablePiutang1();
                    return false;
                }
            });
            $('#search_piutang_click').click(function () {
                searchTablePiutang1();
            });

            //$('#search_selesai').keyup(function () {
            //    tableSelesai.search($(this).val()).draw();
            //});

            //$('#search_nunggu').keyup(function () {
            //    tableNunggu.search($(this).val()).draw();
            //});

            //$('#search_sedangproses').keyup(function () {
            //    tableSedangProses.search($(this).val()).draw();
            //});

            //$('#search_siapkirim').keyup(function () {
            //    tableSiapKirim.search($(this).val()).draw();
            //});

            //$('#search_sudahkirim').keyup(function () {
            //    tableSudahKirim.search($(this).val()).draw();
            //});

            //$('input[name="select_all"]').on('click',
            //    function () {
            //        var attr = $(this).attr('checked');

            //        if (typeof attr !== typeof undefined && attr !== false) {
            //            $('input[name="data-1"]').removeAttr('checked');
            //            $('input[name="data-2"]').removeAttr('checked');
            //        } else {
            //            $('input[name="data-1"]').attr('checked', 'checked');
            //            $('input[name="data-2"]').attr('checked', 'checked');
            //        }
            //    });

            //$('#tambah_piutang').on('click', function () {
            //    //$('.piutang_table_section').hide();
            //    //$('.piutang_editor_section').show();
            //    //$('#TGL').change();
            //    refreshForm1();
            //});

            //$('#close-editor-1').on('click', function () {

            //    $('input, select, .btn-danger').each(function() {
            //        $(this).removeAttr('disabled');
            //    });

            //    $('.piutang_table_section').show();
            //    $('.piutang_editor_section').hide();
            //    //refreshForm1();
            //    refreshTablePiutang1();
            //    $modeEdit = 0; // 0 new, 1 edit
            //    //add by nurul 12/2/2019
            //    //$('#datatable').on('page.dt', function () {
            //    //    $page = $('#datatable').DataTable().page.info().page;
            //    //});
            //    //$('#datatable').DataTable().page($page).draw(false);
            //        //end add by nurul 12/2/2019
            //});

            if ($('.message-error').text() !== '') {
                $('#tambah_piutang').click();
            }

            $('#table_tambah_piutang > tbody > tr > td.editable-kode').prop('contentEditable', true);

            //getTanggal();
            //getMarketplace();
            //getFaktur(null);

            //refreshInputan();

            //if ($('#Piutang_TGL').val() != '') {
            //    var $tgl = $('#Piutang_TGL').val();
            //    $('#TGL').val($tgl.format('dd/MM/yyyy'));
            //} else {
            //    var $tgl = $('#TGL').val();
            //    $('#Piutang_TGL').val($tgl.format('dd/MM/yyyy'));
            //}
            if ($('#Piutang_TGL').val() != '') {
                $('#TGL').val($('#Piutang_TGL').val());
            } else {
                $('#Piutang_TGL').val($('#TGL').val());
            }


            //add by nurul 12/2/2019
            //$('#datatable').on('page.dt', function () {
            //    $page = $('#datatable').DataTable().page.info().page;
            //});
            //$('#datatable').DataTable().page($page).draw(false);
                    //end add by nurul 12/2/2019
        }

        function getTanggal() {
            //if ($modeEdit == 1) { // mode edit
            //    $('#TGL').datepicker({
            //        format: 'dd/mm/yyyy',
            //        language: 'id'
            //    }).change(function () {
            //        //var $tgl = moment($(this).val(), "DD/MM/YYYY");
            //        $('#Piutang_TGL').val($(this).val());
            //        $('#TGL').datepicker('hide');
            //        $('#btn-simpan-perubahan-row').show();
            //    });
            //}
            //else { //new
            //    $('#TGL').datepicker({
            //        format: 'dd/mm/yyyy',
            //        language: 'id'
            //    }).datepicker('setDate', '0').change(function () {
            //        //var $tgl = moment($(this).val(), "DD/MM/YYYY");
            //        $('#Piutang_TGL').val($(this).val());
            //        $('#TGL').datepicker('hide');

            //        $modeEdit = 1;
            //        $('#btn-simpan-perubahan-row').show();
            //    });
            //}
            if ($modeEdit == 1) {
                $('#TGL').datepicker({
                    format: 'dd/mm/yyyy',
                    language: 'id'
                }).change(function () {
                    $('#Piutang_TGL').val($(this).val());
                    //add by nurul 31/10/2018
                    $(this).datepicker('hide');
                    //end add
                });
            } else {
                $('#TGL').datepicker({
                    format: 'dd/mm/yyyy',
                    language: 'id'
                }).datepicker('setDate', '0').change(function () {
                    $('#Piutang_TGL').val($(this).val());
                    //add by nurul 31/10/2018
                    $(this).datepicker('hide');
                    //end add
                    $modeEdit = 1;
                });
            }


            if ($('#Piutang_TGL').val() != '') {
                $('#TGL').val($('#Piutang_TGL').val().substr(0, 10));
            } else {
                $('#Piutang_TGL').val($('#TGL').val());
            }
            ////$('#TGL').datepicker({
            ////    format: 'dd/mm/yyyy',
            ////    language: 'id'
            ////}).datepicker('setDate', '0').change(function () {
            ////    $('#Piutang_TGL').val($(this).val());
            ////    //add by nurul 31/10/2018
            ////    $(this).datepicker('hide');
            ////    //end add
            ////    });

            //$('#DR_TGL').datepicker({
            //    format: 'dd/mm/yyyy',
            //    language: 'id'
            //}).datepicker('setDate', '0').change(function () {
            //    $('#drTgl').val($(this).val());
            //    //add by nurul 31/10/2018
            //    $(this).datepicker('hide');
            //    //end add
            //    });
            //$('#SD_TGL').datepicker({
            //    format: 'dd/mm/yyyy',
            //    language: 'id'
            //}).datepicker('setDate', '0').change(function () {
            //    $('#drTgl').val($(this).val());
            //    //add by nurul 31/10/2018
            //    $(this).datepicker('hide');
            //    //end add
            //});
        }

        var $flagPerubahan = 0;

        function refreshInputan() {
            //if ($('#Piutang_tgl').val() != '') {
            //    var $tgl = $('#Piutang_TGL').val();
            //    $('#TGL').val($tgl.format('dd/MM/yyyy'));
            //    //$('#TGL').val($('#Piutang_TGL').val());
            //}
            if ($('#Piutang_tgl').val() != '') {
                $('#TGL').val($('#Piutang_tgl').val());
            }

            $('#TOTALBAYAR').attr('readonly', 'readonly').css('background-color', '#eee')
                .css('cursor', 'not-allowed');
            //ADD BY NURUL 10/10/2018
            $('#TOTALBYR').attr('readonly', 'readonly').css('background-color', '#eee')
                .css('cursor', 'not-allowed');
            $('#TOTALPOT').attr('readonly', 'readonly').css('background-color', '#eee')
                .css('cursor', 'not-allowed');
            $('#TOTALLUNAS').attr('readonly', 'readonly').css('background-color', '#eee')
                .css('cursor', 'not-allowed');
            $('#TOTALSELISIH').attr('readonly', 'readonly').css('background-color', '#eee')
                .css('cursor', 'not-allowed');
            $('#TOTALLEBIH').attr('readonly', 'readonly').css('background-color', '#eee')
                .css('cursor', 'not-allowed');
            //END ADD

            // ==== Update Data ====
            $('#Piutang_TGL').change(function () {
                if ($flagPerubahan == 1) {
                    $('#btn-simpan-perubahan-row').show();
                }

                $flagPerubahan++;
            });

            $('#btn-simpan-perubahan').click(function () {
                var $this = $(this);
                $.ajax({
                    type: "POST",
                    url: '@Url.Action("UpdateBayarPiutang", "Manage")',
                    data: JSON.stringify({
                        OrderId: "@(Model?.Piutang?.BUKTI)",
                        Tgl: $('#Piutang_tgl').val()
                    }),
                    contentType: 'application/json; charset=UTF-8',
                    cache: false,
                    success: function () {
                        alert('Data piutang berhasil di-update');
                        $this.hide();
                    },
                    error: function (xhr) {
                        console.log(xhr);
                    }
                });
            });


            //var $totalPot = 0;
            //var $totalBayar = 0;
            //var $totalSemua = 0;

            //$('tr[data-piutang-id="0"] #PiutangDetail_POT').change(function () {
            //    //$totalSemua = parseInt($('#PiutangDetail_POT').val()) + parseInt($('#PiutangDetail_BAYAR').val());
            //    $totalPot = convertToAngka($('#TOTALPOT').val()) + parseInt($('#HutangDetail_POT').val());
            //    $('tr[data-piutang-id="0"] .span-potongan-piutang').text(convertToRupiah($(this).val()));
            //    $('#TOTALPOT').val(convertToRupiah($totalPot));
            //    $totalSemua = $totalPot + convertToAngka($('#TOTALBYR').val());
            //    $('#TOTALBAYAR').val(convertToRupiah($totalSemua));
            ////}).focus(function () {
            ////    $(this).val('');
            //}).blur(function() {
            //    if ($(this).val() == '')
            //        $(this).val(0);
            //});

            //$('tr[data-piutang-id="0"] #PiutangDetail_BAYAR').change(function () {
            //    //$totalSemua = parseInt($('#PiutangDetail_POT').val()) + parseInt($('#PiutangDetail_BAYAR').val());
            //    $totalBayar = convertToAngka($('#TOTALBYR').val()) + parseInt($('#HutangDetail_BAYAR').val());
            //    $('tr[data-piutang-id="0"] .span-bayar-piutang').text(convertToRupiah($(this).val()));
            //    $('#TOTALBYR').val(convertToRupiah($totalBayar));
            //    $totalSemua = $totalBayar + convertToAngka($('#TOTALPOT').val());
            //    $('#TOTALBAYAR').val(convertToRupiah($totalSemua));
            ////}).focus(function () {
            ////    $(this).val('');
            //}).blur(function () {
            //    if ($(this).val() == '')
            //        $(this).val(0);
            //});
            //$('#btn-autoload').off('click').on('click', $('#konfAutoload').show());

            //add by nurul 12/2/2019
            //$('#datatable').on('page.dt', function () {
            //    $page = $('#datatable').DataTable().page.info().page;
            //});
            //$('#datatable').DataTable().page($page).draw(false);
                    //end add by nurul 12/2/2019
        }

        function autoloadFaktur() {

            var id = $('#CUSTOMER').val();
            if (id == '') {
                alert('Pelanggan Harus di Pilih !');
                var a = $("#table_tambah_piutang").children().next();
                var b = $('tr[data-piutang-id="0"]').html();
                a.html(b);
                //$('#Faktur_BRUTO').val(convertToRupiah(0));
                //$('#Faktur_PPN').val(0);
                //$('#Faktur_NILAI_PPN').val(convertToRupiah(0));
                //$('#Faktur_NILAI_DISC').val(convertToRupiah(0));
                //$('#Faktur_MATERAI').val(convertToRupiah(0));
                //$('#Faktur_NETTO').val(convertToRupiah(0));
            } else {
                //$('#drTgl').val($('#DR_TGL').val());
                //$('#sdTgl').val($('#SD_TGL').val());
                $('#bayarPiutang').val($('#BAYAR_PIUTANG').val());
                if ($('#PiutangDetail_SISA').val() == "") {
                    $('#PiutangDetail_SISA').val("0");
                }
                var link = '@Url.Action("GetAutoloadFaktur", "Manage", new { recNum = "replaceId" })';
                link = link.replace("replaceId", id);

                $('#Faktur_TGL').val($("#TGL").val());

                //if ($('#Faktur_TGL').val() != '' &&
                //    $('#Faktur_CUST').val() != '' &&
                //    $('#Faktur_TERM').val() != '')
                {
                    //$('#FakturDetail_QTY').val(0);
                    //$("#Faktur_BRUTO").val(convertToAngka($("#Faktur_BRUTO").val()));
                    //$("#Faktur_NILAI_DISC").val(convertToAngka($("#Faktur_NILAI_DISC").val()));
                    //$("#Faktur_NILAI_PPN").val(convertToAngka($("#Faktur_NILAI_PPN").val()));
                    //$("#Faktur_MATERAI").val(convertToAngka($("#Faktur_MATERAI").val()));
                    //$("#Faktur_NETTO").val($bakalNetto);
                    //$('#Faktur_NO_REF').val($("#FAKTUR option:selected").text());

                    $totalAwal = 0;
                    $('input, select').each(function () {
                        $(this).removeAttr('disabled');
                    });
                    $.ajax({
                        type: "POST",
                        url: '@Url.Action("SaveBayarPiutang", "Manage")',
                        data: $('#form-piutang').serialize(),
                        beforeSend: function() {
                            $('#loading_spinner').show();
                            $('#konfAutoload').modal('hide');
                        },
                        success: function (response) {
                            if (response.Errors == null) {
                                $modeEdit = 1; // 0 new, 1 edit
                                $('#form-partial').html(response);
                                //$totalAwal = convertToAngka($('#Faktur_BRUTO').val());
                                refreshInputan();
                                getTanggal();
                                getMarketplace();
                                //getFaktur($("#Piutang_CUST").val());
                                //$('#tambah_faktur').click();
                                //$nettoSebelumnya += $bakalNetto;

                                //$(' select ').each(function () {
                                //    $(this).attr('disabled', 'disabled');
                                //});
                                $('input, select').each(function () {
                                    $(this).attr('disabled', 'disabled');
                                });

                                //$('tr[data-piutang-id="0"]').hide();
                                //change by nurul 2/11/2018 -- $('#btn-simpan-perubahan-row').show();
                                $('#btn-simpan-perubahan-row').hide();
                                //$("#btn-autoload-row").hide();
                                $('#loading_spinner').hide();

                            } else {
                                //change by nurul 2/1/2019
                                //console.log(response.Errors);
                                //alert('Ada data yang tidak valid!');
                                if (response.Errors[0] == "") {
                                    console.log(response.Errors);
                                    alert('Ada data yang tidak valid!');
                                } else {
                                    alert(response.Errors[0]);
                                }
                                //end change
                                $('#loading_spinner').hide();
                            }
                        },
                        error: function (xhr) {
                            console.log(xhr);
                        }
                    });
                }
                //else {
                //    alert('Silakan isi semua field terlebih dahulu!');
                //}
            }
        }

        function editDetail($idFaktur) {

            var $tr = 'tr[data-piutang-id="' + $idFaktur + '"]';
            var $potInitialSpan = $($tr + ' .pot-initial');
            var $potInputBox = $($tr + ' .pot-input-box');
            var $potAwal = $potInitialSpan.text();

            var $bayarInitialSpan = $($tr + ' .bayar-initial');
            var $bayarInputBox = $($tr + ' .bayar-input-box');
            var $bayarAwal = $bayarInitialSpan.text();
            var $btnEdit = $($tr + ' .icon-btn-edit');

            var $sisaInitialSpan = $($tr + ' .sisa-initial');

            if ($btnEdit.hasClass('glyphicon-pencil')) {

                //$totalAwal = convertToAngka($('#Faktur_BRUTO').val());
                //$totalAwalBarang = parseInt(convertToAngka($($tr + ' .netto-barang').text()));
                $btnEdit.parent().removeClass('btn-primary').addClass('btn-success');
                $btnEdit.removeClass('glyphicon-pencil').addClass('glyphicon-floppy-disk');
                $potInitialSpan.hide();
                $bayarInitialSpan.hide();
                $potInputBox.val($potInitialSpan.text())
                    //.attr('max', $qtyAwal)
                    .attr('max', convertToAngka($sisaInitialSpan.text()))
                    .change(function() {
                        //unremark by calvin 8 nov 2018, proteksi qty
                        //if ($(this).val() > $qtyAwal) {
                        if (convertToAngka($(this).val()) > convertToAngka($sisaInitialSpan.text())) {
                            alert('Nilai potongan tidak boleh lebih besar dari sisa (' + $sisaInitialSpan.text() + ')!');
                            $(this).val($potAwal);
                            //refreshNettoBarang($idFaktur);
                            return false;
                        }
                        //end unremark by calvin 8 nov 2018, proteksi qty
                        //refreshNettoBarang($idFaktur);
                    })
                    .off('focus').focus(function () {
                        $(this).val(convertToAngka($(this).val()));
                    })
                    .show();

                $bayarInputBox.val($bayarInitialSpan.text())
                    //.attr('max', $qtyAwal)
                    .attr('max', convertToAngka($sisaInitialSpan.text()))
                    .change(function () {
                        //unremark by calvin 8 nov 2018, proteksi qty
                        //if ($(this).val() > $qtyAwal) {
                        if ((convertToAngka($(this).val()) + convertToAngka($potInputBox.val())) > convertToAngka($sisaInitialSpan.text())) {
                            alert('Nilai bayar ditambah potongan tidak boleh lebih besar dari sisa (' + $sisaInitialSpan.text() + ')!');
                            $(this).val(convertToRupiah(convertToAngka($sisaInitialSpan.text()) - convertToAngka($potInputBox.val())));
                            //refreshNettoBarang($idFaktur);
                            return false;
                        }
                        //end unremark by calvin 8 nov 2018, proteksi qty
                        //refreshNettoBarang($idFaktur);
                    })
                    .off('focus').focus(function () {
                        $(this).val(convertToAngka($(this).val()));
                    })
                    .show();

            } else {
                if ($bayarInputBox.val() != '' && convertToAngka($bayarInputBox.val()) > 0) {
                    if ($potInputBox.val() == '')
                        $potInputBox.val() = '0,00';
                    if (convertToAngka($potInputBox.val()) + convertToAngka($bayarInputBox.val()) > convertToAngka($sisaInitialSpan.text())) {
                        alert('Nilai Bayar ditambah Nilai Potongan tidak boleh lebih besar dari Sisa (' + $sisaInitialSpan.text() + ')!');
                        $bayarInputBox.focus();
                    } else {
                        //remark by calvin 8 nov 2018, pindah ke setelah simpanBrg, karena ada validasi lewat manageController
                        //$btnEdit.parent().removeClass('btn-success').addClass('btn-primary');
                        //$btnEdit.removeClass('glyphicon-floppy-disk').addClass('glyphicon-pencil');
                        var bayarInitialBeforeValidation = $bayarInitialSpan.val();
                        $bayarInitialSpan.text($bayarInputBox.val());//.show();
                        $potInitialSpan.text($potInputBox.val());//.show();

                        //$qtyInputBox.hide();
                        //end remark by calvin 8 nov 2018
                        //simpanBrg($idFaktur, $bayarInputBox, $potInputBox, $btnEdit);
                        simpaneditdetail($idFaktur, convertToAngka($bayarInputBox.val()), convertToAngka($potInputBox.val()), $btnEdit, $potInitialSpan, $potInputBox, $bayarInitialSpan, $bayarInputBox);
                    }

                } else {
                    alert('Field Bayar Harus diisi dan lebih dari 0 !');
                    $bayarInputBox.focus();
                }
            }
        }

        function simpaneditdetail(id, bayar, pot, $btnEdit, $potInitialSpan, $potInputBox, $bayarInitialSpan, $bayarInputBox) {
            var link = '@Url.Action("SaveEditDetail", "Manage")';
            link += '?bukti=' + encodeURIComponent($("#Piutang_BUKTI").val()) + '&no=' + encodeURIComponent(id) + '&bayar=' + encodeURIComponent(bayar) + '&pot=' + encodeURIComponent(pot);

            $.ajax({
                type: "GET",
                url: link,
                beforeSend: function () {
                    $('#loading_spinner').show();
                },
                success: function (response) {
                    if (response.Errors == null) {

                        $btnEdit.parent().removeClass('btn-success').addClass('btn-primary');
                        $btnEdit.removeClass('glyphicon-floppy-disk').addClass('glyphicon-pencil');
                        $potInitialSpan.show();
                        $potInputBox.hide();
                        $bayarInitialSpan.show();
                        $bayarInputBox.hide();

                        $('#form-partial').html(response);
                        refreshInputan();
                        getTanggal();
                        getMarketplace();
                        //getFaktur($("#Piutang_CUST").val());
                        $('#btn-simpan-perubahan-row').hide();
                        $('#loading_spinner').hide();

                    } else {
                        console.log(response.Errors);
                        alert('Ada data yang tidak valid!');
                        $('#loading_spinner').hide();
                    }
                },
                error: function (xhr, status, error) {
                    console.log(error);
                }
            });
        }

        @{
            var markets = new Dictionary<string, string>();

            foreach (var marketplace in context.Marketplaces.ToList())
            {
                markets.Add(marketplace.IdMarket.ToString(), marketplace.NamaMarket);
            }
        }

        var $marketCollection = @Html.Raw(Json.Encode(markets));

        function getMarketplace() {
            $.ajax({
                type: "GET",
                url: '@Url.Action("GetPelangganAkun", "Manage")',
                contentType: 'application/json',
                cache: false,
                success: function (data) {
                    var customerList = [];

                    $.each(data,
                        function (i, item) {
                            var $namaMarket = $marketCollection[item.NAMA];

                            customerList[i] = {
                                id: item.CUST,
                                text: $namaMarket + " (" + item.PERSO + ")",
                                market: $namaMarket,
                                idMarket: item.NAMA
                            };
                        });

                    var custSelect = $('#CUSTOMER').selectize({
                        valueField: 'id',
                        searchField: 'text',
                        options: customerList,
                        onChange: function (value) {
                            var $objSup = $.grep(customerList, function (data) { return data.id == value });
                            if (value == null) {
                                $("#Piutang_CUST").val(null);
                                getFaktur(null);
                            } else {
                                $("#Piutang_CUST").val(value);
                                getFaktur(value);
                                $tempMP1 = $objSup[0].market;
                                $tempMP = $objSup[0].idMarket;

                            }
                        }
                    });

                    custSelect[0].selectize.setValue($('#Piutang_CUST').val());
                },
                error: function (xhr) {
                    console.log(xhr);
                }
            });
        }

        function getRef($FakturId, $tr) {
            var $link = '@Url.Action("GetRefFaktur", "Manage", new { noFaktur = "replaceId" })';
            $link = $link.replace("replaceId", encodeURIComponent($FakturId));

            $.ajax({
                type: "GET",
                url: $link,
                contentType: 'application/json',
                cache: false,
                success: function (data) {
                    if (data.NO_BUKTI == $FakturId) {
                        $('#PiutangDetail_NOREF').val(data.noRef);
                        $($tr + ' .span-noref-piutang').text(data.noRef);
                        $($tr + ' .span-tglref-piutang').text(data.tglRef);

                    }
                },
                error: function (xhr) {
                    console.log(xhr);
                }
            });
        }

        function getFaktur($customerId) {
            if ($customerId == null) {
                $('#FAKTUR').selectivity({
                    allowClear: true,
                    items: [],
                    placeholder: 'Harap pilih'
                });
            } else {
                var $link = '@Url.Action("GetFakturBelumLunas", "Manage", new { noCust = "replaceId" })';
                $link = $link.replace("replaceId", encodeURIComponent($customerId));

                $.ajax({
                    type: "GET",
                    url: $link,
                    contentType: 'application/json',
                    cache: false,
                    success: function (data) {
                        var listKodeFaktur = [];

                        $.each(data,
                            function (i, item) {
                                listKodeFaktur[i] = {
                                    id: item.RecNum,
                                    text: item.NO_BUKTI
                                };
                            });

                        $('#FAKTUR').selectivity({
                            allowClear: true,
                            items: listKodeFaktur,
                            placeholder: 'Harap pilih'
                        }).change(function () {
                            var val = $(this).selectivity('value');
                            var $trId = $(this).closest('tr').attr('data-piutang-id');
                            var $trElement = 'tr[data-piutang-id="' + $trId + '"]';

                            if (val != null) {
                                $('#CUSTOMER')[0].selectize.disable();
                                $.each(data,
                                    function (i, item) {
                                        if (item.RecNum == val) {
                                            $($trElement + ' .span-sisa-piutang').text(convertToRupiah(item.Sisa));
                                            $('#PiutangDetail_SISA').val(item.Sisa);
                                            $('#PiutangDetail_NFAKTUR').val(item.NO_BUKTI);
                                            //$('#PiutangDetail_NOREF').val(item.noRef);
                                            //$($trElement + ' .span-noref-piutang').text(item.noRef);
                                            //$($trElement + ' .span-tglref-piutang').text(item.tglRef);
                                            getRef(item.NO_BUKTI, $trElement);
                                            return;
                                        }
                                    });

                                $($trElement + ' .btn-primary').removeAttr('disabled');
                                $($trElement + ' .span-potongan-piutang').hide();
                                $($trElement + ' .span-bayar-piutang').hide();
                                $($trElement + ' #PiutangDetail_POT').show();
                                $($trElement + ' #PiutangDetail_BAYAR').show();
                                $($trElement + ' #PiutangDetail_POT').removeAttr('disabled');
                                $($trElement + ' #PiutangDetail_BAYAR').removeAttr('disabled');
                            } else {
                                $('#CUSTOMER')[0].selectize.enable();

                                $($trElement + ' .btn-primary').attr('disabled', 'disabled');
                                $($trElement + ' .span-potongan-piutang').val('-').show();
                                $($trElement + ' .span-bayar-piutang').val('-').show();
                                $($trElement + ' #PiutangDetail_POT').hide();
                                $($trElement + ' #PiutangDetail_BAYAR').hide();
                                $($trElement + ' .span-noref-piutang').text('-');
                                $($trElement + ' .span-tglref-piutang').text('-');
                                $($trElement + ' .span-sisa-piutang').text('0,00');

                                @*@if (Model?.ListPiutangDetail?.Count == 0)
                                {
                                    <text>
                                        $('#Piutang_TBAYAR').val(@(Model?.Piutang?.TBAYAR));
                                    </text>
                                }*@
                            }
                        });
                    },
                    error: function (xhr) {
                        console.log(xhr);
                    }
                });
            }
        }

        function convertToRupiah(angka) {
            //change by calvin 26 september 2018
            //var rupiah = '';
            //var angkarev = angka.toString().split('').reverse().join('');
            //for (var i = 0; i < angkarev.length; i++) if (i % 3 === 0) rupiah += angkarev.substr(i, 3) + '.';
            //return rupiah.split('', rupiah.length - 1).reverse().join('') + ',00';
            return $.number(angka, 2, ',', '.');
            //end change by calvin 26 september 2018
        }

        function convertToAngka(rupiah) {

            if (rupiah == '') {
                rupiah = '0';
            }
            //change by calvin 26 september 2018
            //return parseInt(rupiah.replace(/,.*|[^0-9]/g, ''), 10);
            if (rupiah.includes(",")) {
                return parseFloat(rupiah.replaceAll('.', '').replaceAll(',', '.'));
            }
            else {
                //jika bisa desimal
                return parseFloat(rupiah.replaceAll(',', '.'));
            }
            //end change by calvin 26 september 2018
        }

        var $idPiutang = "";

        function undeleteable(){
            alert('Transaksi Sudah Posting! \nTidak dapat dihapus!');
        }
        function lihatPiutang(idPiutang) {
            var link = '@Url.Action("EditBayarPiutang", "Manage", new { orderId = "replaceId" })';
            link = link.replace("replaceId", encodeURIComponent(idPiutang));

            $.ajax({
                type: "GET",
                url: link,
                success: function (response) {
                    $modeEdit = 1; // 0 new, 1 edit
                    $('.piutang_table_section').hide();
                    $('.piutang_editor_section').show();
                    $('#form-partial').html(response);

                    refreshInputan();
                    getTanggal();
                    getMarketplace();
                    //getFaktur($("#Piutang_CUST").val());
                    getDetailBayarPiutang();
                    //$('#btn-error-row').hide();
                    //$('#tambah_piutang').click();
                    //$('#TGL').change();
                    $('input, select, .btn-danger').each(function () {
                        $(this).attr('disabled', 'disabled');
                    });
                    $('tr[data-piutang-id="0"]').remove();
                },
                error: function (xhr, status, error) {
                    console.log(error);
                }
            });
        }
        function editPiutang1(idPiutang) {
            var link = '@Url.Action("EditBayarPiutang", "Manage", new { orderId = "replaceId" })';
            link = link.replace("replaceId", encodeURIComponent(idPiutang));

            $.ajax({
                type: "GET",
                url: link,
                success: function (response) {
                    $modeEdit = 1; // 0 new, 1 edit
                    $('.piutang_table_section').hide();
                    $('.piutang_editor_section').show();
                    $('#form-partial').html(response);

                    refreshInputan();
                    getTanggal();
                    getMarketplace();
                    getFaktur($("#Piutang_CUST").val());
                    getDetailBayarPiutang();

                    //$('#btn-error-row').hide();
                    $('#btn-autoload').click(function () {
                        $('#file_upload_excel').removeAttr('disabled');
                    });

                    //$('#tambah_piutang').click();
                    //$('#TGL').change();
                },
                error: function (xhr, status, error) {
                    console.log(error);
                }
            });
        }

        function pass(idPiutang) {
            this.$idPiutang = idPiutang;
        }

        function deletePiutang() {
            var $savePage = $('#txt_last_page').val();
            var link = '@Url.Action("DeleteBayarPiutang", "Manage", new { orderId = "replaceId" })';
            link = link.replace("replaceId", encodeURIComponent(this.$idPiutang));

            $.ajax({
                type: "GET",
                url: link,
                success: function (response) {
                    $('#table-piutang-partial').html(response);
                    //var table = $('#datatable').DataTable({
                    //    "order": [[0, 1, "desc"]], //or asc
                    //    "columnDefs": [{ "targets": 1, "type": "date-eu" }],
                    //});
                    //Initialize();
                    refreshTablePiutang1($savePage);
                    $('#konfHapusPiutang').modal('hide');
                },
                error: function (xhr, status, error) {
                    console.log(error);
                }
            });
        }

        var $fak = '';

        function passFakturInDb($fak) {
            this.$fak = $fak;
        }

        function deleteDetail() {
            var link = '@Url.Action("DeleteDetailBayarPiutang", "Manage", new { noUrut = "replaceFakId" })';
            link = link.replace("replaceFakId", encodeURIComponent(this.$fak));

            $.ajax({
                type: "GET",
                url: link,
                contentType: 'application/json',
                cache: false,
                success: function (response) {
                    $modeEdit = 1; // 0 new, 1 edit
                    $('#form-partial').html(response);
                    refreshInputan();
                    getTanggal();
                    getMarketplace();
                    $('#btn-autoload').click(function () {
                        $('#file_upload_excel').removeAttr('disabled');
                    });
                    getFaktur($("#Piutang_CUST").val());
                    $('#konfHapusFaktur').modal('hide');
                },
                error: function (xhr) {
                    console.log(xhr);
                }
            });
        }

        @*function refreshTablePiutang1() {
            var link = '@Url.Action("RefreshTableBayarPiutang1", "Manage")';

            $.ajax({
                type: "GET",
                url: link,
                success: function (response) {
                    $('#table-piutang-partial').html(response);
                    //var table = $('#datatable').DataTable({
                    //    "order": [[0,1, "desc"]], //or asc
                    //    "columnDefs": [{ "targets": 1, "type": "date-eu" }],
                    //});
                    $('#search_piutang').keyup(function () {
                        table.search($(this).val()).draw();
                    });
                    //add by calvin 23 nov 2018, setelah di close, search lg
                    table.search($('#search_piutang').val()).draw();
                    //end add by calvin 23 nov 2018, setelah di close, search lg
                    //add by nurul 12/2/2019
                    //$('#datatable').on('page.dt', function () {
                    //    $page = $('#datatable').DataTable().page.info().page;
                    //});
                    //$('#datatable').DataTable().page($page).draw(false);
                    //end add by nurul 12/2/2019
                },
                error: function (xhr, status, error) {
                    console.log(error);
                }
            });
        }*@

        function refreshTablePiutang1($savePage) {
            var $tpPage = "";
            if ($savePage == undefined) {
                $tpPage = $('#txt_last_page').val();
            } else {
                if ($('#txt_last_page').val() == undefined) {
                    $tpPage = $savePage;
                } else {
                    $tpPage = $('#txt_last_page').val();
                }
            }
            var $link = '@Html.Raw(Url.Action("RefreshTableBayarPiutang1", "Manage", new { page = "replaceLastPage", search = "replaceSearch" }))';
            $link = $link.replace("replaceSearch", encodeURIComponent($('#search_piutang').val()));
            //$link = $link.replace("replaceLastPage", $('#txt_last_page').val());
            $link = $link.replace("replaceLastPage", encodeURIComponent($tpPage));

            $.ajax({
                type: "GET",
                url: $link,
                beforeSend: function () {
                    $('#table-piutang-partial').hide();
                    $('#loading_bayarpiutang_tab').show();
                },
                success: function (response) {
                    $('#table-piutang-partial').html(response);
                    $('#loading_bayarpiutang_tab').hide();
                    $('#table-piutang-partial').show();
                    $("#modalError").on('show.bs.modal', function (e) {
                        var $modal = $(this);
                        $modal.find('.edit-content').html('');
                    });
                },
                error: function (xhr, status, error) {
                    console.log(error);
                }
            });
        }
        function searchTablePiutang1(){
            var $link = '@Html.Raw(Url.Action("RefreshTableBayarPiutang1", "Manage", new { search = "replaceSearch" }))';
            $link = $link.replace("replaceSearch", encodeURIComponent($('#search_piutang').val()));

            $.ajax({
                type: "GET",
                url: $link,
                beforeSend: function () {
                    $('#search_piutang_click')[0].disabled = true;
                    $('#loading_bayarpiutang_tab').show();
                },
                success: function (response) {
                    $('#search_piutang_click')[0].disabled = false;
                    $('#table-piutang-partial').html(response);
                    $('#loading_bayarpiutang_tab').hide();
                },
                error: function (xhr, status, error) {
                    $('#search_piutang_click')[0].disabled = false;
                    console.log(error);
                }
            });
        }

        function refreshForm1() {
            var link = '@Url.Action("RefreshBayarPiutangForm", "Manage")';

            $.ajax({
                type: "GET",
                url: link,
                success: function (response) {
                    $modeEdit = 0; // 0 new, 1 edit
                    $('.piutang_table_section').hide();
                    $('.piutang_editor_section').show();
                    $('#form-partial').html(response);
                    $("#modalError").on('show.bs.modal', function (e) {
                        var $modal = $(this);
                        $modal.find('.edit-content').html('');
                    });
                    //$("#btn-error-row").hide();
                    //refreshInputan();
                    getTanggal();
                    getMarketplace();
                    //getFaktur($("#Piutang_CUST").val());

                    //$('#TGL').change();
                },
                error: function (xhr, status, error) {
                    console.log(error);
                }
            });
        }

        function simpandetail($id) {
            if (!validateForm()) return false;

            //if ($id == 'piu-0') {
            if ($id != '') {
                if ($('#Piutang_TGL').val() != '') {
                    $('#Piutang_TGLINPUT').val(moment(new Date()).format("DD/MM/YYYY"));
                    $('#PiutangDetail_SISA').val(convertToAngka($('tr[data-piutang-id="0"] .span-sisa-piutang').text()));
                    //$('#PiutangDetail_POT').val(convertToAngka($('tr[data-piutang-id="0"] .span-potongan-piutang').text()));
                    //$('#PiutangDetail_BAYAR').val(convertToAngka($('tr[data-piutang-id="0"] .span-bayar-piutang').text()));
                    if ($('#PiutangDetail_POT').val() == "") {
                        $('#PiutangDetail_POT').val("0") ;
                        //$('#PiutangDetail_POT').val(convertToAngka($('#PiutangDetail_POT').val()));
                        $('#PiutangDetail_POT').val(convertToAngka(convertToRupiah($('#PiutangDetail_POT').val())));
                    } else {
                        //$('#PiutangDetail_POT').val(convertToAngka($('#PiutangDetail_POT').val()));
                        $('#PiutangDetail_POT').val(convertToAngka(convertToRupiah($('#PiutangDetail_POT').val())));
                    }
                    if ($('#PiutangDetail_BAYAR').val() == "") {
                        $('#PiutangDetail_BAYAR').val("0") ;
                        //$('#PiutangDetail_BAYAR').val(convertToAngka($('#PiutangDetail_BAYAR').val()));
                        $('#PiutangDetail_BAYAR').val(convertToAngka(convertToRupiah($('#PiutangDetail_BAYAR').val())));
                    } else {
                        //$('#PiutangDetail_BAYAR').val(convertToAngka($('#PiutangDetail_BAYAR').val()));
                        $('#PiutangDetail_BAYAR').val(convertToAngka(convertToRupiah($('#PiutangDetail_BAYAR').val())));
                    }

                    //var sum = parseInt($('#PiutangDetail_POT').val()) + parseInt($('#PiutangDetail_BAYAR').val());
                    var sum = convertToAngka(convertToRupiah($('#PiutangDetail_POT').val())) + convertToAngka(convertToRupiah($('#PiutangDetail_BAYAR').val()));

                    //if (parseInt($('#PiutangDetail_SISA').val()) < sum) {
                    if (parseFloat($('#PiutangDetail_SISA').val()) < sum) {
                        alert('Nilai Potongan + Nilai Bayar tidak boleh melebihi Nilai Sisa!');
                        return;
                    }

                    //$('#Piutang_TPOT').val(parseInt($('#Piutang_TPOT').val()) + parseInt($('#PiutangDetail_POT').val()));
                    //$('#Piutang_TBAYAR').val(parseInt($('#Piutang_TBAYAR').val()) + parseInt($('#PiutangDetail_BAYAR').val()));
                    //$('#TotalBAYAR').val(parseInt($('#Piutang_TPOT').val()) + parseInt($('#Piutang_TBAYAR').val()));
                    $('#Piutang_TPOT').val(parseFloat($('#Piutang_TPOT').val()) + parseFloat($('#PiutangDetail_POT').val()));
                    $('#Piutang_TBAYAR').val(parseFloat($('#Piutang_TBAYAR').val()) + parseFloat($('#PiutangDetail_BAYAR').val()));
                    $('#TotalBAYAR').val(parseFloat($('#Piutang_TPOT').val()) + parseFloat($('#Piutang_TBAYAR').val()));

                    $('input, select').each(function () {
                        $(this).removeAttr('disabled');
                    });
                    $.ajax({
                        type: "POST",
                        url: '@Url.Action("SaveBayarPiutang", "Manage")',
                        data: $('#form-piutang').serialize(),
                        success: function (response) {
                            if (response.Errors == null) {
                                $modeEdit = 1; // 0 new, 1 edit
                                $('#form-partial').html(response);
                                $('input, select').each(function () {
                                    $(this).attr('disabled', 'disabled');
                                });
                                $('#btn-autoload').click(function () {
                                    $('#file_upload_excel').removeAttr('disabled');
                                });
                                refreshInputan();
                                getTanggal();
                                getMarketplace();
                                //getFaktur($("#Piutang_CUST").val());
                                $('#btn-simpan-perubahan-row').hide();
                            } else {
                                //console.log(response.Errors);
                                //alert('Ada data yang tidak valid!');
                                alert(response.Errors);
                            }
                        },
                        error: function (xhr) {
                            console.log(xhr);
                        }
                    });
                } else {
                    alert('Silakan isi semua field terlebih dahulu!');
                }
            }
        }

        //add by nurul 21/10/2019
        function validasiUpload() {

            if ($('#Piutang_TGL').val() == null ||
                $('#Piutang_CUST').val() == '') {
                alert('Silahkan pilih nama marketplace terlebih dulu !');
            } else if ($tempMP1.toUpperCase() != "SHOPEE" && $tempMP1.toUpperCase() != "TOKOPEDIA" && $tempMP1.toUpperCase() != "LAZADA" && $tempMP1.toUpperCase() != "BUKALAPAK" && $tempMP1.toUpperCase() != "BLIBLI") {
                alert('Maaf, upload ini baru bisa menghandle Shopee, Tokopedia, Lazada, Bukalapak dan Blibli.');
            }
            else {


                $("#konfUpload").on('show.bs.modal', function (e) {

                    if ($tempMP1.toUpperCase() == "SHOPEE") {
                        $('#note_shopee').show();
                        $('#note_tokopedia').hide();
                        $('#note_lazada').hide();
                        $('#note_bukalapak').hide();
                        $('#note_blibli').hide();
                    } else if ($tempMP1.toUpperCase() == "TOKOPEDIA") {
                        $('#note_shopee').hide();
                        $('#note_tokopedia').show();
                        $('#note_lazada').hide();
                        $('#note_bukalapak').hide();
                        $('#note_blibli').hide();
                    } else if ($tempMP1.toUpperCase() == "LAZADA") {
                        $('#note_shopee').hide();
                        $('#note_tokopedia').hide();
                        $('#note_lazada').show();
                        $('#note_bukalapak').hide();
                        $('#note_blibli').hide();
                    } else if ($tempMP1.toUpperCase() == "BUKALAPAK") {
                        $('#note_shopee').hide();
                        $('#note_tokopedia').hide();
                        $('#note_lazada').hide();
                        $('#note_bukalapak').show();
                        $('#note_blibli').hide();
                    } else if ($tempMP1.toUpperCase() == "BLIBLI") {
                        $('#note_shopee').hide();
                        $('#note_tokopedia').hide();
                        $('#note_lazada').hide();
                        $('#note_bukalapak').hide();
                        $('#note_blibli').show();
                    }
                });
                $("#konfUpload").modal('show');
                document.getElementById("file_upload_excel").value = "";
            }
        }

        function validasiCreatePot() {
            if ($('tr[data-piutang-id != "0"] .potongan-piutang').length <= 0) {
                alert('Tidak ada detail pembayaran');
            } else if (convertToAngka($('#TOTALSELISIH').val()) == 0) {
                alert('Tidak ada selisih !');
            }else if ($('#Piutang_TGL').val() != null &&
                $('#Piutang_CUST').val() != '') {
                $("#konfCreatePot").modal('show');
            }
            else {
                alert('Silahkan pilih nama marketplace terlebih dulu !');

            }
        }

        function checkfile(s) {
            var validExts = new Array(".xlsx", ".xls", ".csv");
            //var validExts = new Array(".xlsx", ".xls");
            sizeFile = parseInt(document.getElementById("file_upload_excel").files[0].size / 1024)
            var fileExt = s.value;
            if (fileExt != null && fileExt != "") {
                fileExt = fileExt.substring(fileExt.lastIndexOf('.'));
                if (validExts.indexOf(fileExt) < 0) {
                    alert("Invalid file selected, valid files are of " +
                        validExts.toString() + " types.");
                    document.getElementById("file_upload_excel").value = "";
                    return false;
                }
                if (sizeFile > 4000) {
                    alert("Invalid file size, valid size is lower than 4Mb/4000Kb. File size " + sizeFile + " Kb.");
                    return false;
                    $('#btn_upload').attr('disabled', 'disabled');
                } else {
                    $('#btn_upload').removeAttr('disabled');
                }
            }
        }
        //add by nurul 2/4/2020
        function uploadExcelPP() {
            if ($('#file_upload_excel')[0].files.length < 1) {
                $('#file_upload_excel').click();
                //$('#progressBarUpload').modal('hide');
                $('#progressBarUpload').hide();
                $('#progressBarDownload').hide();
            } else if (sizeFile > 4000) {
                //$('#progressBarUpload').modal('hide');
                $('#progressBarUpload').hide();
                $('#progressBarDownload').hide();
                alert("Invalid file size, valid size is lower than 4Mb/4000Kb. File size " + sizeFile + " Kb.");
            }
            else {
                if ($tempMP1.toUpperCase() == "SHOPEE" || $tempMP1.toUpperCase() == "LAZADA") {
                    $('#pBar_uploadFile').css('width', '0%').attr('aria-valuenow', 0);
                    $('#pBar_uploadFile').html('0% Complete');
                    //$('#progressBarUpload').modal('show');
                    $('#pBar_DownloadFile').css('width', '20%').attr('aria-valuenow', 20);
                    $('#pBar_DownloadFile').html('20% Complete');
                    $('#progressBarDownload').show();
                    $('#progressBarUpload').show();
                    uploadFileExcelPiutang(null, 0, "0;0", "false;false", null, false);
                } else {
                    $('#progressBarDownload').hide();
                    $('#progressBarUpload').hide();
                    alert("Fitur ini sedang kami upgrade. Mohon hubungi tim support.");
                }
            }
        }

        function uploadFileExcelPiutang(vnobuk, vcountAll, vpercentvprogress, vstatusLoopvSuccess, vBuktiLog, vNoProcess) {

            var splitpro = vpercentvprogress.split(';');
            var vpercent = splitpro[0];
            var vprogress = splitpro[1];

            var splitStatus = vstatusLoopvSuccess.split(';');
            var vstatusLoop = splitStatus[0];
            var vstatusSuccess = splitStatus[1];
            

            if ($('#file_upload_excel')[0].files.length <= 0) {
                //$('#progressBarUpload').modal('hide');
                $('#progressBarDownload').hide();
                $('#pBar_DownloadFile').css('width', '0%').attr('aria-valuenow', 0);
                $('#pBar_DownloadFile').html('0% Complete');
                $('#progressBarUpload').hide();
                $('#pBar_uploadFile').css('width', '0%').attr('aria-valuenow', 0);
                $('#pBar_uploadFile').html('0% Complete');
                //$('#loading_upload').hide();
            } else if (sizeFile > 4000) {
                //$('#progressBarUpload').modal('hide');
                $('#progressBarDownload').hide()
                $('#pBar_DownloadFile').css('width', '0%').attr('aria-valuenow', 0);
                $('#pBar_DownloadFile').html('0% Complete');
                $('#progressBarUpload').hide();
                $('#pBar_uploadFile').css('width', '0%').attr('aria-valuenow', 0);
                $('#pBar_uploadFile').html('0% Complete');
                //$('#loading_upload').hide();
                alert("Invalid file size, valid size is lower than 4Mb/4000Kb. File size " + sizeFile + " Kb.");
            }
            else
            {
                $('#btnUploadExcelPiutang').attr('disabled', 'disabled');

                var formdata = new FormData(); //FormData object
                var fileInput = document.getElementById('file_upload_excel');
                //Iterating through each files selected in fileInput
                for (i = 0; i < fileInput.files.length; i++) {
                    //Appending each file to FormData object
                    if (i == 0) {
                        formdata.append(fileInput.files[i].name, fileInput.files[i]);
                        $('#lblPBUpload').text('Processing File : ' + fileInput.files[i].name);
                        $('#lblPBDownload').text('Uploading File : ' + fileInput.files[i].name);
                    }
                }

                formdata.append("cust", $('#Piutang_CUST').val());
                formdata.append("market", $tempMP1);
                formdata.append("tgl", $('#Piutang_TGL').val());
                $('input, select').each(function () {
                    $(this).removeAttr('disabled');
                });

                var $urlProgress = "";
                if ($tempMP1.toUpperCase() == "SHOPEE") {
                    $urlProgress = '@Html.Raw(Url.Action("UploadXcelBayar1", "Manage", new { nobuk = "rep1", countAll = "rep2", percentDanprogress = "rep3percent;rep4progress", statusLoopSuccess = "rep5loop;rep6success", log = "repLog", NoProcess = "repNoProcess" }))';
                }
                else if ($tempMP1.toUpperCase() == "TOKOPEDIA") {
                    $urlProgress = '@Html.Raw(Url.Action("UploadXcelBayarTokped", "Manage", new { nobuk = "rep1", countAll = "rep2", percentDanprogress = "rep3percent;rep4progress", statusLoopSuccess = "rep5loop;rep6success", log = "repLog", NoProcess = "repNoProcess" }))';
                }
                else if ($tempMP1.toUpperCase() == "LAZADA") {
                    $urlProgress = '@Html.Raw(Url.Action("UploadXcelBayarLazada", "Manage", new { nobuk = "rep1", countAll = "rep2", percentDanprogress = "rep3percent;rep4progress", statusLoopSuccess = "rep5loop;rep6success", log = "repLog", NoProcess = "repNoProcess" }))';
                }
                else if ($tempMP1.toUpperCase() == "BUKALAPAK") {
                    $urlProgress = '@Html.Raw(Url.Action("UploadXcelBayarBukalapak", "Manage", new { nobuk = "rep1", countAll = "rep2", percentDanprogress = "rep3percent;rep4progress", statusLoopSuccess = "rep5loop;rep6success", log = "repLog", NoProcess = "repNoProcess" }))';
                }
                else if ($tempMP1.toUpperCase() == "BLIBLI") {
                    $urlProgress = '@Html.Raw(Url.Action("UploadXcelBayarBlibli", "Manage", new { nobuk = "rep1", countAll = "rep2", percentDanprogress = "rep3percent;rep4progress", statusLoopSuccess = "rep5loop;rep6success", log = "repLog", NoProcess = "repNoProcess" }))';
                }

                $urlProgress = $urlProgress.replace("rep1", vnobuk);
                $urlProgress = $urlProgress.replace("rep2", vcountAll);
                $urlProgress = $urlProgress.replace("rep3percent", vpercent);
                $urlProgress = $urlProgress.replace("rep4progress", vprogress);
                $urlProgress = $urlProgress.replace("rep5loop", String(vstatusLoop));
                $urlProgress = $urlProgress.replace("rep6success", String(vstatusSuccess));

                $urlProgress = $urlProgress.replace("repLog", vBuktiLog);
                $urlProgress = $urlProgress.replace("repNoProcess", vNoProcess);

                $.ajax({
                    type: "POST",
                    url: $urlProgress,
                    data: formdata,
                    processData: false,  // tell jQuery not to process the data
                    contentType: false,  // tell jQuery not to set contentType
                    beforeSend: function () {
                    },
                    success: function (response) {
                        if (response.Errors == undefined) {
                            //$('#loading_upload').hide();
                            //$("#konfUpload").modal('hide');
                            
                            $modeEdit = 1; // 0 new, 1 edit
                            $('.piutang_table_section').hide();
                            $('.piutang_editor_section').show();
                            $('#form-partial').html(response);
                            tempNobuk = ret.nobuk;
                            tempLog = ret.buktiLog;

                            $('#pBar_DownloadFile').css('width', '100%').attr('aria-valuenow', 100);
                            $('#pBar_DownloadFile').html('100% Complete');

                            if (ret.countAll != null && ret.statusLoop == true && ret.statusSuccess == false && ret.TidakLanjutProses == false) {
                                $('#pBar_uploadFile').css('width', response.percent + '%').attr('aria-valuenow', response.percent);
                                $('#pBar_uploadFile').html(response.percent + '% Complete');

                                if (ret.progress <= ret.countAll) {
                                    uploadFileExcelPiutang(ret.nobuk, ret.countAll, String(ret.percent) + ";" + String(ret.progress + 1), String(ret.statusLoop) + ";" + String(ret.statusSuccess), String(ret.buktiLog), ret.TidakLanjutProses);
                                }

                            } else if (ret.statusSuccess == true) {
                                $('#pBar_uploadFile').css('width', '100%').attr('aria-valuenow', 100);
                                $('#pBar_uploadFile').html('100% Complete');
                                $('#btnUploadExcelPiutang').removeAttr('disabled');
                                //setTimeout(popupAlertUploadSaldoAwal, 500);
                                $("#konfUpload").modal('hide');

                                refreshInputan();
                                getTanggal();
                                getMarketplace();
                                getFaktur($("#Piutang_CUST").val());
                                $('input, select').each(function () {
                                    $(this).attr('disabled', 'disabled');
                                });
                                $('#btn-simpan-perubahan-row').hide();
                                $('#btn-autoload').click(function () {
                                    $('#file_upload_excel').removeAttr('disabled');
                                });
                                //$("#btn-error-row").show();
                                $tempErr.length = 0;
                                $tempErr = listError;
                                popupAlertUploadSaldoAwal;
                                if (ret.adaError == true) {
                                    //if (ret.nobuk != null) {
                                    //    $("#btn-error").click();
                                    //    showError(ret.nobuk, ret.buktiLog);
                                    //} else {
                                    //    alert(ret.Errors);
                                    //}
                                        $("#modalError").modal('show');
                                        showError(tempNobuk, tempLog);
                                } 
                            } else {
                                $('#pBar_uploadFile').css('width', '100%').attr('aria-valuenow', 100);
                                $('#pBar_uploadFile').html('0% Complete');
                                $('#btnUploadExcelPiutang').removeAttr('disabled');
                                //setTimeout(alert("Proses upload pembayaran piutang gagal. Klik Lihat Error!"), 500);
                                $("#konfUpload").modal('hide');

                                refreshInputan();
                                getTanggal();
                                getMarketplace();
                                getFaktur($("#Piutang_CUST").val());
                                $('input, select').each(function () {
                                    $(this).attr('disabled', 'disabled');
                                });
                                $('#btn-simpan-perubahan-row').hide();
                                $('#btn-autoload').click(function () {
                                    $('#file_upload_excel').removeAttr('disabled');
                                });
                                //$("#btn-error-row").show();
                                $tempErr.length = 0;
                                $tempErr = listError;
                                alert("Proses upload pembayaran piutang gagal.");
                                if (ret.adaError == true) {
                                    //if (ret.nobuk != null) {
                                    //    $("#btn-error").click();
                                    //    showError(ret.nobuk, ret.buktiLog);
                                        
                                    //} else {
                                    //    alert(ret.Errors);
                                    //}
                                        $("#modalError").modal('show');
                                        showError(tempNobuk, tempLog);
                                } 
                            }
                                                        
                            
                        } else {
                            tempNobuk = response.nobuk;
                            tempLog = response.buktiLog;
                            $('#pBar_DownloadFile').css('width', '100%').attr('aria-valuenow', 100);
                            $('#pBar_DownloadFile').html('100% Complete');

                            if (response.countAll != null && response.statusLoop == true && response.statusSuccess == false && response.TidakLanjutProses == false) {
                                $('#pBar_uploadFile').css('width', response.percent + '%').attr('aria-valuenow', response.percent);
                                $('#pBar_uploadFile').html(response.percent + '% Complete');

                                if (response.progress <= response.countAll) {
                                    uploadFileExcelPiutang(response.nobuk, response.countAll, String(response.percent) + ";" + String(response.progress + 1), String(response.statusLoop) + ";" + String(response.statusSuccess), String(response.buktiLog), response.TidakLanjutProses);
                                }

                            } else if (response.statusSuccess == true) {
                                $('#pBar_uploadFile').css('width', '100%').attr('aria-valuenow', 100);
                                $('#pBar_uploadFile').html('100% Complete');
                                $('#btnUploadExcelPiutang').removeAttr('disabled');
                                //setTimeout(popupAlertUploadSaldoAwal, 500);

                                    //$('#loading_upload').hide();
                                    //alert(response.Errors);
                                    getFaktur($("#Piutang_CUST").val());
                                    $('input, select').each(function () {
                                        $(this).removeAttr('disabled');
                                    });
                                    $('#btn-autoload').click(function () {
                                        $('#file_upload_excel').removeAttr('disabled');
                                    });
                                    //$("#konfUpload").modal('hide');
                                    //$("#btn-error-row").show();
                                    $tempErr.length = 0;
                                    $tempErr = response.Errors;
                                    //$("#modalError").on('show.bs.modal', function (e) {
                                    //    //$('#modalError').find('.edit-content').html($tempErr);
                                    //    //$('#modalError').modal('show');
                                    //    $(this).find('.edit-content').html($tempErr);
                                    //    $('#modalError').modal('show');
                                    //    //$(this).modal('show');
                                    //    //$('#loading_error').hide();
                                    //});
                                //    if ($tempErr.length >= 1) {
                                //        //alert('Ada error. Silahkan klik "View Error"');
                                //        $('#btn-error').click()
                                //        showError(response.nobuk, response.buktiLog);
                                //    //} else if ($tempErr.length == 1) {
                                //    //    $("#btn-error").click();
                                //    } else if ($tempErr.length == 0) {
                                //        //$("#btn-error-row").hide();
                                //}
                                //setTimeout(popupAlertUploadSaldoAwal, 500);
                                popupAlertUploadSaldoAwal;
                                if (response.adaError == true) {
                                    //
                                    
                                    //if (response.nobuk != null) { 
                                    //    //showError(response.nobuk, response.buktiLog);
                                    //        $("#modalError").modal('show');
                                    //        showError(tempNobuk, tempLog);
                                    //} else {
                                    //    alert(response.Errors);
                                    //}
                                    $("#modalError").modal('show');
                                    showError(tempNobuk, tempLog);
                                } 

                                
                                $("#konfUpload").modal('hide');
                            } else {
                                $('#pBar_uploadFile').css('width', '100%').attr('aria-valuenow', 100);
                                $('#pBar_uploadFile').html('0% Complete');
                                $('#btnUploadExcelPiutang').removeAttr('disabled');
                                //setTimeout(alert("Proses upload pembayaran piutang gagal. Klik Lihat Error!"), 500);


                                    //$('#loading_upload').hide();
                                    //alert(response.Errors);
                                    getFaktur($("#Piutang_CUST").val());
                                    $('input, select').each(function () {
                                        $(this).removeAttr('disabled');
                                    });
                                    $('#btn-autoload').click(function () {
                                        $('#file_upload_excel').removeAttr('disabled');
                                    });
                                    //$("#konfUpload").modal('hide');
                                    //$("#btn-error-row").show();
                                    $tempErr.length = 0;
                                    $tempErr = response.Errors;
                                    //$("#modalError").on('show.bs.modal', function (e) {
                                    //    //$('#modalError').find('.edit-content').html($tempErr);
                                    //    //$('#modalError').modal('show');
                                    //    $(this).find('.edit-content').html($tempErr);
                                    //    $('#modalError').modal('show');
                                    //    //$(this).modal('show');
                                    //    //$('#loading_error').hide();
                                    //});
                                //    if ($tempErr.length >= 1) {
                                //    //    alert('Ada error. Silahkan klik "View Error"');
                                //    //} else if ($tempErr.length == 1) {
                                //    //    $("#btn-error").click();
                                //        $('#btn-error').click()
                                //        showError(response.nobuk, response.buktiLog);
                                //    } else if ($tempErr.length == 0) {
                                //        //$("#btn-error-row").hide();
                                //}
                                //setTimeout(alert("Proses upload pembayaran piutang gagal."), 500);
                                alert("Proses upload pembayaran piutang gagal.");
                                if (response.adaError == true) {
                                    //$('#btn-error').click()
                                    //if (response.nobuk != null) {
                                    //    //$('#btn-error').click()
                                    //    //showError(response.nobuk, response.buktiLog);
                                    //    $("#modalError").on('show.bs.modal', function (e) {
                                    //        $("#modalError").modal('show');
                                    //        showError(tempNobuk, tempLog);
                                    //    });
                                    //} else {
                                    //    alert(response.Errors);
                                    //}
                                    $("#modalError").modal('show');
                                    showError(tempNobuk, tempLog);
                                } 
                                
                                $("#konfUpload").modal('hide');
                            }
                        }
                    },
                    error: function (xhr, status, error) {
                        var err = "";
                        //if (error != undefined) {
                        //    for (i = 0; i < error.length; i++) {
                        //        err += error[i] + "\n";
                        //    }
                        //} else {
                        //    for (i = 0; i < error.length; i++) {
                        //        err += error[i] + "\n";
                        //    }
                        //}
                        alert(error);
                        console.log(error);
                        //$('#progressBarUpload').modal('hide');
                        $('#progressBarDownload').hide();
                        $('#progressBarUpload').hide();
                        $('#btnUploadExcelPiutang').removeAttr('disabled');
                    }
                });

            }
        }

        function popupAlertUploadSaldoAwal() {
            alert("Proses upload pembayaran piutang sudah selesai!");
        }
        //end add by nurul 2/4/2020
        function uploadfile() {
            if ($('#file_upload_excel')[0].files.length < 1) {
                $('#file_upload_excel').click();
            } else {
                var formdata = new FormData(); //FormData object
                var fileInput = document.getElementById('file_upload_excel');
                //Iterating through each files selected in fileInput
                for (i = 0; i < fileInput.files.length; i++) {
                    //Appending each file to FormData object
                    formdata.append(fileInput.files[i].name, fileInput.files[i]);
                }
                formdata.append("cust", $('#Piutang_CUST').val());
                formdata.append("market", $tempMP1);
                formdata.append("tgl", $('#Piutang_TGL').val());
                $('input, select').each(function () {
                    $(this).removeAttr('disabled');
                });

                var url = "";
                if ($tempMP1.toUpperCase() == "SHOPEE") {
                    @*url = '@Url.Action("UploadXcelBayar1", "Manage")';*@
                    url = '@Url.Action("UploadFileBackground", "Manage")';
                }
                else if ($tempMP1.toUpperCase() == "TOKOPEDIA") {
                    url = '@Url.Action("UploadXcelBayarTokped", "Manage")';
                }
                else if ($tempMP1.toUpperCase() == "LAZADA") {
                    url = '@Url.Action("UploadXcelBayarLazada", "Manage")';
                }
                else if ($tempMP1.toUpperCase() == "BUKALAPAK") {
                    url = '@Url.Action("UploadXcelBayarBukalapak", "Manage")';
                }
                else if ($tempMP1.toUpperCase() == "BLIBLI") {
                    url = '@Url.Action("UploadXcelBayarBlibli", "Manage")';
                }

                $.ajax({
                    type: "POST",
                    @*url: '@Url.Action("UploadXcelBayar1", "Manage")',*@
                    url: url,
                    data: formdata,
                    processData: false,  // tell jQuery not to process the data
                    contentType: false,  // tell jQuery not to set contentType
                    beforeSend: function () {
                        //$('#loading_upload').show();
                    },
                    success: function (response) {

                        if (response.Errors == undefined) {
                            $('#loading_upload').hide();
                            $("#konfUpload").modal('hide');

                            $modeEdit = 1; // 0 new, 1 edit
                            $('.piutang_table_section').hide();
                            $('.piutang_editor_section').show();
                            $('#form-partial').html(response);
                            refreshInputan();
                            getTanggal();
                            getMarketplace();
                            getFaktur($("#Piutang_CUST").val());
                            $('input, select').each(function () {
                                $(this).attr('disabled', 'disabled');
                            });
                            $('#btn-simpan-perubahan-row').hide();
                            $('#btn-autoload').click(function () {
                                $('#file_upload_excel').removeAttr('disabled');
                            });
                            //$("#btn-error-row").show();
                            $tempErr.length = 0;
                            $tempErr = listError;
                            $("#modalError").on('show.bs.modal', function (e) {
                                //$('#modalError').find('.edit-content').html($tempErr);
                                //$('#modalError').modal('show');
                                $(this).find('.edit-content').html($tempErr);
                                $('#modalError').modal('show');
                                //$(this).modal('show');
                                //$('#loading_error').hide();
                                @*$.ajax({
                                    type: "POST",
                                    url: '@Url.Action("ShowErrorUploadBayar", "Manage")',
                                    data: JSON.stringify($tempErr),
                                    contentType: 'application/json; charset=UTF-8',
                                    cache: false,
                                    beforeSend: function () {
                                        $('#loading_error').show();
                                    },
                                    success: function (value) {
                                        $('#modalError').find('.edit-content').html(value);
                                        $('#Modal').modal('show');
                                        $('#loading_error').hide();
                                    },
                                    error: function (xhr, status, error) {
                                        console.log(error);
                                        $tempErr.length = 0;
                                    }
                                });*@
                            });
                            if ($tempErr.length > 1) {
                                alert('Ada error. Silahkan klik "View Error"');
                            } else if($tempErr.length == 1) {
                                $("#btn-error").click();
                            } else if ($tempErr.length == 0) {
                                //$("#btn-error-row").hide();
                            }

                        } else {
                            $('#loading_upload').hide();
                            //alert(response.Errors);
                            getFaktur($("#Piutang_CUST").val());
                            $('input, select').each(function () {
                                $(this).removeAttr('disabled');
                            });
                            $('#btn-autoload').click(function () {
                                $('#file_upload_excel').removeAttr('disabled');
                            });
                            $("#konfUpload").modal('hide');
                            //$("#btn-error-row").show();
                            $tempErr.length = 0;
                            $tempErr = response.Errors;
                            $("#modalError").on('show.bs.modal', function (e) {
                                //$('#modalError').find('.edit-content').html($tempErr);
                                //$('#Modal').modal('show');
                                $(this).find('.edit-content').html($tempErr);
                                $('#modalError').modal('show');
                                ///*$(this).modal('show');*/
                                //$('#loading_error').hide();
                                @*$.ajax({
                                    type: "POST",
                                    url: '@Url.Action("ShowErrorUploadBayar", "Manage")',
                                    data: JSON.stringify($tempErr),
                                    contentType: 'application/json; charset=UTF-8',
                                    cache: false,
                                    beforeSend: function () {
                                        $('#loading_error').show();
                                    },
                                    success: function (value) {
                                        $('#modalError').find('.edit-content').html(value);
                                        $('#Modal').modal('show');
                                        $('#loading_error').hide();
                                    },
                                    error: function (xhr, status, error) {
                                        console.log(error);
                                        $tempErr.length = 0;
                                    }
                                });*@
                            });
                            if ($tempErr.length > 1) {
                                alert('Ada error. Silahkan klik "View Error"');
                            } else if ($tempErr.length == 1) {
                                $("#btn-error").click();
                            } else if ($tempErr.length == 0) {
                                //$("#btn-error-row").hide();
                            }
                        }
                    },
                    error: function (xhr, status, error) {
                        console.log(error);
                        alert(error);
                        //$('#loading_upload').hide();
                    }
                });
            }
        }

        function showError($nobuk, $logFile) {
                                //if ($('#Piutang_BUKTI').val() != "") {
            var link = '@Url.Action("ShowErrorUploadBayar", "Manage")';
            var $bukti = "";
            var $log = "";
            
            if ($nobuk != undefined && $logFile != undefined && $nobuk != null && $logFile != null && $nobuk != "" && $logFile != "") {
                $bukti = $nobuk;
                $log = $logFile;
            } else {
                if (tempLog == "") {
                    tempLog = logfile;
                }
                $bukti = tempNobuk;
                $log = tempLog;
            }
            $postdata = {
                bukti: $bukti,
                logErr: $log,
            };
                                    $.ajax({
                                        type: "POST",
                                        url: link,
                                        contentType: "application/json; charset=UTF-8",
                                        cache: false,
                                        data: JSON.stringify($postdata),
                                        success: function (value) {
                                            //$('#modalError').find('.edit-content').html(value);
                                            //$('#Modal').modal('show');
                                            $('#error-list').html(value);
                                        },
                                        error: function (xhr, status, error) {
                                            console.log(error);
                                            $tempErr.length = 0;
                                        }
                                    });
                                //}
        }

        function getDetailBayarPiutang() {
            var link = '@Url.Action("GetDetailBayarPiutang", "Manage", new { orderId = "replaceId" })';
            link = link.replace("replaceId", $('#NOBUK_bayar_piutang').val());

            $.ajax({
                type: "GET",
                url: link,
                contentType: 'application/json',
                cache: false,
                success: function (res) {
                    var $jumlahDetail = res;
                    if ($jumlahDetail == 0) {
                        $('input, select').each(function () {
                            $(this).removeAttr('disabled');
                        });
                        $('#NOBUK_bayar_piutang').attr('disabled', 'disabled');
                    } else {
                        $('input, select').each(function () {
                            $(this).attr('disabled', 'disabled');
                        });
                        $('#CUSTOMER')[0].selectize.disable();
                    }
                },
                error: function (xhr, status, error) {
                    console.log(error);
                }
            });
        }

        function createPOT() {
            if ($('tr[data-piutang-id != "0"] .potongan-piutang').length > 0) {
                var totalSelisih = 0;
                var get_rec = [];
                var get_pot = [];
                var get_faktur = [];
                get_rec.length = 0;
                get_pot.length = 0;
                get_faktur.length = 0;
                $('tr[data-piutang-id != "0"] .potongan-piutang').each(function (i, item) {
                    if ($(item).attr("data-selisih") != undefined) {
                        $(item).text(convertToRupiah(convertToAngka($(item).text()) + convertToAngka($(item).attr("data-selisih"))));
                        totalSelisih += convertToAngka($(item).attr("data-selisih"));
                        get_pot.push(convertToAngka($(item).attr("data-selisih")));
                        get_rec.push($(item).attr("data-rec"));
                        get_faktur.push($(item).attr("data-faktur"));
                    }
                });

                if (totalSelisih == 0) {
                    $("#konfCreatePot").modal('hide');
                    alert('Tidak ada kurang bayar.');
                }
                else
                {
                    $('tr[data-piutang-id != "0"] .selisih-piutang').each(function (i, item) {
                        $(item).text(convertToRupiah(0));
                    });
                    $('tr[data-piutang-id != "0"] .persen-selisih').each(function (i, item) {
                        if (($(item).attr("data-persen-lebihbayar") == undefined || convertToAngka($(item).attr("data-persen-lebihbayar")) == 0) && ($(item).attr("data-persen-gagal") != undefined || convertToAngka($(item).attr("data-persen-gagal")) > 0)) {
                            $(item).text("0 %");
                        }
                    });
                    $('#TOTALPOT').val(convertToRupiah(convertToAngka($('#TOTALPOT').val()) + convertToAngka(convertToRupiah(totalSelisih))));
                    $('#TOTALSELISIH').val(convertToRupiah(0));

                    $.ajax({
                        type: "POST",
                        url: '@Url.Action("UpdatePotonganBayarPiutang", "Manage")',
                        data: JSON.stringify({
                            OrderId: $('#NOBUK_bayar_piutang').val(),
                            Tgl: $('#Piutang_TGL').val(),
                            Cust: $('#Piutang_CUST').val(),
                            TotalFaktur: convertToAngka($('#TOTALBYR').val()),
                            TotalBayar: convertToAngka($('#TOTALREF').val()),
                            TotalPotongan: convertToAngka($('#TOTALPOT').val()),
                            //TotalLebih: convertToAngka($('#TOTALLEBIH').val()),
                            getRec: get_rec,
                            getPot: get_pot,
                            getFaktur: get_faktur
                        }),
                        contentType: 'application/json; charset=UTF-8',
                        cache: false,
                        beforeSend: function () {
                            $('#loading_spinner').show();
                        },
                        success: function (data) {
                            if (data != null) {
                                if (data.mo_error == null) {
                                    //if (data.Errors == undefined) {

                                    $('#loading_spinner').hide();
                                    $("#konfCreatePot").modal('hide');
                                    alert('Nilai potongan berhasil dibuat');
                                    getFaktur($("#Piutang_CUST").val());
                                    $('#btn-autoload').click(function () {
                                        $('#file_upload_excel').removeAttr('disabled');
                                    });
                                } else {
                                    $('tr[data-piutang-id != "0"] .selisih-piutang').each(function (i, item) {
                                        if ($(item).attr("data-selisih-gagal") != undefined) {
                                            $(item).text(convertToRupiah(convertToAngka($(item).text()) + convertToAngka($(item).attr("data-selisih-gagal"))));
                                        }
                                    });
                                    $('tr[data-piutang-id != "0"] .potongan-piutang').each(function (i, item) {
                                        $(item).text(convertToRupiah(0));
                                    });
                                    $('tr[data-piutang-id != "0"] .persen-selisih').each(function (i, item) {
                                        if ($(item).attr("data-persen-gagal") != undefined) {
                                            if ($(item).attr("data-persen-lebihbayar") == undefined || convertToAngka($(item).attr("data-persen-lebihbayar")) == 0) {
                                                $(item).text($(item).attr("data-persen-gagal") + " %");
                                            } else if ($(item).attr("data-persen-lebihbayar") != undefined) {
                                                $(item).text($(item).attr("data-persen-lebihbayar") + " %");
                                            }
                                        } else {
                                            if ($(item).attr("data-persen-lebihbayar") == undefined || convertToAngka($(item).attr("data-persen-lebihbayar")) == 0) {
                                                $(item).text($(item).attr("data-persen-gagal") + " %");
                                            } else if ($(item).attr("data-persen-lebihbayar") != undefined) {
                                                $(item).text($(item).attr("data-persen-lebihbayar") + " %");
                                            }
                                        }
                                    });
                                    $('#TOTALPOT').val(convertToRupiah(0));
                                    $('#TOTALSELISIH').val(convertToRupiah(convertToAngka($('#TOTALPOT').val()) + convertToAngka(convertToRupiah(totalSelisih))));
                                    alert(data.mo_error);
                                    $('#loading_spinner').hide();
                                }
                            }
                        },
                        error: function (xhr, status, error) {
                            $('tr[data-piutang-id != "0"] .selisih-piutang').each(function (i, item) {
                                if ($(item).attr("data-selisih-gagal") != undefined) {
                                    $(item).text(convertToRupiah(convertToAngka($(item).text()) + convertToAngka($(item).attr("data-selisih-gagal"))));
                                }
                            });
                            $('tr[data-piutang-id != "0"] .potongan-piutang').each(function (i, item) {
                                $(item).text(convertToRupiah(0));
                            });
                            $('tr[data-piutang-id != "0"] .persen-selisih').each(function (i, item) {
                                //if ($(item).attr("data-persen-gagal") != undefined) {
                                //    $(item).text($(item).attr("data-persen-gagal") + " %");
                                //}
                                if ($(item).attr("data-persen-gagal") != undefined) {
                                    if ($(item).attr("data-persen-lebihbayar") == undefined || convertToAngka($(item).attr("data-persen-lebihbayar")) == 0) {
                                        $(item).text($(item).attr("data-persen-gagal") + " %");
                                    } else if ($(item).attr("data-persen-lebihbayar") != undefined) {
                                        $(item).text($(item).attr("data-persen-lebihbayar") + " %");
                                    }
                                } else {
                                    if ($(item).attr("data-persen-lebihbayar") == undefined || convertToAngka($(item).attr("data-persen-lebihbayar")) == 0) {
                                        $(item).text($(item).attr("data-persen-gagal") + " %");
                                    } else if ($(item).attr("data-persen-lebihbayar") != undefined) {
                                        $(item).text($(item).attr("data-persen-lebihbayar") + " %");
                                    }
                                }
                            });
                            $('#TOTALPOT').val(convertToRupiah(0));
                            $('#TOTALSELISIH').val(convertToRupiah(convertToAngka($('#TOTALPOT').val()) + convertToAngka(convertToRupiah(totalSelisih))));
                            alert('Ada error. Mohon ulangi proses!');
                            $('#loading_spinner').hide();
                            $("#konfCreatePot").modal('hide');
                            console.log(error);
                        }
                    });
                    //end proses simpan
                }
            } else {
                $("#konfCreatePot").modal('hide');
                alert('Tidak ada detail pembayaran');
            }
        }

        function ViewLog() {
            var link = '@Url.Action("ListLogBayarPiutang", "Manage")';
            link += '?cust=' + encodeURIComponent($("#Piutang_CUST").val());
            $.ajax({
                type: "GET",
                url: link,
                beforeSend: function() {
                    //$('#loading_upload').show();
                },
                success: function (response) {
                    $('#uploadbrgviewdiv').html(response);
                    //$('#loading_upload').hide();
                },
                error: function(xhr, status, error) {
                    console.log(error);
                    //$('#loading_upload').hide();
                }
            });
        }

        function downloadLogUploadPiutang(txt){
            window.open('/Manage/DownloadLogUploadFaktur?filename=' + txt,'_blank');

        }

        function viewError(err) {

        }
        //end add by nurul 21/10/2019
    </script>

    <script>
        //Disable Enter Key Submit Form
        function stopRKey(evt) {
            var evt = (evt) ? evt : ((event) ? event : null);
            var node = (evt.target) ? evt.target : ((evt.srcElement) ? evt.srcElement : null);
            if ((evt.keyCode === 13) && (node.type === "text")) { return false; }
        }
        document.onkeypress = stopRKey;
    </script>
}