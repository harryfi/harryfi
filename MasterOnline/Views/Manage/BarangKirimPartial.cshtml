@using System.Globalization
@using MasterOnline.ViewModels
@model PengirimanViewModel
@{
    var context = new MoDbContext("");
    //var dataSession = Session["SessionInfo"] as AccountUserViewModel;

    var username = "";
    //if (dataSession?.User != null)
    //{
    //    var accId = context.User.Single(u => u.Email == dataSession.User.Email).AccountId;
    //    username = context.Account.Single(a => a.AccountId == accId).Username;
    //    context.Dispose();
    //}
    //else
    //{
    //    username = dataSession?.Account?.Username;
    //}

    var sessionAccount = HttpContext.Current.Session["SessionAccount"];
    var sessionAccountUserID = HttpContext.Current.Session["SessionAccountUserID"];
    var sessionAccountUserName = HttpContext.Current.Session["SessionAccountUserName"];
    var sessionAccountEmail = HttpContext.Current.Session["SessionAccountEmail"];
    var sessionAccountTglSub = HttpContext.Current.Session["SessionAccountTglSub"];
    var sessionAccountKodeSub = HttpContext.Current.Session["SessionAccountKodeSub"];
    var sessionAccountDataSourcePathDebug = HttpContext.Current.Session["SessionAccountDataSourcePathDebug"];
    var sessionAccountDataSourcePath = HttpContext.Current.Session["SessionAccountDataSourcePath"];
    var sessionAccountDatabasePathErasoft = HttpContext.Current.Session["SessionAccountDatabasePathErasoft"];

    var sessionUser = System.Web.HttpContext.Current.Session["SessionUser"];
    var sessionUserUserID = System.Web.HttpContext.Current.Session["SessionUserUserID"];
    var sessionUserUsername = System.Web.HttpContext.Current.Session["SessionUserUsername"];
    var sessionUserEmail = System.Web.HttpContext.Current.Session["SessionUserEmail"];
    var sessionUserAccountID = System.Web.HttpContext.Current.Session["SessionUserAccountID"];

    if (sessionUser != null)
    {
        var accId = context.User.Single(u => u.Email == sessionUserEmail.ToString()).AccountId;
        username = context.Account.Single(a => a.AccountId == accId).Username;
        context.Dispose();
    }
    else
    {
        username = sessionAccountUserName.ToString();
    }

    if (username.Length > 20)
    {
        username = username.Substring(0, 17) + "...";
    }
}

@Html.AntiForgeryToken()
@Html.HiddenFor(m => m.Pengiriman.RECNUM)
<script type="text/javascript">
    $(document).ready(function () {
        Initialize();
    });
</script>
<div class="form-horizontal">
    <div class="row">
        @*<div class="col-md-6">*@
        <div class="form-group text-left">
            @Html.LabelFor(m => m.Pengiriman.NO_BUKTI, "No. Bukti", new { @class = "col-md-3 col-sm-3 col-xs-12 control-label" })
            <div class="col-md-6 col-sm-6 col-xs-12">
                @Html.HiddenFor(m => m.Pengiriman.NO_BUKTI)
                @if (Model.Pengiriman != null)
                {
                    <input id="NOBUK_KIRIM" type="text" value="@Model.Pengiriman.NO_BUKTI" disabled class="form-control" />
                }
                else
                {
                    <input type="text" value="[AUTO]" disabled class="form-control" />
                }
            </div>
            @*</div>*@
        </div>
    </div>
    <div class="row">
        @*<div class="col-md-6">*@
        <div class="form-group text-left">
            @Html.LabelFor(m => m.Pengiriman.TGL_KIRIM, "Tanggal Serah Terima", new { @class = "col-md-3 col-sm-3 col-xs-12 control-label" })
            <div class="col-md-6 col-sm-6 col-xs-12">
                <div class="input-group date">
                    @Html.TextBoxFor(m => m.Pengiriman.TGL_KIRIM, new { @class = "form-control", Value = Model?.Pengiriman?.TGL_KIRIM?.ToString("dd/MM/yyyy") })
                    <span class="input-group-addon">
                        <span class="glyphicon glyphicon-calendar"></span>
                    </span>
                </div>
            </div>
        </div>
        @*</div>
            <div class="col-md-6">
                <div class="form-group text-right">
                </div>
            </div>*@
    </div>
    <div class="row">
        <div class="form-group text-left">
            @Html.LabelFor(m => m.Pengiriman.NAMA_EKSPEDISI, "Kurir", new { @class = "col-md-3 col-sm-3 col-xs-12 control-label" })
            <div class="col-md-6 col-sm-6 col-xs-12" id="divShipment">
                @*@Html.HiddenFor(m => m.Pengiriman.NAMAPENGIRIM)
                    @Html.HiddenFor(m => m.Pengiriman.EXPEDISI)*@
                @*@Html.HiddenFor(m => m.Pengiriman.KURIR)*@
                @Html.HiddenFor(m => m.Pengiriman.NAMA_EKSPEDISI)
                <select id="EXPEDISI" placeholder="Harap Pilih" required="required"></select>
            </div>
        </div>
    </div>
    @*<div class="row">
        <div class="form-group text-left">
            @Html.LabelFor(m => m.Pengiriman.NAMA_KURIR, "Nama Kurir", new { @class = "col-md-3 col-sm-3 col-xs-12 control-label" })
            <div class="col-md-6 col-sm-6 col-xs-12" id="divShipment">
                @Html.TextBoxFor(m => m.Pengiriman.NAMA_KURIR, new { @class = "form-control", @maxlength = "50" })
            </div>
        </div>
    </div>*@
    <div class="row">
        <div class="form-group text-left">
            @Html.LabelFor(m => m.Pengiriman.JAM_KIRIM, "Jam Serah Terima", new { @class = "col-md-3 col-sm-3 col-xs-12 control-label" })
            <div class="col-md-6 col-sm-6 col-xs-12  ">
                <div class="input-group bootstrap-timepicker timepicker">
                    @Html.TextBoxFor(m => m.Pengiriman.JAM_KIRIM, new { @class = "form-control input-small bootstrap-timepicker timepicker", @id = "timepicker1", @Value = Model?.Pengiriman?.JAM_KIRIM?.ToString("HH:mm"), @style = "width:80px;" })
                    @*<input id="timepicker1" type="text" class="form-control input-small">*@
                    @*<span class="input-group-addon"><i class="glyphicon glyphicon-time"></i></span>*@
                </div>
            </div>
        </div>
    </div>

    @*//add btn autoload*@
    @*<div id="btn-autoload-row" class="row">
        <div class="col-lg-4"></div>
        <div class="col-lg-4"></div>
        <div class="col-lg-4">
            <div class="form-group">
                <div class="col-md-4"></div>
                <div class="col-md-8">
                    <button id="btn-autoload" type="button" onclick="validasiAutoload()" class="btn btn-primary btn-block">Autoload</button>
                </div>
            </div>
        </div>
    </div>*@
    <div id="btn-print-row" class="row">
        <div class="col-lg-4"></div>
        <div class="col-lg-4"></div>
        <div class="col-lg-4">
            <div class="form-group">
                <div class="col-md-4"></div>
                <div class="col-md-8">
                    <button id="btn btn-primary btn-block cetak" type="button" onclick="validasiCetak('@(Model?.Pengiriman?.RECNUM)')" class="btn btn-primary btn-block">
                        Print <span class="glyphicon glyphicon-print" aria-hidden="true"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    @*//end add btn autoload*@

    @if (Model?.Pengiriman?.RECNUM != null)
    {
        <div id="btn-simpan-perubahan-row" class="row" style="display: none;">
            <div class="col-lg-4"></div>
            <div class="col-lg-4"></div>
            <div class="col-lg-4">
                <div class="form-group">
                    <div class="col-md-4"></div>
                    <div class="col-md-8">
                        <button id="btn-simpan-perubahan" type="button" class="btn btn-success btn-block">Simpan Perubahan</button>
                    </div>
                </div>
            </div>
        </div>
    }
    <hr />
</div>
@Html.HiddenFor(m => m.PengirimanDetail.USERNAME, new { Value = username })
@Html.HiddenFor(m => m.PengirimanDetail.TGL_INPUT, new { Value = DateTime.Now.ToString("dd/MM/yyyy") })

<div class="row" style="margin-top: 15px;">
    <div class="col-lg-12">
        <table id="table_tambah_kirim" class="table table-bordered" role="grid">
            <thead>
                <tr>
                    <th>No. Pesanan</th>
                    <th>No. Referensi</th>
                    <th>Marketplace</th>
                    <th>Pembeli</th>
                    <th>No. Resi</th>
                    <th>Kurir</th>
                    <th width="30">Simpan</th>
                    <th width="30">Hapus</th>
                </tr>
            </thead>
            <tbody>
                @*@foreach (var kirim in Model.ListPengirimanDetail.Where(pb => pb.NO_BUKTI == Model?.Pengiriman?.NO_BUKTI).ToList())
        {
            <tr data-barang-id="detail-@kirim.NO_URUT">
                @{
                    var kurirDetail = Model?.Shipment?.SingleOrDefault(a => a.NO_BUKTI == kirim.PESANAN).SHIPMENT;
                }
                <td>
                    @kirim.PESANAN
                </td>
                <td class="mp-detail">
                    @kirim.NAMA_MARKET
                </td>
                <td class="buyer-detail">
                    @kirim.NAMA_PEMBELI
                </td>
                <td class="al-detail">
                    @kirim.ALAMAT_KIRIM @kirim.KOTA @kirim.PROPINSI @kirim.KODE_POS
                </td>
                <td class="kurir-detail">
                    @kurirDetail
                </td>
                <td class="edit-hapus-col">
                    <button type="button" class="btn btn-primary" disabled="disabled">
                        <span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span>
                    </button>
                </td>
                <td class="edit-hapus-col">
                    <button class="btn btn-danger" type="button" data-toggle="modal" data-target="#konfHapusDetail" onclick="passBarangInDb('@kirim.NO_URUT')">
                        <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
                    </button>
                </td>
            </tr>
        }*@
                @foreach (var kirim in Model.CetakSerahTerima.Where(pb => pb.NO_BUKTI == Model?.Pengiriman?.NO_BUKTI).ToList())
                {
                    <tr data-barang-id="detail-@kirim.NO_URUT">
                        @*@{
                            var kurirDetail = Model?.Shipment?.SingleOrDefault(a => a.NO_BUKTI == kirim.PESANAN).SHIPMENT;
                        }*@
                        <td>
                            @kirim.PESANAN
                        </td>
                        <td class="noref-detail">@kirim.NOREF</td>
                        <td class="mp-detail">
                            @kirim.MARKETPLACE
                        </td>
                        <td class="buyer-detail">
                            @kirim.PEMBELI
                        </td>
                        <td class="resi-detail">
                            @kirim.RESI
                        </td>
                        <td class="kurir-detail">
                            @kirim.KURIR
                        </td>
                        <td class="edit-hapus-col">
                            <button type="button" class="btn btn-primary" disabled="disabled">
                                <span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span>
                            </button>
                        </td>
                        <td class="edit-hapus-col">
                            <button class="btn btn-danger" type="button" data-toggle="modal" data-target="#konfHapusDetail" onclick="passBarangInDb('@kirim.NO_URUT')">
                                <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
                            </button>
                        </td>
                    </tr>
                }
                    <tr data-kirim-id="0">
                        @Html.HiddenFor(m => m.PengirimanDetail.NO_URUT)
                        @Html.HiddenFor(m => m.PengirimanDetail.MARKETPLACE)
                        @Html.HiddenFor(m => m.PengirimanDetail.PEMBELI)
                        @Html.HiddenFor(m => m.PengirimanDetail.KOTA)
                        @Html.HiddenFor(m => m.PengirimanDetail.PROPINSI)
                        @Html.HiddenFor(m => m.PengirimanDetail.KODE_POS)
                        @Html.HiddenFor(m => m.PengirimanDetail.ALAMAT_KIRIM)
                        <td style="width: 130px; max-width: 130px;">
                            <div id="PESANAN" class="selectivity-input" tabindex="0"></div>
                            @Html.HiddenFor(m => m.PengirimanDetail.PESANAN)
                        </td>
                        <td class="noref-detail">
                            -
                            @*@kirim.NOREF*@
                        </td>
                        <td class="mp-detail">
                            -
                            @Html.HiddenFor(m => m.PengirimanDetail.NAMA_MARKET)

                        </td>
                        <td class="buyer-detail">
                            -
                            @Html.HiddenFor(m => m.PengirimanDetail.NAMA_PEMBELI)

                        </td>
                        <td class="resi-detail">
                            -
                            @*@Html.HiddenFor(m => m.PengirimanDetail.ALAMAT_KIRIM)*@

                        </td>
                        <td class="kurir-detail">
                            -
                        </td>
                        <td class="edit-hapus-col">
                            <button type="button" class="btn btn-primary" disabled="disabled" onclick="simpandetail('detail-0')">
                                <span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span>
                            </button>
                        </td>
                        <td class="edit-hapus-col">
                            <button class="btn btn-danger" disabled="disabled" data-toggle="modal" data-target="#konfHapusDetail">
                                <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
                            </button>
                        </td>
                    </tr>
            </tbody>
        </table>
    </div>
</div>
